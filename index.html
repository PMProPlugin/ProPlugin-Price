<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Tag Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .bg-dark { background-color: #1a1a1a; }
        .bg-secondary { background-color: #2d2d2d; }
        .border-secondary { border-color: #444444; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: #2d2d2d;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 1200px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
        .price-tag {
            background-color: white;
            color: black;
            border: 5px solid black;
            padding: 15px;
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
        }
        .price-tag-a4 { width: 210mm; height: 297mm; }
        .price-tag-a5 { width: 148mm; height: 210mm; }
        .price-tag-a6 { width: 105mm; height: 148mm; }
        .price-tag-acc { width: 105mm; height: 49mm; }

        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .price-tag-container {
                page-break-inside: avoid;
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-dark">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-secondary p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center mb-6 text-white">จัดการป้ายราคา</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-300 mb-2">ชื่อผู้ใช้</label>
                    <input type="text" id="username" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-red-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-300 mb-2">รหัสผ่าน</label>
                    <input type="password" id="password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-red-500" required>
                </div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">เข้าสู่ระบบ</button>
                <p id="login-error" class="text-red-500 text-center mt-4"></p>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <!-- App Header -->
        <header class="bg-secondary p-4 flex justify-between items-center shadow-md">
            <h1 class="text-2xl font-bold text-white">Price Tag Management</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-gray-300"></span>
                <button id="admin-panel-btn" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">แผงควบคุม</button>
                <button id="logout-btn" class="btn-danger font-bold py-2 px-4 rounded-lg">ออกจากระบบ</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 md:p-8">
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-secondary rounded-lg">
                <div>
                    <label for="search-input" class="block text-gray-300 mb-2">ค้นหา (SKU / ชื่อสินค้า)</label>
                    <input type="text" id="search-input" placeholder="ค้นหา..." class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                </div>
                <div>
                    <label for="date-filter" class="block text-gray-300 mb-2">กรองตามวันหมดอายุ</label>
                    <input type="date" id="date-filter" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                </div>
                <div>
                    <label for="channel-selector" class="block text-gray-300 mb-2">ช่องทางการขาย</label>
                    <select id="channel-selector" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"></select>
                </div>
                <div>
                    <label for="template-selector" class="block text-gray-300 mb-2">เลือกเทมเพลต</label>
                    <select id="template-selector" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                        <option value="A4">A4</option>
                        <option value="A5">A5</option>
                        <option value="A6" selected>A6</option>
                        <option value="Accessories Tag">Accessories Tag</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mb-4">
                <button id="preview-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ดูตัวอย่าง / พิมพ์</button>
            </div>

            <!-- SKU Table -->
            <div class="bg-secondary rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead id="table-header" class="bg-gray-700 text-gray-300 uppercase text-sm">
                            <!-- Headers will be dynamically generated here -->
                        </thead>
                        <tbody id="sku-table-body">
                            <!-- Rows will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="mt-6 flex justify-center items-center space-x-2"></div>
        </main>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-modal-btn">&times;</span>
            <h2 class="text-2xl font-bold mb-4">ตัวอย่างป้ายราคา</h2>
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-4">
                    <button id="prev-sku-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">&lt; ก่อนหน้า</button>
                    <span id="sku-counter" class="text-white"></span>
                    <button id="next-sku-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ถัดไป &gt;</button>
                </div>
                 <div id="dealer-tier-selector-container" class="hidden">
                    <label for="dealer-tier-selector" class="text-gray-300 mr-2">ระดับ Dealer:</label>
                    <select id="dealer-tier-selector" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1"></select>
                </div>
                <div>
                    <button id="print-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">พิมพ์ทั้งหมด</button>
                    <button id="export-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ส่งออกเป็น PDF</button>
                </div>
            </div>
            <div id="tag-preview-area" class="flex justify-center items-center p-4 bg-gray-800 rounded-lg min-h-[400px]">
                <!-- Price tag preview will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-admin-modal-btn">&times;</span>
            <h2 class="text-2xl font-bold mb-4">แผงควบคุมผู้ดูแลระบบ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Data Management -->
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3">จัดการข้อมูล</h3>
                    <div class="space-y-3">
                        <p class="text-gray-400">นำเข้าข้อมูลสินค้าจากไฟล์ Excel (.xlsx)</p>
                        <input type="file" id="import-excel" accept=".xlsx" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                        <button id="export-excel-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">ส่งออกข้อมูลเป็น Excel</button>
                    </div>
                </div>
                <!-- Logo Management -->
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3">จัดการโลโก้</h3>
                     <img id="logo-preview" src="" class="max-h-20 mb-2 bg-white p-1 rounded">
                    <input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                </div>
                <!-- Dealer Settings (Admin/Host) -->
                <div id="dealer-settings" class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3">ตั้งค่า Dealer</h3>
                    <div class="space-y-2">
                        <div>
                            <label class="text-gray-400">ชื่อ Tier 1:</label>
                            <input type="text" id="tier1-name" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg">
                        </div>
                         <div>
                            <label class="text-gray-400">ชื่อ Tier 2:</label>
                            <input type="text" id="tier2-name" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg">
                        </div>
                         <div>
                            <label class="text-gray-400">ชื่อ Tier 3:</label>
                            <input type="text" id="tier3-name" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg">
                        </div>
                         <div>
                            <label class="text-gray-400">Tier เริ่มต้นสำหรับแสดงผล:</label>
                            <select id="default-tier-selector" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg"></select>
                        </div>
                        <button id="save-dealer-settings-btn" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">บันทึกการตั้งค่า</button>
                    </div>
                </div>
                <!-- Log Viewer -->
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3">ประวัติการใช้งาน</h3>
                    <textarea id="log-viewer" readonly class="w-full h-40 bg-gray-900 text-gray-300 p-2 rounded-lg text-xs"></textarea>
                    <button id="export-log-btn" class="mt-3 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ส่งออกประวัติ (CSV)</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Print Area -->
    <div id="print-area" class="hidden"></div>


    <!-- README in comments -->
    <!--
    ==================================================================
    README: Price Tag Management Application
    ==================================================================

    This is a client-side web application for internal price tag management.
    It runs entirely in the browser and uses localStorage for persistence.

    ------------------------------------------------------------------
    1. How to Replace Excel Data and Map Columns
    ------------------------------------------------------------------

    The application loads product data from an Excel file (.xlsx).

    A. Data Loading:
       - On first load, the app looks for 'price_data' in localStorage.
       - If not found, it attempts to fetch a `sample_data.json` file (you should place this file in the same directory as index.html).
       - To load your own data, use the Admin Panel:
         1. Log in as 'host1' or 'admin1'.
         2. Click 'แผงควบคุม' (Admin Panel).
         3. Under 'จัดการข้อมูล' (Data Management), click the file input to select your .xlsx file.
       - The data will be parsed and saved to localStorage.

    B. Excel Column Mapping:
       The application expects specific column headers in your Excel file.
       The headers are case-insensitive and can be in Thai or English.

       Required Mappings:
       - SKU: 'Item No.' or 'sku'
       - Description: 'Description' or 'description'
       - Details: 'Details' or 'details' (use newline for bullets)
       - Normal Price: 'Normal Price' or 'normal_price'
       - Promotion Price: 'Promotion Price' or 'promo_price'
       - Expire Date: 'Expire Date' or 'expire_date' (format DD-MM-YYYY)
       
       Channel Specific Prices:
       - Flagship: 'Flagship Price' or 'flagship_price'
       - Marketplace: 'Marketplace Price' or 'marketplace_price'
       - Marketplace GP%: 'GP%' (in the Marketplace section) or 'market_gp'

       Dealer Tiers (MUST be present for Dealer channel):
       - Tier 1 Price: 'Dealer Price T1' or 'dealer_price_t1' or '1-20 Units'
       - Tier 1 GP%: 'Dealer GP% T1' or 'dealer_gp_t1' or 'GP %' (first dealer GP column)
       - Tier 2 Price: 'Dealer Price T2' or 'dealer_price_t2' or '21-30 Units'
       - Tier 2 GP%: 'Dealer GP% T2' or 'dealer_gp_t2' or 'GP %' (second dealer GP column)
       - Tier 3 Price: 'Dealer Price T3' or 'dealer_price_t3' or '31 Units Up'
       - Tier 3 GP%: 'Dealer GP% T3' or 'dealer_gp_t3' or 'GP %' (third dealer GP column)

       *Note*: If a channel-specific price is blank, the app uses a fallback:
       - Flagship: `promo_price` if available, otherwise `normal_price`.
       - Other channels: `normal_price`.

    ------------------------------------------------------------------
    2. How to Deploy to GitHub Pages / Vercel
    ------------------------------------------------------------------

    This application is a single `index.html` file with no backend, making deployment very simple.

    A. GitHub Pages:
       1. Create a new repository on GitHub.
       2. Upload this `index.html` file to the repository.
       3. (Optional but recommended) Create a `sample_data.json` with your initial product data and upload it too.
       4. In your repository settings, go to the 'Pages' section.
       5. Under 'Build and deployment', select 'Deploy from a branch'.
       6. Choose the main branch and `/ (root)` folder, then click 'Save'.
       7. Your site will be live at `https://<your-username>.github.io/<your-repo-name>/` in a few minutes.

    B. Vercel:
       1. Sign up for a Vercel account (a free hobby plan is sufficient).
       2. Connect your GitHub account to Vercel.
       3. Click 'Add New...' -> 'Project'.
       4. Import the GitHub repository you created.
       5. Vercel will automatically detect it as a static site. No framework preset is needed.
       6. Click 'Deploy'. Your site will be live at a Vercel-provided URL.

    ------------------------------------------------------------------
    3. Demo Credentials
    ------------------------------------------------------------------

    Username / Password -> Role (Visible Channels)

    - host1 / host123    -> Host (Full Access: Flagship, Dealer, Marketplace. Can manage users).
    - admin1 / admin123  -> Admin (Admin Access: Flagship, Dealer, Marketplace. No user management).
    - user1 / u1pass     -> User1 (Flagship only).
    - user2 / u2pass     -> User2 (Flagship only).
    - user3 / u3pass     -> User3 (Dealer only, sees all 3 tiers + GP%).
    - user4 / u4pass     -> User4 (Marketplace only, sees GP%).

    ==================================================================
    -->

    <script>
        // The entire application logic will be placed here.
        document.addEventListener('DOMContentLoaded', () => {
            // --- App State ---
            let allSkus = [];
            let filteredSkus = [];
            let currentUser = null;
            let currentPage = 1;
            const skusPerPage = 20;
            let companyLogo = localStorage.getItem('companyLogo') || 'https://placehold.co/200x60/ffffff/000000?text=ProPlugin';
            let dealerSettings = JSON.parse(localStorage.getItem('dealerSettings')) || {
                tier1Name: 'Dealer Tier 1',
                tier2Name: 'Dealer Tier 2',
                tier3Name: 'Dealer Tier 3',
                defaultTier: 'dealer_price_t1'
            };

            // --- UI Elements ---
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const userInfo = document.getElementById('user-info');
            const logoutBtn = document.getElementById('logout-btn');
            const adminPanelBtn = document.getElementById('admin-panel-btn');
            const searchInput = document.getElementById('search-input');
            const dateFilter = document.getElementById('date-filter');
            const channelSelector = document.getElementById('channel-selector');
            const skuTableBody = document.getElementById('sku-table-body');
            const tableHeader = document.getElementById('table-header');
            const paginationContainer = document.getElementById('pagination');
            
            // Modals
            const previewModal = document.getElementById('preview-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const adminModal = document.getElementById('admin-modal');
            const closeAdminModalBtn = document.getElementById('close-admin-modal-btn');

            // Preview Modal Elements
            const previewBtn = document.getElementById('preview-btn');
            const prevSkuBtn = document.getElementById('prev-sku-btn');
            const nextSkuBtn = document.getElementById('next-sku-btn');
            const skuCounter = document.getElementById('sku-counter');
            const tagPreviewArea = document.getElementById('tag-preview-area');
            const printBtn = document.getElementById('print-btn');
            const dealerTierSelectorContainer = document.getElementById('dealer-tier-selector-container');
            const dealerTierSelector = document.getElementById('dealer-tier-selector');
            
            // Admin Panel Elements
            const importExcelInput = document.getElementById('import-excel');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const logoUpload = document.getElementById('logo-upload');
            const logoPreview = document.getElementById('logo-preview');
            const tier1NameInput = document.getElementById('tier1-name');
            const tier2NameInput = document.getElementById('tier2-name');
            const tier3NameInput = document.getElementById('tier3-name');
            const defaultTierSelector = document.getElementById('default-tier-selector');
            const saveDealerSettingsBtn = document.getElementById('save-dealer-settings-btn');
            const logViewer = document.getElementById('log-viewer');
            const exportLogBtn = document.getElementById('export-log-btn');

            // --- Hardcoded Users & Roles ---
            const users = {
                host1: { password: 'host123', role: 'Host', channels: ['Flagship', 'Dealer', 'Marketplace'] },
                admin1: { password: 'admin123', role: 'Admin', channels: ['Flagship', 'Dealer', 'Marketplace'] },
                user1: { password: 'u1pass', role: 'User1', channels: ['Flagship'] },
                user2: { password: 'u2pass', role: 'User2', channels: ['Flagship'] },
                user3: { password: 'u3pass', role: 'User3', channels: ['Dealer'] },
                user4: { password: 'u4pass', role: 'User4', channels: ['Marketplace'] }
            };

            // --- Initialization ---
            function init() {
                // Check for logged in user
                const sessionUser = JSON.parse(sessionStorage.getItem('currentUser'));
                if (sessionUser) {
                    currentUser = sessionUser;
                    showApp();
                } else {
                    showLogin();
                }

                // Event Listeners
                loginForm.addEventListener('submit', handleLogin);
                logoutBtn.addEventListener('click', handleLogout);
                adminPanelBtn.addEventListener('click', openAdminPanel);
                closeAdminModalBtn.addEventListener('click', () => adminModal.style.display = 'none');
                searchInput.addEventListener('input', applyFilters);
                dateFilter.addEventListener('change', applyFilters);
                channelSelector.addEventListener('change', () => {
                    applyFilters();
                    updateTableHeader();
                });
                previewBtn.addEventListener('click', openPreviewModal);
                closeModalBtn.addEventListener('click', () => previewModal.style.display = 'none');
                
                // Admin Panel Listeners
                importExcelInput.addEventListener('change', handleExcelImport);
                exportExcelBtn.addEventListener('click', handleExcelExport);
                logoUpload.addEventListener('change', handleLogoUpload);
                saveDealerSettingsBtn.addEventListener('click', saveDealerSettings);
                exportLogBtn.addEventListener('click', exportLogs);
            }

            // --- Authentication & UI Switching ---
            function handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const user = users[username];

                if (user && user.password === password) {
                    currentUser = { username, ...user };
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    logAction('Login');
                    showApp();
                } else {
                    loginError.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
                }
            }

            function handleLogout() {
                logAction('Logout');
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                showLogin();
            }

            function showLogin() {
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }

            async function showApp() {
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                userInfo.textContent = `ผู้ใช้: ${currentUser.username} (${currentUser.role})`;

                if (['Host', 'Admin'].includes(currentUser.role)) {
                    adminPanelBtn.classList.remove('hidden');
                }

                setupChannelSelector();
                await loadData();
                updateTableHeader();
                applyFilters();
            }

            // --- Data Handling ---
            async function loadData() {
                const localData = localStorage.getItem('price_data');
                if (localData) {
                    allSkus = JSON.parse(localData);
                } else {
                    try {
                        const response = await fetch('sample_data.json');
                        if (!response.ok) throw new Error('sample_data.json not found');
                        const data = await response.json();
                        allSkus = data;
                        localStorage.setItem('price_data', JSON.stringify(allSkus));
                        logAction('Loaded sample_data.json');
                    } catch (error) {
                        console.error('Error loading initial data:', error);
                        allSkus = [];
                    }
                }
            }

            function handleExcelImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
                    
                    const mappedData = mapExcelData(jsonData);
                    allSkus = mappedData;
                    localStorage.setItem('price_data', JSON.stringify(allSkus));
                    logAction(`Imported ${file.name}`);
                    alert('นำเข้าข้อมูลสำเร็จ!');
                    applyFilters();
                };
                reader.readAsArrayBuffer(file);
            }
            
            function mapExcelData(data) {
                // This function maps potentially different Excel column names to our standard keys
                return data.map(row => {
                    const getVal = (keys) => {
                        for (const key of keys) {
                            if (row[key] !== undefined) return row[key];
                        }
                        return null;
                    };
                    
                    const dealerPrices = Object.keys(row).filter(k => k.toLowerCase().includes('units') || k.toLowerCase().includes('dealer price'));
                    const dealerGPs = Object.keys(row).filter(k => k.toLowerCase().startsWith('gp %'));

                    return {
                        sku: getVal(['Item No.', 'sku']),
                        description: getVal(['Description', 'description']),
                        details: getVal(['Details', 'details']),
                        normal_price: parseFloat(getVal(['Normal Price', 'normal_price'])) || 0,
                        promo_price: parseFloat(getVal(['Promotion Price', 'promo_price'])) || 0,
                        flagship_price: parseFloat(getVal(['Flagship Price / Website', 'flagship_price'])) || 0,
                        marketplace_price: parseFloat(getVal(['Marketplace Price', 'marketplace_price'])) || 0,
                        market_gp: parseFloat(getVal(['GP%', 'market_gp'])) || 0,
                        expire_date: getVal(['Expire Date', 'expire_date']),
                        dealer_price_t1: parseFloat(getVal([dealerPrices[0], 'dealer_price_t1'])) || 0,
                        dealer_gp_t1: parseFloat(getVal([dealerGPs[0], 'dealer_gp_t1'])) || 0,
                        dealer_price_t2: parseFloat(getVal([dealerPrices[1], 'dealer_price_t2'])) || 0,
                        dealer_gp_t2: parseFloat(getVal([dealerGPs[1], 'dealer_gp_t2'])) || 0,
                        dealer_price_t3: parseFloat(getVal([dealerPrices[2], 'dealer_price_t3'])) || 0,
                        dealer_gp_t3: parseFloat(getVal([dealerGPs[2], 'dealer_gp_t3'])) || 0,
                    };
                });
            }

            function handleExcelExport() {
                const ws = XLSX.utils.json_to_sheet(allSkus);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Products");
                XLSX.writeFile(wb, "price_data_export.xlsx");
                logAction('Exported data to Excel');
            }

            // --- UI Rendering ---
            function setupChannelSelector() {
                channelSelector.innerHTML = '';
                currentUser.channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel;
                    option.textContent = channel;
                    channelSelector.appendChild(option);
                });
                channelSelector.value = currentUser.channels.includes('Flagship') ? 'Flagship' : currentUser.channels[0];
            }

            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedDate = dateFilter.value;
                const selectedChannel = channelSelector.value;

                filteredSkus = allSkus.filter(sku => {
                    const matchesSearch = !searchTerm || 
                        (sku.sku && sku.sku.toLowerCase().includes(searchTerm)) ||
                        (sku.description && sku.description.toLowerCase().includes(searchTerm));

                    const matchesDate = !selectedDate || (sku.expire_date && sku.expire_date.endsWith(selectedDate.split('-').reverse().join('-')));
                    
                    return matchesSearch && matchesDate;
                });
                
                currentPage = 1;
                renderTable();
                renderPagination();
            }

            function updateTableHeader() {
                const selectedChannel = channelSelector.value;
                let headers = `
                    <th class="p-3"><input type="checkbox" id="select-all-checkbox"></th>
                    <th class="p-3">Item No. (SKU)</th>
                    <th class="p-3">Description</th>
                    <th class="p-3">Details</th>
                    <th class="p-3">Normal Price</th>
                `;

                switch (selectedChannel) {
                    case 'Flagship':
                        headers += `<th class="p-3">Flagship Price</th>`;
                        break;
                    case 'Marketplace':
                        headers += `<th class="p-3">Marketplace Price</th><th class="p-3">GP%</th>`;
                        break;
                    case 'Dealer':
                        headers += `
                            <th class="p-3">${dealerSettings.tier1Name}</th><th class="p-3">GP%</th>
                            <th class="p-3">${dealerSettings.tier2Name}</th><th class="p-3">GP%</th>
                            <th class="p-3">${dealerSettings.tier3Name}</th><th class="p-3">GP%</th>
                        `;
                        break;
                }
                headers += `<th class="p-3">Expire Date</th>`;
                tableHeader.innerHTML = `<tr>${headers}</tr>`;
                
                // Add event listener for the new checkbox
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                if(selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', (e) => {
                        document.querySelectorAll('.sku-checkbox').forEach(cb => {
                            cb.checked = e.target.checked;
                        });
                    });
                }
            }

            function renderTable() {
                skuTableBody.innerHTML = '';
                const start = (currentPage - 1) * skusPerPage;
                const end = start + skusPerPage;
                const paginatedSkus = filteredSkus.slice(start, end);
                const selectedChannel = channelSelector.value;

                if (paginatedSkus.length === 0) {
                    skuTableBody.innerHTML = `<tr><td colspan="12" class="text-center p-8 text-gray-400">ไม่พบข้อมูล</td></tr>`;
                    return;
                }

                paginatedSkus.forEach((sku, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-secondary hover:bg-gray-700';
                    
                    let rowContent = `
                        <td class="p-3"><input type="checkbox" class="sku-checkbox" data-sku="${sku.sku}"></td>
                        <td class="p-3">${sku.sku || ''}</td>
                        <td class="p-3">${sku.description || ''}</td>
                        <td class="p-3 text-sm text-gray-400">${(sku.details || '').split('\n').slice(0, 5).join('<br>')}</td>
                        <td class="p-3 text-right">${formatCurrency(sku.normal_price)}</td>
                    `;

                    switch (selectedChannel) {
                        case 'Flagship':
                            const flagshipPrice = sku.flagship_price > 0 ? sku.flagship_price : (sku.promo_price > 0 ? sku.promo_price : sku.normal_price);
                            rowContent += `<td class="p-3 text-right font-bold text-red-400">${formatCurrency(flagshipPrice)}</td>`;
                            break;
                        case 'Marketplace':
                            rowContent += `<td class="p-3 text-right font-bold text-red-400">${formatCurrency(sku.marketplace_price)}</td>`;
                            rowContent += `<td class="p-3 text-right">${formatPercent(sku.market_gp)}</td>`;
                            break;
                        case 'Dealer':
                             rowContent += `
                                <td class="p-3 text-right font-bold text-red-400">${formatCurrency(sku.dealer_price_t1)}</td>
                                <td class="p-3 text-right">${formatPercent(sku.dealer_gp_t1)}</td>
                                <td class="p-3 text-right font-bold text-red-400">${formatCurrency(sku.dealer_price_t2)}</td>
                                <td class="p-3 text-right">${formatPercent(sku.dealer_gp_t2)}</td>
                                <td class="p-3 text-right font-bold text-red-400">${formatCurrency(sku.dealer_price_t3)}</td>
                                <td class="p-3 text-right">${formatPercent(sku.dealer_gp_t3)}</td>
                            `;
                            break;
                    }
                    
                    rowContent += `<td class="p-3">${sku.expire_date || ''}</td>`;
                    row.innerHTML = rowContent;
                    skuTableBody.appendChild(row);
                });
            }

            function renderPagination() {
                paginationContainer.innerHTML = '';
                const pageCount = Math.ceil(filteredSkus.length / skusPerPage);
                if (pageCount <= 1) return;

                for (let i = 1; i <= pageCount; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.className = `px-4 py-2 rounded-lg ${i === currentPage ? 'bg-red-600 text-white' : 'bg-gray-700 text-gray-300'}`;
                    button.addEventListener('click', () => {
                        currentPage = i;
                        renderTable();
                        renderPagination();
                    });
                    paginationContainer.appendChild(button);
                }
            }

            // --- Preview & Print Modal ---
            let selectedForPreview = [];
            let currentPreviewIndex = 0;

            function openPreviewModal() {
                selectedForPreview = Array.from(document.querySelectorAll('.sku-checkbox:checked'))
                    .map(cb => cb.dataset.sku)
                    .map(skuId => filteredSkus.find(s => s.sku === skuId));

                if (selectedForPreview.length === 0) {
                    alert('กรุณาเลือกอย่างน้อยหนึ่งรายการเพื่อดูตัวอย่าง');
                    return;
                }

                currentPreviewIndex = 0;
                setupDealerTierSelector();
                updatePreview();
                previewModal.style.display = 'block';
            }

            function updatePreview() {
                if (selectedForPreview.length === 0) {
                    tagPreviewArea.innerHTML = '<p class="text-gray-400">ไม่มีรายการที่เลือก</p>';
                    skuCounter.textContent = '0 / 0';
                    return;
                }

                skuCounter.textContent = `${currentPreviewIndex + 1} / ${selectedForPreview.length}`;
                const sku = selectedForPreview[currentPreviewIndex];
                const template = document.getElementById('template-selector').value;
                renderPriceTag(tagPreviewArea, sku, template);

                prevSkuBtn.disabled = currentPreviewIndex === 0;
                nextSkuBtn.disabled = currentPreviewIndex === selectedForPreview.length - 1;
            }

            prevSkuBtn.addEventListener('click', () => {
                if (currentPreviewIndex > 0) {
                    currentPreviewIndex--;
                    updatePreview();
                }
            });

            nextSkuBtn.addEventListener('click', () => {
                if (currentPreviewIndex < selectedForPreview.length - 1) {
                    currentPreviewIndex++;
                    updatePreview();
                }
            });

            function renderPriceTag(container, sku, template) {
                const selectedChannel = channelSelector.value;
                let price, normalPrice;

                if (selectedChannel === 'Dealer') {
                    const selectedTier = dealerTierSelector.value;
                    price = sku[selectedTier];
                    normalPrice = sku.normal_price; // Dealer tags might still show normal price
                } else if (selectedChannel === 'Marketplace') {
                    price = sku.marketplace_price;
                    normalPrice = sku.normal_price;
                } else { // Flagship
                    price = sku.promo_price > 0 ? sku.promo_price : sku.normal_price;
                    normalPrice = sku.promo_price > 0 ? sku.normal_price : null;
                }
                
                let tagClass = 'price-tag-a6';
                if (template === 'A4') tagClass = 'price-tag-a4';
                if (template === 'A5') tagClass = 'price-tag-a5';
                if (template === 'Accessories Tag') tagClass = 'price-tag-acc';

                const expireText = sku.expire_date ? `Expire: ${sku.expire_date}` : '';

                container.innerHTML = `
                    <div class="price-tag ${tagClass} flex flex-col justify-between font-sans" style="font-family: 'Prompt', sans-serif;">
                        <!-- Top Section -->
                        <div class="flex justify-between items-start">
                            <img src="${companyLogo}" alt="Company Logo" class="h-12">
                            <span class="text-sm font-semibold">${sku.sku}</span>
                        </div>

                        <!-- Middle Section -->
                        <div class="flex-grow my-4">
                            <h2 class="text-3xl md:text-5xl font-bold">${sku.description}</h2>
                            <ul class="list-disc list-inside mt-4 text-base md:text-lg">
                                ${(sku.details || '').split('\n').map(line => `<li>${line}</li>`).join('')}
                            </ul>
                        </div>

                        <!-- Bottom Section -->
                        <div class="flex justify-between items-end">
                            <span class="text-lg font-medium">${expireText}</span>
                            <div class="text-right">
                                ${normalPrice && price < normalPrice ? `<p class="text-2xl md:text-4xl text-gray-500 line-through">${formatCurrency(normalPrice)}</p>` : ''}
                                <p class="text-5xl md:text-7xl font-bold text-red-600">${formatCurrency(price)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            printBtn.addEventListener('click', () => {
                const template = document.getElementById('template-selector').value;
                const printArea = document.getElementById('print-area');
                printArea.innerHTML = '';
                printArea.classList.remove('hidden');

                let tagsPerPage;
                let layoutClass = '';
                switch(template) {
                    case 'A4': tagsPerPage = 1; break;
                    case 'A5': tagsPerPage = 2; layoutClass = 'grid grid-cols-1'; break;
                    case 'A6': tagsPerPage = 4; layoutClass = 'grid grid-cols-2 grid-rows-2'; break;
                    case 'Accessories Tag': tagsPerPage = 12; layoutClass = 'grid grid-cols-3 grid-rows-4'; break;
                    default: tagsPerPage = 4;
                }

                for (let i = 0; i < selectedForPreview.length; i += tagsPerPage) {
                    const pageChunk = selectedForPreview.slice(i, i + tagsPerPage);
                    const pageContainer = document.createElement('div');
                    pageContainer.className = `w-[210mm] h-[297mm] p-4 box-border price-tag-container ${layoutClass} gap-2`;
                    
                    pageChunk.forEach(sku => {
                        const tagContainer = document.createElement('div');
                        renderPriceTag(tagContainer, sku, template);
                        pageContainer.appendChild(tagContainer.firstElementChild);
                    });
                    printArea.appendChild(pageContainer);
                }

                logAction(`Printed ${selectedForPreview.length} tags with template ${template}`);
                window.print();
                printArea.classList.add('hidden');
                printArea.innerHTML = '';
            });

            // --- Admin Panel Logic ---
            function openAdminPanel() {
                // Load current settings into the panel
                logoPreview.src = companyLogo;
                tier1NameInput.value = dealerSettings.tier1Name;
                tier2NameInput.value = dealerSettings.tier2Name;
                tier3NameInput.value = dealerSettings.tier3Name;
                updateAdminDealerTierSelector();
                defaultTierSelector.value = dealerSettings.defaultTier;
                
                loadLogs();
                adminModal.style.display = 'block';
            }

            function handleLogoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        companyLogo = e.target.result;
                        localStorage.setItem('companyLogo', companyLogo);
                        logoPreview.src = companyLogo;
                        logAction('Updated company logo');
                        alert('อัปเดตโลโก้สำเร็จ');
                    };
                    reader.readAsDataURL(file);
                }
            }

            function saveDealerSettings() {
                dealerSettings = {
                    tier1Name: tier1NameInput.value,
                    tier2Name: tier2NameInput.value,
                    tier3Name: tier3NameInput.value,
                    defaultTier: defaultTierSelector.value
                };
                localStorage.setItem('dealerSettings', JSON.stringify(dealerSettings));
                logAction('Updated dealer settings');
                alert('บันทึกการตั้งค่า Dealer สำเร็จ');
                updateTableHeader(); // Refresh table headers with new names
                updateAdminDealerTierSelector(); // Refresh selector in admin panel
            }
            
            function setupDealerTierSelector() {
                const selectedChannel = channelSelector.value;
                if (selectedChannel === 'Dealer') {
                    dealerTierSelector.innerHTML = `
                        <option value="dealer_price_t1">${dealerSettings.tier1Name}</option>
                        <option value="dealer_price_t2">${dealerSettings.tier2Name}</option>
                        <option value="dealer_price_t3">${dealerSettings.tier3Name}</option>
                    `;
                    dealerTierSelector.value = dealerSettings.defaultTier;
                    dealerTierSelectorContainer.classList.remove('hidden');
                } else {
                    dealerTierSelectorContainer.classList.add('hidden');
                }
            }

            function updateAdminDealerTierSelector() {
                defaultTierSelector.innerHTML = `
                    <option value="dealer_price_t1">${tier1NameInput.value}</option>
                    <option value="dealer_price_t2">${tier2NameInput.value}</option>
                    <option value="dealer_price_t3">${tier3NameInput.value}</option>
                `;
            }

            // --- Logging ---
            function logAction(action) {
                let logs = JSON.parse(localStorage.getItem('app_logs')) || [];
                const timestamp = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
                logs.unshift({
                    user: currentUser.username,
                    action: action,
                    timestamp: timestamp
                });
                if (logs.length > 100) logs.pop(); // Keep logs to a reasonable size
                localStorage.setItem('app_logs', JSON.stringify(logs));
            }

            function loadLogs() {
                const logs = JSON.parse(localStorage.getItem('app_logs')) || [];
                logViewer.value = logs.map(log => `[${log.timestamp}] ${log.user}: ${log.action}`).join('\n');
            }

            function exportLogs() {
                const logs = JSON.parse(localStorage.getItem('app_logs')) || [];
                if (logs.length === 0) {
                    alert('ไม่มีประวัติการใช้งานให้ส่งออก');
                    return;
                }
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "Timestamp,User,Action\n"
                    + logs.map(l => `"${l.timestamp}","${l.user}","${l.action}"`).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "app_logs.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- Utility Functions ---
            function formatCurrency(num) {
                if (isNaN(num) || num === null) return 'N/A';
                return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(num).replace('฿', '') + '.-';
            }
            
            function formatPercent(num) {
                if (isNaN(num) || num === null) return '-';
                return `${(num * 100).toFixed(0)}%`;
            }

            // --- Run Application ---
            init();
        });
    </script>
</body>
</html>
