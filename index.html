<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Tag Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .bg-dark { background-color: #1a1a1a; }
        .bg-secondary { background-color: #2d2d2d; }
        .border-secondary { border-color: #444444; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: #2d2d2d;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 1400px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
        .price-tag {
            background-color: white;
            color: black;
            border: 5px solid black;
            padding: 15px;
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
            font-family: 'Prompt', sans-serif;
        }
        .price-tag-a4 { width: 210mm; height: 297mm; }
        .price-tag-a5 { width: 148mm; height: 210mm; }
        .price-tag-a6 { width: 105mm; height: 148mm; }
        .price-tag-acc { width: 105mm; height: 49.3mm; } /* 1/6 of A4 height */

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none;
            }
            @page {
                size: A4;
                margin: 0;
            }
            .price-tag-container {
                page-break-inside: avoid;
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-dark">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-secondary p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center mb-6 text-white">จัดการป้ายราคา</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-300 mb-2">ชื่อผู้ใช้</label>
                    <input type="text" id="username" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-red-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-300 mb-2">รหัสผ่าน</label>
                    <input type="password" id="password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-red-500" required>
                </div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">เข้าสู่ระบบ</button>
                <p id="login-error" class="text-red-500 text-center mt-4"></p>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <!-- App Header -->
        <header class="bg-secondary p-4 flex justify-between items-center shadow-md">
            <h1 class="text-2xl font-bold text-white">Price Tag Management</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-gray-300"></span>
                <button id="admin-panel-btn" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Settings</button>
                <button id="logout-btn" class="btn-danger font-bold py-2 px-4 rounded-lg">ออกจากระบบ</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 md:p-8">
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-secondary rounded-lg">
                <div class="md:col-span-2">
                    <label for="search-input" class="block text-gray-300 mb-2">ค้นหา (SKU / ชื่อสินค้า)</label>
                    <input type="text" id="search-input" placeholder="ค้นหา..." class="w-full px-4 py-3 text-lg bg-gray-700 border border-gray-600 rounded-lg">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                     <div>
                        <label for="date-filter-start" class="block text-gray-300 mb-2">วันหมดอายุ (เริ่ม)</label>
                        <input type="date" id="date-filter-start" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                     <div>
                        <label for="date-filter-end" class="block text-gray-300 mb-2">วันหมดอายุ (สิ้นสุด)</label>
                        <input type="date" id="date-filter-end" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label for="channel-selector" class="block text-gray-300 mb-2">ช่องทางการขาย</label>
                        <select id="channel-selector" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg"></select>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mb-4 space-x-2">
                <button id="preview-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ดูตัวอย่าง / พิมพ์</button>
                <button id="edit-data-btn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">แก้ไขข้อมูลสินค้า</button>
            </div>

            <!-- SKU Table -->
            <div class="bg-secondary rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead id="table-header" class="bg-gray-700 text-gray-300 uppercase text-sm">
                            <!-- Headers will be dynamically generated here -->
                        </thead>
                        <tbody id="sku-table-body">
                            <!-- Rows will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="mt-6 flex justify-center items-center space-x-2"></div>
        </main>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-modal-btn">&times;</span>
            <h2 class="text-2xl font-bold mb-4">ตัวอย่างป้ายราคา</h2>
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex items-center space-x-4">
                    <button id="prev-sku-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">&lt; ก่อนหน้า</button>
                    <span id="sku-counter" class="text-white"></span>
                    <button id="next-sku-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ถัดไป &gt;</button>
                </div>
                <div class="flex items-center gap-4">
                    <div id="dealer-tier-selector-container" class="hidden">
                        <label for="dealer-tier-selector" class="text-gray-300 mr-2">ระดับ Dealer:</label>
                        <select id="dealer-tier-selector" class="bg-gray-700 border border-gray-600 rounded-lg px-2 py-1"></select>
                    </div>
                    <div>
                        <label for="print-qty-input" class="text-gray-300 mr-2">จำนวนพิมพ์:</label>
                        <input type="number" id="print-qty-input" value="1" min="1" class="w-20 bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-center">
                    </div>
                </div>
                <div>
                    <button id="print-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">เปิดหน้าพิมพ์</button>
                </div>
            </div>
            <div id="tag-preview-area" class="flex flex-col justify-center items-center p-4 bg-gray-800 rounded-lg min-h-[400px]">
                <!-- Price tag preview will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-admin-modal-btn">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Settings</h2>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Navigation -->
                <div class="w-full md:w-1/4">
                    <div id="admin-nav" class="flex flex-col space-y-2">
                        <button data-panel="data-management-panel" class="admin-nav-btn w-full text-left p-3 rounded-lg bg-gray-700 hover:bg-red-600">จัดการข้อมูล</button>
                        <button data-panel="logo-management-panel" class="admin-nav-btn w-full text-left p-3 rounded-lg bg-gray-900 hover:bg-red-600">จัดการโลโก้</button>
                        <button data-panel="dealer-settings-panel" class="admin-nav-btn w-full text-left p-3 rounded-lg bg-gray-900 hover:bg-red-600">ตั้งค่า Dealer</button>
                        <button data-panel="user-management-panel" class="admin-nav-btn w-full text-left p-3 rounded-lg bg-gray-900 hover:bg-red-600">จัดการผู้ใช้งาน</button>
                        <button data-panel="template-management-panel" class="admin-nav-btn w-full text-left p-3 rounded-lg bg-gray-900 hover:bg-red-600">จัดการเทมเพลต</button>
                        <button data-panel="log-viewer-panel" class="admin-nav-btn w-full text-left p-3 rounded-lg bg-gray-900 hover:bg-red-600">ประวัติการใช้งาน</button>
                    </div>
                </div>
                <!-- Content Panels -->
                <div class="w-full md:w-3/4">
                    <!-- Data Management -->
                    <div id="data-management-panel" class="admin-panel bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 border-b border-secondary pb-2">จัดการข้อมูล</h3>
                        <div class="space-y-3 pt-2">
                            <p class="text-gray-400">นำเข้าข้อมูลสินค้าจากไฟล์ Excel (.xlsx)</p>
                            <input type="file" id="import-excel" accept=".xlsx" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                            <button id="export-excel-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">ส่งออกข้อมูลเป็น Excel</button>
                        </div>
                    </div>
                    <!-- Logo Management -->
                    <div id="logo-management-panel" class="admin-panel hidden bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 border-b border-secondary pb-2">จัดการโลโก้</h3>
                        <img id="logo-preview" src="" class="max-h-20 mb-2 bg-white p-1 rounded">
                        <input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                    </div>
                    <!-- Dealer Settings -->
                    <div id="dealer-settings-panel" class="admin-panel hidden bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 border-b border-secondary pb-2">ตั้งค่า Dealer</h3>
                        <div class="space-y-2 pt-2">
                            <div><label class="text-gray-400">ชื่อ Tier 1:</label><input type="text" id="tier1-name" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg"></div>
                            <div><label class="text-gray-400">ชื่อ Tier 2:</label><input type="text" id="tier2-name" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg"></div>
                            <div><label class="text-gray-400">ชื่อ Tier 3:</label><input type="text" id="tier3-name" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg"></div>
                            <div><label class="text-gray-400">Tier เริ่มต้นสำหรับแสดงผล:</label><select id="default-tier-selector" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg"></select></div>
                            <button id="save-dealer-settings-btn" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">บันทึกการตั้งค่า</button>
                        </div>
                    </div>
                    <!-- User Management -->
                    <div id="user-management-panel" class="admin-panel hidden bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 border-b border-secondary pb-2">จัดการผู้ใช้งาน</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-2">
                            <div>
                                <h4 class="text-lg font-medium mb-2">รายชื่อผู้ใช้</h4>
                                <div class="h-64 overflow-y-auto border border-secondary rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-gray-900 text-gray-300"><tr><th class="p-2">Username</th><th class="p-2">Role</th><th class="p-2">Actions</th></tr></thead><tbody id="user-list-body"></tbody></table></div>
                            </div>
                            <div>
                                <h4 id="user-form-title" class="text-lg font-medium mb-2">เพิ่มผู้ใช้ใหม่</h4>
                                <form id="user-form" class="space-y-3">
                                    <input type="hidden" id="user-form-mode" value="add"><input type="hidden" id="user-form-original-username">
                                    <div><label for="user-form-username" class="text-gray-400">ชื่อผู้ใช้</label><input type="text" id="user-form-username" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg" required></div>
                                    <div><label for="user-form-password" class="text-gray-400">รหัสผ่าน (เว้นว่างไว้หากไม่ต้องการเปลี่ยน)</label><input type="password" id="user-form-password" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg"></div>
                                    <div><label for="user-form-role" class="text-gray-400">บทบาท</label><select id="user-form-role" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg"><option value="Admin">Admin</option><option value="User1">User1</option><option value="User2">User2</option><option value="User3">User3</option><option value="User4">User4</option></select></div>
                                    <div><label class="text-gray-400">สิทธิ์การเข้าถึง</label><div id="user-form-permissions" class="space-y-1 mt-1"><label class="flex items-center"><input type="checkbox" value="Flagship" class="form-checkbox channel-perm bg-gray-700 border-gray-600 mr-2">Flagship</label><label class="flex items-center"><input type="checkbox" value="Dealer" class="form-checkbox channel-perm bg-gray-700 border-gray-600 mr-2">Dealer</label><label class="flex items-center"><input type="checkbox" value="Marketplace" class="form-checkbox channel-perm bg-gray-700 border-gray-600 mr-2">Marketplace</label><label class="flex items-center"><input type="checkbox" id="user-form-view-costs" class="form-checkbox bg-gray-700 border-gray-600 mr-2">View Costs</label></div></div>
                                    <div class="flex space-x-2 pt-2"><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">บันทึก</button><button type="button" id="user-form-cancel" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ยกเลิก</button></div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Template Management -->
                    <div id="template-management-panel" class="admin-panel hidden bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 border-b border-secondary pb-2">จัดการเทมเพลต</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-2">
                            <div>
                                <h4 class="text-lg font-medium mb-2">แก้ไขเทมเพลต</h4>
                                <div class="mb-4"><label for="template-editor-selector" class="block text-gray-300 mb-2">เลือกเทมเพลตที่จะแก้ไข</label><select id="template-editor-selector" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"></select></div>
                                <div id="template-controls" class="space-y-2"></div>
                                <button id="save-template-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">บันทึกการแก้ไข</button>
                                <hr class="my-4 border-secondary">
                                <h4 class="text-lg font-medium mb-2">เพิ่มเทมเพลตใหม่</h4>
                                <div class="space-y-2"><label class="block text-gray-400">ชื่อเทมเพลตใหม่</label><input type="text" id="new-template-name" placeholder="เช่น Custom A4" class="w-full mt-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg"><label class="block text-gray-400">อัปโหลดพื้นหลัง (รูปภาพ)</label><input type="file" id="template-upload" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/></div>
                                <button id="add-template-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">เพิ่มเทมเพลต</button>
                            </div>
                            <div class="flex flex-col">
                                <h4 class="text-lg font-medium mb-2">ตัวอย่างสด</h4>
                                <div id="template-live-preview" class="bg-gray-900 p-2 rounded-lg flex-grow flex justify-center items-center overflow-hidden"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Log Viewer -->
                    <div id="log-viewer-panel" class="admin-panel hidden bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 border-b border-secondary pb-2">ประวัติการใช้งาน</h3>
                        <textarea id="log-viewer" readonly class="w-full h-40 bg-gray-900 text-gray-300 p-2 rounded-lg text-xs"></textarea>
                        <button id="export-log-btn" class="mt-3 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ส่งออกประวัติ (CSV)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Editor Modal -->
    <div id="edit-data-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-edit-data-modal-btn">&times;</span>
            <h2 class="text-2xl font-bold mb-4">แก้ไขข้อมูลสินค้า</h2>
            <div class="mb-4">
                <button id="save-edited-data-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">บันทึกการเปลี่ยนแปลงทั้งหมด</button>
            </div>
            <div class="overflow-auto h-[75vh]">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-700 text-gray-300 uppercase sticky top-0">
                        <tr>
                            <th class="p-2">SKU</th>
                            <th class="p-2">Description</th>
                            <th class="p-2">Costs</th>
                            <th class="p-2">Normal Price</th>
                            <th class="p-2">Promotion Price</th>
                            <th class="p-2">Expires Date</th>
                            <th class="p-2">Marketplace Price</th>
                            <th class="p-2">Dealer T1</th>
                            <th class="p-2">Dealer T2</th>
                            <th class="p-2">Dealer T3</th>
                        </tr>
                    </thead>
                    <tbody id="edit-data-table-body">
                        <!-- Editable rows will be generated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- README in comments -->
    <!--
    ==================================================================
    README: Price Tag Management Application
    ==================================================================

    This is a client-side web application for internal price tag management.
    It runs entirely in the browser and uses localStorage for persistence.

    ------------------------------------------------------------------
    1. How to Replace Excel Data and Map Columns
    ------------------------------------------------------------------

    The application loads product data from an Excel file (.xlsx).

    A. Data Loading:
       - On first load, the app looks for 'price_data' in localStorage.
       - If not found, it attempts to fetch a `sample_data.json` file (you should place this file in the same directory as index.html).
       - To load your own data, use the Admin Panel:
         1. Log in as 'host1' or 'admin1'.
         2. Click 'แผงควบคุม' (Admin Panel).
         3. Under 'จัดการข้อมูล' (Data Management), click the file input to select your .xlsx file.
       - The data will be parsed and saved to localStorage.

    B. Excel Column Mapping:
       The application expects specific column headers in your Excel file.
       The headers are case-insensitive and can be in Thai or English.
       - Col A: SKU ('Item No.' or 'sku')
       - Col B: Description ('Description')
       - Col C: Details ('Details')
       - Col D: Costs ('Costs' or 'cost')
       - Col E: Normal Price ('Normal Price')
       - Col F: Promotion Price ('Promotion Price')
       - Col G: Expires Date ('Expire Date')
       - Col H: Marketplace Price ('Marketplace Price')
       - Col I: Marketplace GP% (Ignored, will be auto-calculated)
       - Col J: Dealer Price Tier 1 ('Dealer Price T1' or '1-20 Units')
       - Col K: GP% T1 (Ignored, will be auto-calculated)
       - Col L: Dealer Price Tier 2 ('Dealer Price T2' or '21-30 Units')
       - Col M: GP% T2 (Ignored, will be auto-calculated)
       - Col N: Dealer Price Tier 3 ('Dealer Price T3' or '31 Units Up')
       - Col O: GP% T3 (Ignored, will be auto-calculated)

    ------------------------------------------------------------------
    2. How to Deploy to GitHub Pages / Vercel
    ------------------------------------------------------------------

    This application is a single `index.html` file with no backend, making deployment very simple.

    A. GitHub Pages:
       1. Create a new repository on GitHub.
       2. Upload this `index.html` file to the repository.
       3. (Optional but recommended) Create a `sample_data.json` with your initial product data and upload it too.
       4. In your repository settings, go to the 'Pages' section.
       5. Under 'Build and deployment', select 'Deploy from a branch'.
       6. Choose the main branch and `/ (root)` folder, then click 'Save'.
       7. Your site will be live at `https://<your-username>.github.io/<your-repo-name>/` in a few minutes.

    B. Vercel:
       1. Sign up for a Vercel account (a free hobby plan is sufficient).
       2. Connect your GitHub account to Vercel.
       3. Click 'Add New...' -> 'Project'.
       4. Import the GitHub repository you created.
       5. Vercel will automatically detect it as a static site. No framework preset is needed.
       6. Click 'Deploy'. Your site will be live at a Vercel-provided URL.

    ------------------------------------------------------------------
    3. Demo Credentials
    ------------------------------------------------------------------

    Username / Password -> Role (Visible Channels)
    The user list is now manageable by the 'Host' user and stored in the browser's local storage.
    Default users are:
    - host1 / host123    -> Host (Full Access, Can manage users, Can see Costs).
    - admin1 / admin123  -> Admin (Admin Access, Can see Costs).
    - user1 / u1pass     -> User1 (Flagship only).
    - user2 / u2pass     -> User2 (Flagship only).
    - user3 / u3pass     -> User3 (Dealer only, all 3 tiers + GP%).
    - user4 / u4pass     -> User4 (Marketplace only, sees GP%).

    ==================================================================
    -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- App State ---
            let allSkus = [];
            let filteredSkus = [];
            let currentUser = null;
            let currentPage = 1;
            const skusPerPage = 20;
            let appUsers = {};
            let companyLogo = localStorage.getItem('companyLogo') || 'https://placehold.co/200x60/ffffff/000000?text=ProPlugin';
            let dealerSettings = JSON.parse(localStorage.getItem('dealerSettings')) || {
                tier1Name: 'Dealer Tier 1',
                tier2Name: 'Dealer Tier 2',
                tier3Name: 'Dealer Tier 3',
                defaultTier: 'dealer_price_t1'
            };
            let templateSettings = {};

            // --- UI Elements ---
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const userInfo = document.getElementById('user-info');
            const logoutBtn = document.getElementById('logout-btn');
            const adminPanelBtn = document.getElementById('admin-panel-btn');
            const searchInput = document.getElementById('search-input');
            const dateFilterStart = document.getElementById('date-filter-start');
            const dateFilterEnd = document.getElementById('date-filter-end');
            const channelSelector = document.getElementById('channel-selector');
            const skuTableBody = document.getElementById('sku-table-body');
            const tableHeader = document.getElementById('table-header');
            const paginationContainer = document.getElementById('pagination');
            const editDataBtn = document.getElementById('edit-data-btn');
            
            // Modals
            const previewModal = document.getElementById('preview-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const adminModal = document.getElementById('admin-modal');
            const closeAdminModalBtn = document.getElementById('close-admin-modal-btn');
            const editDataModal = document.getElementById('edit-data-modal');
            const closeEditDataModalBtn = document.getElementById('close-edit-data-modal-btn');
            const saveEditedDataBtn = document.getElementById('save-edited-data-btn');
            const editDataTableBody = document.getElementById('edit-data-table-body');

            // Preview Modal Elements
            const previewBtn = document.getElementById('preview-btn');
            const prevSkuBtn = document.getElementById('prev-sku-btn');
            const nextSkuBtn = document.getElementById('next-sku-btn');
            const skuCounter = document.getElementById('sku-counter');
            const tagPreviewArea = document.getElementById('tag-preview-area');
            const printBtn = document.getElementById('print-btn');
            const dealerTierSelectorContainer = document.getElementById('dealer-tier-selector-container');
            const dealerTierSelector = document.getElementById('dealer-tier-selector');
            
            // Admin Panel Elements
            const adminNav = document.getElementById('admin-nav');
            const importExcelInput = document.getElementById('import-excel');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const logoUpload = document.getElementById('logo-upload');
            const logoPreview = document.getElementById('logo-preview');
            const tier1NameInput = document.getElementById('tier1-name');
            const tier2NameInput = document.getElementById('tier2-name');
            const tier3NameInput = document.getElementById('tier3-name');
            const defaultTierSelector = document.getElementById('default-tier-selector');
            const saveDealerSettingsBtn = document.getElementById('save-dealer-settings-btn');
            const logViewer = document.getElementById('log-viewer');
            const exportLogBtn = document.getElementById('export-log-btn');

            // User Management Elements
            const userManagementPanel = document.getElementById('user-management-panel');
            const userListBody = document.getElementById('user-list-body');
            const userForm = document.getElementById('user-form');
            const userFormTitle = document.getElementById('user-form-title');
            const userFormCancelBtn = document.getElementById('user-form-cancel');

            // Template Management Elements
            const templateManagementPanel = document.getElementById('template-management-panel');
            const templateEditorSelector = document.getElementById('template-editor-selector');
            const templateControls = document.getElementById('template-controls');
            const templateLivePreview = document.getElementById('template-live-preview');
            const saveTemplateBtn = document.getElementById('save-template-btn');
            const addTemplateBtn = document.getElementById('add-template-btn');
            const newTemplateNameInput = document.getElementById('new-template-name');
            const templateUploadInput = document.getElementById('template-upload');

            // --- Default Users & Templates ---
            const defaultUsers = {
                host1: { password: 'host123', role: 'Host', channels: ['Flagship', 'Dealer', 'Marketplace'], canViewCosts: true },
                admin1: { password: 'admin123', role: 'Admin', channels: ['Flagship', 'Dealer', 'Marketplace'], canViewCosts: true },
                user1: { password: 'u1pass', role: 'User1', channels: ['Flagship'], canViewCosts: false },
                user2: { password: 'u2pass', role: 'User2', channels: ['Flagship'], canViewCosts: false },
                user3: { password: 'u3pass', role: 'User3', channels: ['Dealer'], canViewCosts: false },
                user4: { password: 'u4pass', role: 'User4', channels: ['Marketplace'], canViewCosts: false }
            };

            const defaultTemplateSettings = {
                'A4': { 
                    desc: { size: 60, color: '#000000', marginTop: 16 },
                    details: { size: 22, color: '#000000', marginTop: 16 },
                    price: { size: 90, color: '#dc2626', marginTop: 0 },
                    sku: { size: 18, color: '#000000', marginTop: 0 },
                    backgroundImage: null, isDark: false 
                },
                'A5': { 
                    desc: { size: 50, color: '#000000', marginTop: 16 },
                    details: { size: 18, color: '#000000', marginTop: 16 },
                    price: { size: 72, color: '#dc2626', marginTop: 0 },
                    sku: { size: 16, color: '#000000', marginTop: 0 },
                    backgroundImage: null, isDark: false 
                },
                'A6': { 
                    desc: { size: 40, color: '#000000', marginTop: 16 },
                    details: { size: 16, color: '#000000', marginTop: 16 },
                    price: { size: 60, color: '#dc2626', marginTop: 0 },
                    sku: { size: 14, color: '#000000', marginTop: 0 },
                    backgroundImage: null, isDark: false 
                },
                'Accessories Tag': { 
                    desc: { size: 24, color: '#ffffff', marginTop: 0 },
                    price: { size: 36, color: '#fbbf24', marginTop: 0 },
                    sku: { size: 10, color: '#ffffff', marginTop: 0 },
                    backgroundImage: null, isDark: true 
                },
            };

            // --- Initialization ---
            function init() {
                loadUsers();
                loadTemplateSettings();
                const sessionUser = JSON.parse(sessionStorage.getItem('currentUser'));
                if (sessionUser) {
                    currentUser = sessionUser;
                    showApp();
                } else {
                    showLogin();
                }

                // Event Listeners
                loginForm.addEventListener('submit', handleLogin);
                logoutBtn.addEventListener('click', handleLogout);
                adminPanelBtn.addEventListener('click', openAdminPanel);
                closeAdminModalBtn.addEventListener('click', () => adminModal.style.display = 'none');
                searchInput.addEventListener('input', applyFilters);
                dateFilterStart.addEventListener('change', applyFilters);
                dateFilterEnd.addEventListener('change', applyFilters);
                channelSelector.addEventListener('change', () => {
                    applyFilters();
                    updateTableHeader();
                });
                previewBtn.addEventListener('click', openPreviewModal);
                closeModalBtn.addEventListener('click', () => previewModal.style.display = 'none');
                editDataBtn.addEventListener('click', openDataEditor);
                closeEditDataModalBtn.addEventListener('click', () => editDataModal.style.display = 'none');
                saveEditedDataBtn.addEventListener('click', saveEditedData);
                
                // Admin Panel Listeners
                adminNav.addEventListener('click', handleAdminNav);
                importExcelInput.addEventListener('change', handleExcelImport);
                exportExcelBtn.addEventListener('click', handleExcelExport);
                logoUpload.addEventListener('change', handleLogoUpload);
                saveDealerSettingsBtn.addEventListener('click', saveDealerSettings);
                exportLogBtn.addEventListener('click', exportLogs);

                // User Management Listeners
                userForm.addEventListener('submit', handleUserFormSubmit);
                userFormCancelBtn.addEventListener('click', resetUserForm);
                userListBody.addEventListener('click', handleUserListActions);

                // Template Management Listeners
                templateEditorSelector.addEventListener('change', populateTemplateControls);
                templateControls.addEventListener('input', updateTemplateLivePreview);
                saveTemplateBtn.addEventListener('click', saveCurrentTemplateSettings);
                addTemplateBtn.addEventListener('click', handleAddTemplate);
            }

            // --- User Management ---
            function loadUsers() {
                const storedUsers = localStorage.getItem('app_users');
                if (storedUsers) {
                    appUsers = JSON.parse(storedUsers);
                } else {
                    appUsers = JSON.parse(JSON.stringify(defaultUsers)); // Deep copy
                }
                appUsers.host1 = defaultUsers.host1;
                saveUsers();
            }

            function saveUsers() {
                localStorage.setItem('app_users', JSON.stringify(appUsers));
            }

            // --- Template Management ---
            function loadTemplateSettings() {
                const storedSettings = localStorage.getItem('template_settings');
                if (storedSettings) {
                    templateSettings = JSON.parse(storedSettings);
                } else {
                    templateSettings = JSON.parse(JSON.stringify(defaultTemplateSettings));
                }
                // Ensure default templates exist
                Object.keys(defaultTemplateSettings).forEach(key => {
                    if (!templateSettings[key]) {
                        templateSettings[key] = defaultTemplateSettings[key];
                    }
                });
                saveTemplateSettings();
                populateTemplateSelectors();
            }

            function saveTemplateSettings() {
                 localStorage.setItem('template_settings', JSON.stringify(templateSettings));
            }

            function populateTemplateSelectors(selectorElement) {
                const templateNames = Object.keys(templateSettings);
                const selectors = selectorElement ? [selectorElement] : [document.getElementById('template-selector'), templateEditorSelector];
                selectors.forEach(selector => {
                    if (selector) {
                        const currentVal = selector.value;
                        selector.innerHTML = '';
                        templateNames.forEach(name => {
                            selector.innerHTML += `<option value="${name}">${name}</option>`;
                        });
                        selector.value = currentVal;
                    }
                });
            }

            // --- Authentication & UI Switching ---
            function handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const user = appUsers[username];

                if (user && user.password === password) {
                    currentUser = { username, ...user };
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    logAction('Login');
                    showApp();
                } else {
                    loginError.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
                }
            }

            function handleLogout() {
                logAction('Logout');
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                showLogin();
            }

            function showLogin() {
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }

            async function showApp() {
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                userInfo.textContent = `ผู้ใช้: ${currentUser.username} (${currentUser.role})`;

                if (['Host', 'Admin'].includes(currentUser.role)) {
                    adminPanelBtn.classList.remove('hidden');
                    editDataBtn.classList.remove('hidden');
                } else {
                    adminPanelBtn.classList.add('hidden');
                    editDataBtn.classList.add('hidden');
                }

                setupChannelSelector();
                await loadData();
                updateTableHeader();
                applyFilters();
            }

            // --- Data Handling ---
            async function loadData() {
                const localData = localStorage.getItem('price_data');
                if (localData && localData !== '[]') {
                    allSkus = JSON.parse(localData);
                } else {
                    try {
                        const response = await fetch('sample_data.json');
                        if (!response.ok) throw new Error('sample_data.json not found');
                        const data = await response.json();
                        allSkus = data;
                        localStorage.setItem('price_data', JSON.stringify(allSkus));
                        logAction('Loaded sample_data.json');
                    } catch (error) {
                        console.error('Error loading initial data:', error);
                        allSkus = [{sku: 'SAMPLE-01', description: 'Sample Product', details: '• Feature 1\n• Feature 2', cost: 50, normal_price: 100, promo_price: 80}];
                    }
                }
            }

            function handleExcelImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    const mappedData = mapExcelData(jsonData);
                    allSkus = mappedData;
                    localStorage.setItem('price_data', JSON.stringify(allSkus));
                    logAction(`Imported ${file.name}`);
                    alert('นำเข้าข้อมูลสำเร็จ!');
                    applyFilters();
                };
                reader.readAsArrayBuffer(file);
            }
            
            function calculateGP(price, cost) {
                if (!price || !cost || price === 0) return 0;
                return (price - cost) / price;
            }

            function mapExcelData(data) {
                // Remove header rows
                const rows = data.slice(2); 
                return rows.map(row => {
                    const cost = parseFloat(row[3]) || 0;
                    const marketplacePrice = parseFloat(row[7]) || 0;
                    const dealerT1 = parseFloat(row[9]) || 0;
                    const dealerT2 = parseFloat(row[11]) || 0;
                    const dealerT3 = parseFloat(row[13]) || 0;

                    return {
                        sku: row[0] || '',
                        description: row[1] || '',
                        details: row[2] || '',
                        cost: cost,
                        normal_price: parseFloat(row[4]) || 0,
                        promo_price: parseFloat(row[5]) || 0,
                        expire_date: row[6] || '',
                        marketplace_price: marketplacePrice,
                        market_gp: calculateGP(marketplacePrice, cost),
                        dealer_price_t1: dealerT1,
                        dealer_gp_t1: calculateGP(dealerT1, cost),
                        dealer_price_t2: dealerT2,
                        dealer_gp_t2: calculateGP(dealerT2, cost),
                        dealer_price_t3: dealerT3,
                        dealer_gp_t3: calculateGP(dealerT3, cost),
                    };
                });
            }

            async function handleExcelExport() {
                const headers = [
                    "SKU", "Description", "Details", "Costs", "Normal Price", 
                    "Promotion Price", "Expires Date", "Marketplace Price", "Marketplace GP%",
                    "Dealer Price Tier 1", "GP% T1", "Dealer Price Tier 2", "GP% T2",
                    "Dealer Price Tier 3", "GP% T3"
                ];

                const data = allSkus.map(sku => [
                    sku.sku, sku.description, sku.details, sku.cost, sku.normal_price,
                    sku.promo_price, sku.expire_date, sku.marketplace_price, sku.market_gp,
                    sku.dealer_price_t1, sku.dealer_gp_t1, sku.dealer_price_t2, sku.dealer_gp_t2,
                    sku.dealer_price_t3, sku.dealer_gp_t3
                ]);

                try {
                    const workbook = await XlsxPopulate.fromBlankAsync();
                    const sheet = workbook.sheet(0);
                    
                    sheet.cell("A1").value([headers]);
                    sheet.range("A1:O1").style("bold", true);

                    if (data.length > 0) {
                        sheet.cell("A2").value(data);
                        
                        // Highlight columns
                        sheet.range(`D2:D${data.length + 1}`).style("fill", "c6efce"); // Light Green
                        sheet.range(`F2:G${data.length + 1}`).style("fill", "ffeb9c"); // Yellow

                        // Format GP% columns
                        sheet.range(`I2:I${data.length + 1}`).style("numberFormat", "0.00%");
                        sheet.range(`K2:K${data.length + 1}`).style("numberFormat", "0.00%");
                        sheet.range(`M2:M${data.length + 1}`).style("numberFormat", "0.00%");
                        sheet.range(`O2:O${data.length + 1}`).style("numberFormat", "0.00%");
                    }

                    const blob = await workbook.outputAsync();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "price_data_export.xlsx";
                    a.click();
                    URL.revokeObjectURL(url);
                    logAction('Exported data to Excel');
                } catch (err) {
                    console.error("Error exporting to Excel:", err);
                }
            }


            // --- UI Rendering ---
            function setupChannelSelector() {
                channelSelector.innerHTML = '';
                currentUser.channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel;
                    option.textContent = channel;
                    channelSelector.appendChild(option);
                });
                channelSelector.value = currentUser.channels.includes('Flagship') ? 'Flagship' : currentUser.channels[0];
            }

            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const startDate = dateFilterStart.value ? new Date(dateFilterStart.value) : null;
                const endDate = dateFilterEnd.value ? new Date(dateFilterEnd.value) : null;
                if(startDate) startDate.setHours(0,0,0,0);
                if(endDate) endDate.setHours(23,59,59,999);

                filteredSkus = allSkus.filter(sku => {
                    const matchesSearch = !searchTerm || 
                        (sku.sku && sku.sku.toLowerCase().includes(searchTerm)) ||
                        (sku.description && sku.description.toLowerCase().includes(searchTerm));

                    let matchesDate = true;
                    if (startDate || endDate) {
                        if (!sku.expire_date) {
                            matchesDate = false;
                        } else {
                            const [day, month, year] = sku.expire_date.split('-');
                            const itemDate = new Date(`${year}-${month}-${day}`);
                            if (startDate && itemDate < startDate) matchesDate = false;
                            if (endDate && itemDate > endDate) matchesDate = false;
                        }
                    }
                    
                    return matchesSearch && matchesDate;
                });
                
                currentPage = 1;
                renderTable();
                renderPagination();
            }

            function updateTableHeader() {
                const selectedChannel = channelSelector.value;
                let headers = `
                    <th class="p-3"><input type="checkbox" id="select-all-checkbox"></th>
                    <th class="p-3">SKU</th>
                    <th class="p-3">Description</th>
                    <th class="p-3">Details</th>
                `;
                if (currentUser.canViewCosts) {
                    headers += `<th class="p-3">Costs</th>`;
                }
                headers += `<th class="p-3">Normal Price</th>`;

                switch (selectedChannel) {
                    case 'Flagship':
                        headers += `<th class="p-3">Promotion Price</th>`;
                        break;
                    case 'Marketplace':
                        headers += `<th class="p-3">Marketplace Price</th><th class="p-3">GP%</th>`;
                        break;
                    case 'Dealer':
                        headers += `
                            <th class="p-3">${dealerSettings.tier1Name}</th><th class="p-3">GP%</th>
                            <th class="p-3">${dealerSettings.tier2Name}</th><th class="p-3">GP%</th>
                            <th class="p-3">${dealerSettings.tier3Name}</th><th class="p-3">GP%</th>
                        `;
                        break;
                }
                if (selectedChannel === 'Flagship') {
                    headers += `<th class="p-3">Expire Date</th>`;
                }
                tableHeader.innerHTML = `<tr>${headers}</tr>`;
                
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                if(selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', (e) => {
                        document.querySelectorAll('.sku-checkbox').forEach(cb => {
                            cb.checked = e.target.checked;
                        });
                    });
                }
            }

            function renderTable() {
                skuTableBody.innerHTML = '';
                const start = (currentPage - 1) * skusPerPage;
                const end = start + skusPerPage;
                const paginatedSkus = filteredSkus.slice(start, end);
                const selectedChannel = channelSelector.value;

                if (paginatedSkus.length === 0) {
                    skuTableBody.innerHTML = `<tr><td colspan="12" class="text-center p-8 text-gray-400">ไม่พบข้อมูล</td></tr>`;
                    return;
                }

                paginatedSkus.forEach((sku) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-secondary hover:bg-gray-700';
                    
                    let rowContent = `
                        <td class="p-3"><input type="checkbox" class="sku-checkbox" data-sku="${sku.sku}"></td>
                        <td class="p-3">${sku.sku || ''}</td>
                        <td class="p-3">${sku.description || ''}</td>
                        <td class="p-3 text-sm text-gray-400">${(sku.details || '').split('\n').slice(0, 5).join('<br>')}</td>
                    `;

                    if (currentUser.canViewCosts) {
                        rowContent += `<td class="p-3 text-right">${formatCurrency(sku.cost)}</td>`;
                    }

                    rowContent += `<td class="p-3 text-right">${formatCurrency(sku.normal_price)}</td>`;

                    switch (selectedChannel) {
                        case 'Flagship':
                            rowContent += `<td class="p-3 text-right font-bold text-red-400">${formatCurrency(sku.promo_price)}</td>`;
                            break;
                        case 'Marketplace':
                            rowContent += `<td class="p-3 text-right font-bold text-red-400">${formatCurrency(sku.marketplace_price)}</td>`;
                            rowContent += `<td class="p-3 text-right">${formatPercent(sku.market_gp)}</td>`;
                            break;
                        case 'Dealer':
                             rowContent += `
                                <td class="p-3 text-right font-bold text-red-400">${formatCurrency(sku.dealer_price_t1)}</td>
                                <td class="p-3 text-right">${formatPercent(sku.dealer_gp_t1)}</td>
                                <td class="p-3 text-right font-bold text-red-400">${formatCurrency(sku.dealer_price_t2)}</td>
                                <td class="p-3 text-right">${formatPercent(sku.dealer_gp_t2)}</td>
                                <td class="p-3 text-right font-bold text-red-400">${formatCurrency(sku.dealer_price_t3)}</td>
                                <td class="p-3 text-right">${formatPercent(sku.dealer_gp_t3)}</td>
                            `;
                            break;
                    }
                    
                    if (selectedChannel === 'Flagship') {
                        rowContent += `<td class="p-3">${sku.expire_date || ''}</td>`;
                    }
                    row.innerHTML = rowContent;
                    skuTableBody.appendChild(row);
                });
            }

            function renderPagination() {
                paginationContainer.innerHTML = '';
                const pageCount = Math.ceil(filteredSkus.length / skusPerPage);
                if (pageCount <= 1) return;

                for (let i = 1; i <= pageCount; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.className = `px-4 py-2 rounded-lg ${i === currentPage ? 'bg-red-600 text-white' : 'bg-gray-700 text-gray-300'}`;
                    button.addEventListener('click', () => {
                        currentPage = i;
                        renderTable();
                        renderPagination();
                    });
                    paginationContainer.appendChild(button);
                }
            }

            // --- Preview & Print Modal ---
            let selectedForPreview = [];
            let currentPreviewIndex = 0;

            function openPreviewModal() {
                selectedForPreview = Array.from(document.querySelectorAll('.sku-checkbox:checked'))
                    .map(cb => cb.dataset.sku)
                    .map(skuId => filteredSkus.find(s => s.sku === skuId));

                if (selectedForPreview.length === 0) {
                    alert('กรุณาเลือกอย่างน้อยหนึ่งรายการเพื่อดูตัวอย่าง');
                    return;
                }

                currentPreviewIndex = 0;
                setupDealerTierSelector();
                updatePreview();
                previewModal.style.display = 'block';
            }

            function updatePreview() {
                if (selectedForPreview.length === 0) {
                    tagPreviewArea.innerHTML = '<p class="text-gray-400">ไม่มีรายการที่เลือก</p>';
                    skuCounter.textContent = '0 / 0';
                    return;
                }

                skuCounter.textContent = `${currentPreviewIndex + 1} / ${selectedForPreview.length}`;
                const sku = selectedForPreview[currentPreviewIndex];
                
                let previewControlsHTML = `
                    <div class="w-full max-w-md mb-4">
                        <label for="preview-template-selector" class="block text-gray-300 mb-2">เลือกเทมเพลต</label>
                        <select id="preview-template-selector" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"></select>
                    </div>
                `;
                tagPreviewArea.innerHTML = previewControlsHTML;
                
                const tempTemplateSelector = document.getElementById('preview-template-selector');
                populateTemplateSelectors(tempTemplateSelector);
                
                const tagContainer = document.createElement('div');
                tagPreviewArea.appendChild(tagContainer);

                const render = () => renderPriceTag(tagContainer, sku, tempTemplateSelector.value);
                tempTemplateSelector.addEventListener('change', render);
                render();

                prevSkuBtn.disabled = currentPreviewIndex === 0;
                nextSkuBtn.disabled = currentPreviewIndex === selectedForPreview.length - 1;
            }

            prevSkuBtn.addEventListener('click', () => {
                if (currentPreviewIndex > 0) {
                    currentPreviewIndex--;
                    updatePreview();
                }
            });

            nextSkuBtn.addEventListener('click', () => {
                if (currentPreviewIndex < selectedForPreview.length - 1) {
                    currentPreviewIndex++;
                    updatePreview();
                }
            });

            function renderPriceTag(container, sku, templateName, liveFontSettings = null) {
                const baseSettings = templateSettings[templateName];
                if (!baseSettings) {
                    console.error(`Template settings for "${templateName}" not found.`);
                    return;
                }
                const settings = liveFontSettings ? { ...baseSettings, ...liveFontSettings } : baseSettings;

                const selectedChannel = channelSelector.value;
                let price, normalPrice;

                if (selectedChannel === 'Dealer') {
                    const selectedTier = dealerTierSelector.value;
                    price = sku[selectedTier];
                    normalPrice = sku.normal_price;
                } else if (selectedChannel === 'Marketplace') {
                    price = sku.marketplace_price;
                    normalPrice = sku.normal_price;
                } else { // Flagship
                    price = sku.promo_price > 0 ? sku.promo_price : sku.normal_price;
                    normalPrice = sku.promo_price > 0 ? sku.normal_price : null;
                }
                
                let tagClass = '';
                if (templateName === 'A4') tagClass = 'price-tag-a4';
                else if (templateName === 'A5') tagClass = 'price-tag-a5';
                else if (templateName === 'A6') tagClass = 'price-tag-a6';
                else if (templateName === 'Accessories Tag') tagClass = 'price-tag-acc';

                const expireText = (selectedChannel === 'Flagship' && sku.expire_date) ? `Expire: ${sku.expire_date}` : '';
                
                const backgroundStyle = baseSettings.backgroundImage ? `background-image: url('${baseSettings.backgroundImage}'); background-size: cover; background-position: center; border: none;` 
                                      : (baseSettings.isDark ? 'background-color: black; border: none;' : 'background-color: white; border: 5px solid black;');

                if (templateName === 'Accessories Tag') {
                    container.innerHTML = `
                    <div class="price-tag ${tagClass} flex flex-col justify-between p-2" style="${backgroundStyle}">
                        <div class="flex justify-between items-start text-white">
                            <span style="font-size: ${settings.sku.size}px; color: ${settings.sku.color}; margin-top: ${settings.sku.marginTop}px;">${sku.sku}</span>
                            ${!baseSettings.backgroundImage ? `<img src="${companyLogo}" alt="Logo" class="h-8">` : ''}
                        </div>
                        <div class="flex-grow flex items-center justify-center text-center">
                            <h2 class="font-bold text-white truncate" style="font-size: ${settings.desc.size}px; color: ${settings.desc.color}; margin-top: ${settings.desc.marginTop}px;">${sku.description}</h2>
                        </div>
                        <div class="flex justify-between items-end text-white">
                            <span class="text-xs">${expireText}</span>
                            <div class="text-right">
                                ${normalPrice && price < normalPrice ? `<p class="text-gray-400 line-through" style="font-size: ${settings.price.size * 0.5}px;">${formatCurrency(normalPrice)}</p>` : ''}
                                <p class="font-bold" style="font-size: ${settings.price.size}px; color: ${settings.price.color}; margin-top: ${settings.price.marginTop}px;">${formatCurrency(price)}</p>
                            </div>
                        </div>
                    </div>`;
                    return;
                }

                container.innerHTML = `
                    <div class="price-tag ${tagClass} flex flex-col justify-between" style="${backgroundStyle}">
                        <div class="flex justify-between items-start">
                            ${!baseSettings.backgroundImage ? `<img src="${companyLogo}" alt="Logo" class="h-12">` : '<div></div>'}
                            <span class="font-semibold" style="font-size: ${settings.sku.size}px; color: ${settings.sku.color}; margin-top: ${settings.sku.marginTop}px;">${sku.sku}</span>
                        </div>
                        <div class="flex-grow my-4">
                            <h2 class="font-bold" style="font-size: ${settings.desc.size}px; color: ${settings.desc.color}; margin-top: ${settings.desc.marginTop}px;">${sku.description}</h2>
                            <ul class="list-disc list-inside mt-4" style="font-size: ${settings.details.size}px; color: ${settings.details.color}; margin-top: ${settings.details.marginTop}px;">
                                ${(sku.details || '').split('\n').map(line => `<li>${line}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="flex justify-between items-end">
                            <span class="font-medium">${expireText}</span>
                            <div class="text-right">
                                ${normalPrice && price < normalPrice ? `<p class="text-gray-500 line-through" style="font-size: ${settings.price.size * 0.5}px;">${formatCurrency(normalPrice)}</p>` : ''}
                                <p class="font-bold" style="font-size: ${settings.price.size}px; color: ${settings.price.color}; margin-top: ${settings.price.marginTop}px;">${formatCurrency(price)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            function openPrintView() {
                const templateName = tagPreviewArea.querySelector('select').value;
                const qty = parseInt(document.getElementById('print-qty-input').value) || 1;
                let tagsPerPage, layoutClass;

                if (templateName === 'A4') { tagsPerPage = 1; layoutClass = 'flex justify-center items-center'; }
                else if (templateName === 'A5') { tagsPerPage = 2; layoutClass = 'grid grid-cols-2 gap-0'; }
                else if (templateName === 'A6') { tagsPerPage = 4; layoutClass = 'grid grid-cols-2 grid-rows-2 gap-0'; }
                else if (templateName === 'Accessories Tag') { tagsPerPage = 12; layoutClass = 'grid grid-cols-2 grid-rows-6 gap-0'; }
                else { tagsPerPage = 4; layoutClass = 'grid grid-cols-2 grid-rows-2 gap-0'; }

                let allTagsHtml = '';
                selectedForPreview.forEach(sku => {
                    for (let i = 0; i < qty; i++) {
                        const tagContainer = document.createElement('div');
                        renderPriceTag(tagContainer, sku, templateName);
                        allTagsHtml += tagContainer.innerHTML;
                    }
                });

                const printWindow = window.open('', '', 'height=800,width=1000');
                printWindow.document.write('<html><head><title>Print Price Tags</title>');
                printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
                printWindow.document.write(`<style>${document.querySelector('style').innerHTML}</style>`);
                printWindow.document.write('</head><body>');

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = allTagsHtml;
                const allTags = Array.from(tempDiv.children);

                for (let i = 0; i < allTags.length; i += tagsPerPage) {
                    const pageChunk = allTags.slice(i, i + tagsPerPage);
                    let pageHtml = `<div class="w-[210mm] h-[297mm] p-2 box-border price-tag-container ${layoutClass}">`;
                    pageHtml += pageChunk.map(tag => tag.outerHTML).join('');
                    pageHtml += `</div>`;
                    printWindow.document.write(pageHtml);
                }

                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); }, 500); // Wait for styles to apply
                logAction(`Opened print view for selected tags with template ${templateName}`);
            }

            printBtn.addEventListener('click', openPrintView);

            // --- Admin Panel Logic ---
            function handleAdminNav(e) {
                if (e.target.classList.contains('admin-nav-btn')) {
                    const targetPanelId = e.target.dataset.panel;
                    document.querySelectorAll('.admin-panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(targetPanelId).classList.remove('hidden');
                    
                    document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.replace('bg-gray-700', 'bg-gray-900'));
                    e.target.classList.replace('bg-gray-900', 'bg-gray-700');
                }
            }

            function openAdminPanel() {
                logoPreview.src = companyLogo;
                tier1NameInput.value = dealerSettings.tier1Name;
                tier2NameInput.value = dealerSettings.tier2Name;
                tier3NameInput.value = dealerSettings.tier3Name;
                updateAdminDealerTierSelector();
                defaultTierSelector.value = dealerSettings.defaultTier;
                loadLogs();

                if (currentUser.role === 'Host') {
                    userManagementPanel.classList.remove('hidden');
                    templateManagementPanel.classList.remove('hidden');
                    renderUserManagementTable();
                    populateTemplateControls();
                } else {
                    document.querySelector('[data-panel="user-management-panel"]').classList.add('hidden');
                    document.querySelector('[data-panel="template-management-panel"]').classList.add('hidden');
                }
                
                adminModal.style.display = 'block';
            }

            function handleLogoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        companyLogo = e.target.result;
                        localStorage.setItem('companyLogo', companyLogo);
                        logoPreview.src = companyLogo;
                        logAction('Updated company logo');
                        alert('อัปเดตโลโก้สำเร็จ');
                    };
                    reader.readAsDataURL(file);
                }
            }

            function saveDealerSettings() {
                dealerSettings = {
                    tier1Name: tier1NameInput.value,
                    tier2Name: tier2NameInput.value,
                    tier3Name: tier3NameInput.value,
                    defaultTier: defaultTierSelector.value
                };
                localStorage.setItem('dealerSettings', JSON.stringify(dealerSettings));
                logAction('Updated dealer settings');
                alert('บันทึกการตั้งค่า Dealer สำเร็จ');
                updateTableHeader(); 
                updateAdminDealerTierSelector();
            }
            
            function setupDealerTierSelector() {
                const selectedChannel = channelSelector.value;
                if (selectedChannel === 'Dealer') {
                    dealerTierSelector.innerHTML = `
                        <option value="dealer_price_t1">${dealerSettings.tier1Name}</option>
                        <option value="dealer_price_t2">${dealerSettings.tier2Name}</option>
                        <option value="dealer_price_t3">${dealerSettings.tier3Name}</option>
                    `;
                    dealerTierSelector.value = dealerSettings.defaultTier;
                    dealerTierSelectorContainer.classList.remove('hidden');
                } else {
                    dealerTierSelectorContainer.classList.add('hidden');
                }
            }

            function updateAdminDealerTierSelector() {
                defaultTierSelector.innerHTML = `
                    <option value="dealer_price_t1">${tier1NameInput.value}</option>
                    <option value="dealer_price_t2">${tier2NameInput.value}</option>
                    <option value="dealer_price_t3">${tier3NameInput.value}</option>
                `;
            }

            // --- Host User Management ---
            function renderUserManagementTable() {
                userListBody.innerHTML = '';
                Object.keys(appUsers).forEach(username => {
                    const user = appUsers[username];
                    const row = document.createElement('tr');
                    row.className = 'border-b border-secondary';
                    row.innerHTML = `
                        <td class="p-2">${username}</td>
                        <td class="p-2">${user.role}</td>
                        <td class="p-2">
                            <button data-action="edit" data-username="${username}" class="text-blue-400 hover:text-blue-300 text-xs">แก้ไข</button>
                            ${username !== 'host1' ? `<button data-action="delete" data-username="${username}" class="text-red-400 hover:text-red-300 ml-2 text-xs">ลบ</button>` : ''}
                        </td>
                    `;
                    userListBody.appendChild(row);
                });
            }

            function handleUserListActions(e) {
                const target = e.target;
                const action = target.dataset.action;
                const username = target.dataset.username;

                if (!action || !username) return;

                if (action === 'edit') {
                    if (username === 'host1') {
                        alert('ไม่สามารถแก้ไขข้อมูลผู้ใช้ Host ได้');
                        return;
                    }
                    const user = appUsers[username];
                    userFormTitle.textContent = `แก้ไขผู้ใช้: ${username}`;
                    document.getElementById('user-form-mode').value = 'edit';
                    document.getElementById('user-form-original-username').value = username;
                    const usernameInput = document.getElementById('user-form-username');
                    usernameInput.value = username;
                    usernameInput.readOnly = true;
                    document.getElementById('user-form-password').value = '';
                    document.getElementById('user-form-password').placeholder = 'เว้นว่างไว้หากไม่ต้องการเปลี่ยน';
                    document.getElementById('user-form-role').value = user.role;
                    
                    document.querySelectorAll('.channel-perm').forEach(cb => {
                        cb.checked = user.channels.includes(cb.value);
                    });
                    document.getElementById('user-form-view-costs').checked = user.canViewCosts;
                } else if (action === 'delete') {
                    delete appUsers[username];
                    saveUsers();
                    logAction(`Deleted user: ${username}`);
                    renderUserManagementTable();
                }
            }

            function handleUserFormSubmit(e) {
                e.preventDefault();
                const mode = document.getElementById('user-form-mode').value;
                const username = document.getElementById('user-form-username').value;
                const password = document.getElementById('user-form-password').value;
                const role = document.getElementById('user-form-role').value;
                const channels = Array.from(document.querySelectorAll('.channel-perm:checked')).map(cb => cb.value);
                const canViewCosts = document.getElementById('user-form-view-costs').checked;

                if (!username) {
                    alert('กรุณากรอกชื่อผู้ใช้');
                    return;
                }

                if (mode === 'add') {
                    if (appUsers[username]) {
                        alert('ชื่อผู้ใช้นี้มีอยู่แล้ว');
                        return;
                    }
                    if (!password) {
                         alert('กรุณากรอกรหัสผ่านสำหรับผู้ใช้ใหม่');
                        return;
                    }
                    appUsers[username] = { password, role, channels, canViewCosts };
                    logAction(`Added new user: ${username}`);
                } else { // edit mode
                    const originalUsername = document.getElementById('user-form-original-username').value;
                    const userToUpdate = appUsers[originalUsername];
                    if (password) {
                        userToUpdate.password = password;
                    }
                    userToUpdate.role = role;
                    userToUpdate.channels = channels;
                    userToUpdate.canViewCosts = canViewCosts;
                    logAction(`Updated user: ${username}`);
                }
                
                saveUsers();
                renderUserManagementTable();
                resetUserForm();
            }

            function resetUserForm() {
                userForm.reset();
                userFormTitle.textContent = 'เพิ่มผู้ใช้ใหม่';
                document.getElementById('user-form-mode').value = 'add';
                const usernameInput = document.getElementById('user-form-username');
                usernameInput.readOnly = false;
                document.getElementById('user-form-password').placeholder = 'รหัสผ่าน';
            }

            // --- Host Template Management ---
            function populateTemplateControls() {
                const selectedTemplate = templateEditorSelector.value;
                const settings = templateSettings[selectedTemplate];
                if (!settings) return;

                const controlsContainer = document.getElementById('template-controls');
                controlsContainer.innerHTML = ''; // Clear existing controls

                const elementsToControl = settings.details 
                    ? ['desc', 'details', 'price', 'sku'] 
                    : ['desc', 'price', 'sku'];

                elementsToControl.forEach(el => {
                    const elSettings = settings[el];
                    const elName = el.charAt(0).toUpperCase() + el.slice(1);
                    const controlHtml = `
                        <div class="border border-secondary p-2 rounded-lg">
                            <p class="font-semibold text-gray-300">${elName}</p>
                            <div class="grid grid-cols-2 gap-2 mt-1">
                                <div><label class="text-xs text-gray-400">Size (px)</label><input type="number" data-element="${el}" data-style="size" value="${elSettings.size}" class="w-full bg-gray-900 p-1 rounded"></div>
                                <div><label class="text-xs text-gray-400">Color</label><input type="color" data-element="${el}" data-style="color" value="${elSettings.color}" class="w-full h-8 bg-gray-900 p-0 rounded"></div>
                                <div><label class="text-xs text-gray-400">Margin Top (px)</label><input type="number" data-element="${el}" data-style="marginTop" value="${elSettings.marginTop}" class="w-full bg-gray-900 p-1 rounded"></div>
                            </div>
                        </div>
                    `;
                    controlsContainer.innerHTML += controlHtml;
                });

                updateTemplateLivePreview();
            }

            function updateTemplateLivePreview() {
                const selectedTemplate = templateEditorSelector.value;
                const liveSettings = JSON.parse(JSON.stringify(templateSettings[selectedTemplate]));
                
                document.querySelectorAll('#template-controls input').forEach(input => {
                    const el = input.dataset.element;
                    const style = input.dataset.style;
                    if (el && style && liveSettings[el]) {
                        liveSettings[el][style] = input.type === 'number' ? parseInt(input.value) : input.value;
                    }
                });

                const sampleSku = allSkus[0] || {sku: 'SAMPLE-01', description: 'Sample Product', details: '• Feature 1\n• Feature 2', cost: 50, normal_price: 100, promo_price: 80};
                const previewContainer = document.createElement('div');
                previewContainer.style.transform = 'scale(0.5)';
                previewContainer.style.transformOrigin = 'top left';
                renderPriceTag(previewContainer, sampleSku, selectedTemplate, liveSettings);
                templateLivePreview.innerHTML = '';
                templateLivePreview.appendChild(previewContainer);
            }

            function saveCurrentTemplateSettings() {
                const selectedTemplate = templateEditorSelector.value;
                const newSettings = { ...templateSettings[selectedTemplate] };

                document.querySelectorAll('#template-controls input').forEach(input => {
                    const el = input.dataset.element;
                    const style = input.dataset.style;
                    if (el && style) {
                        newSettings[el][style] = input.type === 'number' ? parseInt(input.value) : input.value;
                    }
                });
                templateSettings[selectedTemplate] = newSettings;
                saveTemplateSettings();
                logAction(`Updated template: ${selectedTemplate}`);
                alert('บันทึกการตั้งค่าเทมเพลตสำเร็จ!');
            }

            function handleAddTemplate() {
                const newName = newTemplateNameInput.value.trim();
                const file = templateUploadInput.files[0];

                if (!newName) {
                    alert('กรุณาใส่ชื่อสำหรับเทมเพลตใหม่');
                    return;
                }
                if (templateSettings[newName]) {
                    alert('ชื่อเทมเพลตนี้มีอยู่แล้ว');
                    return;
                }
                if (!file) {
                    alert('กรุณาเลือกไฟล์รูปภาพสำหรับพื้นหลัง');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const baseSettings = templateSettings[templateEditorSelector.value] || defaultTemplateSettings['A6'];
                    templateSettings[newName] = {
                        ...JSON.parse(JSON.stringify(baseSettings)), // Deep copy base settings
                        backgroundImage: e.target.result
                    };
                    saveTemplateSettings();
                    populateTemplateSelectors();
                    newTemplateNameInput.value = '';
                    templateUploadInput.value = '';
                    logAction(`Added new template: ${newName}`);
                    alert(`เพิ่มเทมเพลต '${newName}' สำเร็จ!`);
                };
                reader.readAsDataURL(file);
            }

            // --- Data Editor ---
            function openDataEditor() {
                editDataTableBody.innerHTML = ''; // Clear previous data
                allSkus.forEach((sku, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-secondary';
                    row.dataset.index = index;
                    row.innerHTML = `
                        <td class="p-1">${sku.sku}</td>
                        <td class="p-1"><input type="text" value="${sku.description}" data-key="description" class="w-full bg-gray-800 p-1 rounded"></td>
                        <td class="p-1"><input type="number" value="${sku.cost}" data-key="cost" class="w-24 bg-gray-800 p-1 rounded"></td>
                        <td class="p-1"><input type="number" value="${sku.normal_price}" data-key="normal_price" class="w-24 bg-gray-800 p-1 rounded"></td>
                        <td class="p-1"><input type="number" value="${sku.promo_price}" data-key="promo_price" class="w-24 bg-gray-800 p-1 rounded"></td>
                        <td class="p-1"><input type="text" value="${sku.expire_date || ''}" data-key="expire_date" class="w-24 bg-gray-800 p-1 rounded"></td>
                        <td class="p-1"><input type="number" value="${sku.marketplace_price}" data-key="marketplace_price" class="w-24 bg-gray-800 p-1 rounded"></td>
                        <td class="p-1"><input type="number" value="${sku.dealer_price_t1}" data-key="dealer_price_t1" class="w-24 bg-gray-800 p-1 rounded"></td>
                        <td class="p-1"><input type="number" value="${sku.dealer_price_t2}" data-key="dealer_price_t2" class="w-24 bg-gray-800 p-1 rounded"></td>
                        <td class="p-1"><input type="number" value="${sku.dealer_price_t3}" data-key="dealer_price_t3" class="w-24 bg-gray-800 p-1 rounded"></td>
                    `;
                    editDataTableBody.appendChild(row);
                });
                editDataModal.style.display = 'block';
            }

            function saveEditedData() {
                const rows = editDataTableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const index = parseInt(row.dataset.index);
                    if (!isNaN(index) && allSkus[index]) {
                        row.querySelectorAll('input').forEach(input => {
                            const key = input.dataset.key;
                            const value = input.type === 'number' ? parseFloat(input.value) || 0 : input.value;
                            allSkus[index][key] = value;
                        });
                        // Recalculate GPs
                        const sku = allSkus[index];
                        sku.market_gp = calculateGP(sku.marketplace_price, sku.cost);
                        sku.dealer_gp_t1 = calculateGP(sku.dealer_price_t1, sku.cost);
                        sku.dealer_gp_t2 = calculateGP(sku.dealer_price_t2, sku.cost);
                        sku.dealer_gp_t3 = calculateGP(sku.dealer_price_t3, sku.cost);
                    }
                });
                localStorage.setItem('price_data', JSON.stringify(allSkus));
                logAction('Saved all product data edits');
                alert('บันทึกข้อมูลสินค้าทั้งหมดสำเร็จ!');
                editDataModal.style.display = 'none';
                applyFilters(); // Refresh main table
            }


            // --- Logging ---
            function logAction(action) {
                let logs = JSON.parse(localStorage.getItem('app_logs')) || [];
                const timestamp = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
                logs.unshift({
                    user: currentUser ? currentUser.username : 'System',
                    action: action,
                    timestamp: timestamp
                });
                if (logs.length > 100) logs.pop();
                localStorage.setItem('app_logs', JSON.stringify(logs));
            }

            function loadLogs() {
                const logs = JSON.parse(localStorage.getItem('app_logs')) || [];
                logViewer.value = logs.map(log => `[${log.timestamp}] ${log.user}: ${log.action}`).join('\n');
            }

            function exportLogs() {
                const logs = JSON.parse(localStorage.getItem('app_logs')) || [];
                if (logs.length === 0) {
                    alert('ไม่มีประวัติการใช้งานให้ส่งออก');
                    return;
                }
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "Timestamp,User,Action\n"
                    + logs.map(l => `"${l.timestamp}","${l.user}","${l.action}"`).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "app_logs.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- Utility Functions ---
            function formatCurrency(num) {
                if (isNaN(num) || num === null) return 'N/A';
                return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(num).replace('฿', '') + '.-';
            }
            
            function formatPercent(num) {
                if (isNaN(num) || num === null || !isFinite(num)) return '-';
                return `${(num * 100).toFixed(0)}%`;
            }

            // --- Run Application ---
            init();
        });
    </script>
</body>
</html>
" and am asking a query about/based on this code below.
Instructions to follow:
  * Don't output/edit the document if the query is Direct/Simple. For example, if the query asks for a simple explanation, output a direct answer.
  * Make sure to **edit** the document if the query shows the intent of editing the document, in which case output the entire edited document, **not just that section or the edits**.
    * Don't output the same document/empty document and say that you have edited it.
    * Don't change unrelated code in the document.
  * Don't output  and  in your final response.
  * Any references like "this" or "selected code" refers to the code between  and  tags.
  * Just acknowledge my request in the introduction.
  * Make sure to refer to the document as "Canvas" in your response.

Please make the following updates:

It seems that in the template editing section, the Host still cannot make the changes I requested:
“In the template editing page, besides font size, it should also be possible to change the font color and the text margin from the edges.”
Update the UI of the Admin Control Panel menu to be separated into buttons as follows:
Manage Data
Manage Logo
Dealer Settings
User Management
Template Management + Add New Template (combined into one menu)
Usage History

This will make it easier to use. Also, change the label from “แผงดูแลผู้ควบคุม” to “Settings”.
In the product editing page, please add the Expire Date column and make sure it’s linked to the price tag output.
For the “Filter by Expiry Date” option, allow it to be selected as a period range (e.g., 08-01-2025 to 08-31-2025).
On the “Price Tag Preview” page, after selecting a template, display the actual preview immediately. Also, allow users to select the number of tags they want to print directly on this page without having to press Enter first. Please design this UI to be as user-friendly as possible.
And it seems that printing price tags is still not working — please check thoroughly and fix 
