<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Tag Management</title>
    
    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (xlsx) from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- XlsxPopulate from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>
    
    <!-- Google Fonts: Kanit and Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to apply the chosen fonts and theme */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #1a1a1a; /* 80% black/dark gray */
            color: #e5e7eb; /* Light gray for better contrast */
        }
        .font-prompt {
            font-family: 'Prompt', sans-serif;
        }
        .bg-dark-gray { background-color: #1a1a1a; }
        .bg-secondary-dark { background-color: #2d2d2d; }
        .border-gray-700 { border-color: #4a4a4a; }
        .text-red-accent { color: #ef4444; }
        .bg-red-accent { background-color: #ef4444; }
        
        .btn {
            @apply py-2 px-4 rounded-lg font-bold transition-transform transform hover:scale-105 border border-transparent;
        }
        .btn-primary {
            @apply bg-red-accent text-white border-red-500;
        }
        .btn-secondary {
            @apply bg-gray-600 text-white border-gray-500;
        }
        .input-field {
            @apply bg-secondary-dark border border-gray-700 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-red-accent;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Custom modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
        
        /* Print-specific styles */
        @media print {
            body, html {
                background-color: white !important;
            }
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            @page {
                size: A4;
                margin: 0;
            }
        }
    </style>
</head>
<body class="bg-dark-gray text-gray-200">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-secondary-dark p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center mb-6 text-red-accent">Price Tag Login</h1>
            <div class="space-y-4">
                <input id="username" type="text" placeholder="Username" class="input-field">
                <input id="password" type="password" placeholder="Password" class="input-field">
                <button id="login-btn" class="btn btn-primary w-full">Login</button>
            </div>
            <p id="login-error" class="text-red-500 text-center mt-4"></p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="bg-secondary-dark p-4 flex justify-between items-center shadow-md">
            <div class="flex items-center space-x-4">
                <img id="header-logo" src="" alt="Logo" class="h-10 hidden">
                <h1 class="text-2xl font-bold">Price Tag Management</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="welcome-user" class="font-semibold"></span>
                <button id="settings-btn" class="btn btn-secondary no-print">Settings</button>
                <button id="logout-btn" class="btn btn-primary no-print">Logout</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 md:p-8">
            <!-- Search and Filter -->
            <div class="bg-secondary-dark p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="search-input" class="block text-sm font-medium mb-1">Search (SKU / Product Name)</label>
                        <input type="text" id="search-input" placeholder="Enter SKU or Product Name..." class="input-field text-xl p-3">
                    </div>
                    <div>
                        <label for="channel-select" class="block text-sm font-medium mb-1">Channel</label>
                        <select id="channel-select" class="input-field">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                     <div id="dealer-tier-container" class="hidden">
                        <label for="dealer-tier-select" class="block text-sm font-medium mb-1">Dealer Tier</label>
                        <select id="dealer-tier-select" class="input-field">
                            <option value="1">Tier 1</option>
                            <option value="2">Tier 2</option>
                            <option value="3">Tier 3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Filter by Expiry Date</label>
                        <div class="flex space-x-2 bg-secondary-dark border border-gray-700 rounded-lg p-1">
                            <input type="date" id="start-date-filter" class="input-field border-0 bg-transparent">
                            <input type="date" id="end-date-filter" class="input-field border-0 bg-transparent">
                        </div>
                    </div>
                    <div class="flex space-x-2 justify-end">
                        <button id="clear-filters-btn" class="btn btn-secondary w-full md:w-auto">Clear</button>
                        <button id="print-selection-btn" class="btn btn-primary w-full md:w-auto">Print</button>
                    </div>
                </div>
            </div>

            <!-- Product Table -->
            <div class="bg-secondary-dark rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-800">
                            <tr>
                                <th class="p-3"><input type="checkbox" id="select-all-checkbox" class="rounded"></th>
                                <th class="p-3">SKU</th>
                                <th class="p-3">Description</th>
                                <th class="p-3">Details</th>
                                <th class="p-3" id="costs-header">Costs</th>
                                <th class="p-3">Price</th>
                                <th class="p-3" id="expires-header">Expires Date</th>
                                <th class="p-3">GP%</th>
                                <th class="p-3" id="actions-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
                 <div id="pagination-controls" class="p-4 flex justify-between items-center">
                    <!-- Pagination will be populated by JS -->
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Panel (Modal) -->
    <div id="settings-panel" class="hidden fixed inset-0 bg-modal-backdrop z-40">
        <div class="flex h-full">
            <div class="bg-secondary-dark w-64 p-4 space-y-2 flex flex-col">
                <h2 class="text-xl font-bold mb-4 text-red-accent">Settings</h2>
                <div id="settings-nav-menu">
                    <!-- Nav buttons populated by JS -->
                </div>
                <button id="close-settings-btn" class="btn btn-primary mt-auto w-full">Close</button>
            </div>
            <div class="bg-dark-gray flex-1 p-8 overflow-y-auto">
                <div id="settings-content">
                    <!-- Content will be populated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="hidden fixed inset-0 bg-modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-secondary-dark p-8 rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6 text-red-accent">Edit Product</h2>
            <form id="edit-product-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="edit-product-id">
                    <div><label>SKU</label><input type="text" id="edit-sku" class="input-field"></div>
                    <div><label>Description</label><input type="text" id="edit-description" class="input-field"></div>
                    <div class="md:col-span-2"><label>Details</label><textarea id="edit-details" class="input-field" rows="4"></textarea></div>
                    <div><label>Costs</label><input type="number" step="0.01" id="edit-costs" class="input-field"></div>
                    <div><label>Normal Price</label><input type="number" step="0.01" id="edit-normal-price" class="input-field"></div>
                    <div><label>Promotion Price</label><input type="number" step="0.01" id="edit-promo-price" class="input-field"></div>
                    <div><label>Expires Date</label><input type="date" id="edit-expires-date" class="input-field"></div>
                    <div><label>Marketplace Price</label><input type="number" step="0.01" id="edit-marketplace-price" class="input-field"></div>
                    <div><label>Dealer Price Tier 1</label><input type="number" step="0.01" id="edit-dealer-t1" class="input-field"></div>
                    <div><label>Dealer Price Tier 2</label><input type="number" step="0.01" id="edit-dealer-t2" class="input-field"></div>
                    <div><label>Dealer Price Tier 3</label><input type="number" step="0.01" id="edit-dealer-t3" class="input-field"></div>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Print Selection Modal -->
    <div id="print-selection-modal" class="hidden fixed inset-0 bg-modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-secondary-dark p-6 rounded-lg shadow-lg w-full max-w-7xl h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-red-accent">Print Price Tags</h2>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden">
                <!-- Left Side: Item List & Controls -->
                <div class="flex flex-col bg-dark-gray p-4 rounded-lg">
                    <div class="flex items-center mb-4 space-x-4">
                        <label for="template-select" class="font-bold whitespace-nowrap">Select Template:</label>
                        <select id="template-select" class="input-field w-full"></select>
                    </div>
                    <p class="text-sm text-gray-400 mb-2">Adjust quantity for each item:</p>
                    <div id="print-item-list" class="flex-grow overflow-y-auto space-y-2 pr-2 no-scrollbar">
                        <!-- Print items will be populated by JS -->
                    </div>
                </div>
                <!-- Right Side: Live Preview -->
                <div class="flex flex-col">
                    <h3 class="font-bold mb-2 text-center">Live Preview</h3>
                    <div id="print-preview-area" class="bg-black p-4 rounded-lg overflow-auto flex-grow flex items-center justify-center">
                        <!-- Live preview will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" id="cancel-print-btn" class="btn btn-secondary">Cancel</button>
                <button type="button" id="open-print-page-btn" class="btn btn-primary">Open Print Page</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-modal-backdrop z-50 flex items-center justify-center">
        <div class="bg-secondary-dark p-6 rounded-lg shadow-lg text-center">
            <p id="confirmation-message" class="mb-4">Are you sure?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-no-btn" class="btn btn-secondary">No</button>
                <button id="confirm-yes-btn" class="btn btn-primary">Yes</button>
            </div>
        </div>
    </div>

    <!-- This div is for the final print output, normally hidden -->
    <div id="print-area" class="hidden"></div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {

    // #################################################################
    // #                     STATE MANAGEMENT & DATA                   #
    // #################################################################

    // Hardcoded user data
    const users = {
        host: { password: 'proplugin123', role: 'Host', channels: ['all'] },
        admin: { password: 'password', role: 'Admin', channels: ['all'] },
        user1: { password: 'password', role: 'User', channels: ['Flagship'] },
        user2: { password: 'password', role: 'User', channels: ['Flagship'] },
        dealer_user: { password: 'password', role: 'Read-Only', channels: ['Dealer'] },
        marketplace: { password: 'password', role: 'Read-Only', channels: ['Marketplace'] },
    };

    // Application state
    let state = {
        currentUser: null,
        products: [],
        filteredProducts: [],
        selectedProducts: new Set(),
        currentPage: 1,
        itemsPerPage: 10,
        logo: localStorage.getItem('companyLogo') || '',
        templates: JSON.parse(localStorage.getItem('customTemplates')) || [],
        usageLog: JSON.parse(localStorage.getItem('usageLog')) || [],
    };
    
    const defaultTemplates = [
        { id: 'a4', name: 'A4 (1 per sheet)', isDefault: true, layout: { type: 'a4', items: 1 } },
        { id: 'a5', name: 'A5 (2 per sheet)', isDefault: true, layout: { type: 'a5', items: 2 } },
        { id: 'a6', name: 'A6 (4 per sheet)', isDefault: true, layout: { type: 'a6', items: 4 } },
        { id: 'acc', name: 'Accessories Tag (12 per sheet)', isDefault: true, layout: { type: 'acc', items: 12 } },
    ];

    // Channels available in the app
    const channels = ['Flagship', 'Marketplace', 'Dealer'];

    // #################################################################
    // #                         UI SELECTORS                          #
    // #################################################################

    // Login
    const loginScreen = document.getElementById('login-screen');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');

    // Main App
    const appScreen = document.getElementById('app');
    const headerLogo = document.getElementById('header-logo');
    const welcomeUser = document.getElementById('welcome-user');
    const settingsBtn = document.getElementById('settings-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const searchInput = document.getElementById('search-input');
    const channelSelect = document.getElementById('channel-select');
    const dealerTierContainer = document.getElementById('dealer-tier-container');
    const dealerTierSelect = document.getElementById('dealer-tier-select');
    const startDateFilter = document.getElementById('start-date-filter');
    const endDateFilter = document.getElementById('end-date-filter');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const productTableBody = document.getElementById('product-table-body');
    const costsHeader = document.getElementById('costs-header');
    const expiresHeader = document.getElementById('expires-header');
    const actionsHeader = document.getElementById('actions-header');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const printSelectionBtn = document.getElementById('print-selection-btn');
    const paginationControls = document.getElementById('pagination-controls');

    // Settings Panel
    const settingsPanel = document.getElementById('settings-panel');
    const settingsNavMenu = document.getElementById('settings-nav-menu');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const settingsContent = document.getElementById('settings-content');

    // Edit Modal
    const editProductModal = document.getElementById('edit-product-modal');
    const editProductForm = document.getElementById('edit-product-form');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    
    // Print Modal
    const printSelectionModal = document.getElementById('print-selection-modal');
    const templateSelect = document.getElementById('template-select');
    const printItemList = document.getElementById('print-item-list');
    const printPreviewArea = document.getElementById('print-preview-area');
    const cancelPrintBtn = document.getElementById('cancel-print-btn');
    const openPrintPageBtn = document.getElementById('open-print-page-btn');

    // Confirmation Modal
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmationMessage = document.getElementById('confirmation-message');
    const confirmYesBtn = document.getElementById('confirm-yes-btn');
    const confirmNoBtn = document.getElementById('confirm-no-btn');

    // #################################################################
    // #                      UTILITY FUNCTIONS                        #
    // #################################################################

    const saveState = () => {
        localStorage.setItem('products', JSON.stringify(state.products));
        localStorage.setItem('companyLogo', state.logo);
        localStorage.setItem('customTemplates', JSON.stringify(state.templates));
        localStorage.setItem('usageLog', JSON.stringify(state.usageLog));
    };

    const loadState = () => {
        const products = localStorage.getItem('products');
        if (products) {
            state.products = JSON.parse(products);
        }
        state.filteredProducts = state.products;
    };
    
    const logAction = (action, details = {}) => {
        state.usageLog.unshift({
            user: state.currentUser.username,
            role: state.currentUser.role,
            action,
            details,
            timestamp: new Date().toISOString(),
        });
        if (state.usageLog.length > 200) {
            state.usageLog.pop();
        }
        saveState();
    };

    const calculateGP = (price, cost) => {
        if (cost === 0 || !price || !cost) return 0;
        return ((price - cost) / cost * 100).toFixed(2);
    };
    
    const formatCurrency = (value) => {
        if (isNaN(value) || value === null) return '-';
        return Number(value).toLocaleString('th-TH');
    };

    const showConfirmation = (message, onConfirm) => {
        confirmationMessage.textContent = message;
        confirmationModal.classList.remove('hidden');
        
        const yesHandler = () => {
            onConfirm();
            hideConfirmation();
            confirmYesBtn.removeEventListener('click', yesHandler);
            confirmNoBtn.removeEventListener('click', noHandler);
        };
        
        const noHandler = () => {
            hideConfirmation();
            confirmYesBtn.removeEventListener('click', yesHandler);
            confirmNoBtn.removeEventListener('click', noHandler);
        };

        confirmYesBtn.addEventListener('click', yesHandler);
        confirmNoBtn.addEventListener('click', noHandler);
    };

    const hideConfirmation = () => {
        confirmationModal.classList.add('hidden');
    };

    // #################################################################
    // #                    AUTHENTICATION & ROLES                     #
    // #################################################################

    const handleLogin = () => {
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        const user = users[username];

        if (user && user.password === password) {
            state.currentUser = { username, ...user };
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            logAction('Login');
            initApp();
        } else {
            loginError.textContent = 'Invalid username or password.';
        }
    };

    const handleLogout = () => {
        logAction('Logout');
        state.currentUser = null;
        appScreen.classList.add('hidden');
        loginScreen.classList.remove('hidden');
        usernameInput.value = '';
        passwordInput.value = '';
        loginError.textContent = '';
    };

    const checkPermissions = (permission) => {
        if (!state.currentUser) return false;
        const role = state.currentUser.role;
        const permissionsMap = {
            Host: ['viewCosts', 'deleteSKU', 'editData', 'manageData', 'dealerSettings', 'manageLogo', 'templateManagement', 'usageHistory', 'userManagement', 'viewSettings', 'canPrint'],
            Admin: ['viewCosts', 'deleteSKU', 'editData', 'manageData', 'dealerSettings', 'viewSettings', 'canPrint'],
            User: ['canPrint'],
            'Read-Only': []
        };
        return permissionsMap[role]?.includes(permission) || false;
    };
    
    // #################################################################
    // #                         UI RENDERING                          #
    // #################################################################
    
    const renderTable = () => {
        productTableBody.innerHTML = '';
        if (state.filteredProducts.length === 0) {
            const colspan = actionsHeader.style.display === 'none' ? 8 : 9;
            productTableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-8">No products found.</td></tr>`;
            renderPagination();
            return;
        }

        const startIndex = (state.currentPage - 1) * state.itemsPerPage;
        const endIndex = startIndex + state.itemsPerPage;
        const paginatedProducts = state.filteredProducts.slice(startIndex, endIndex);

        paginatedProducts.forEach(product => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-700 hover:bg-gray-700';
            
            const selectedChannel = channelSelect.value;
            let price, gp;

            switch (selectedChannel) {
                case 'Flagship':
                    price = product.promoPrice;
                    gp = product.promoGP;
                    break;
                case 'Marketplace':
                    price = product.marketplacePrice;
                    gp = product.marketplaceGP;
                    break;
                case 'Dealer':
                    const tier = dealerTierSelect.value;
                    price = product[`dealerT${tier}`];
                    gp = product[`gpT${tier}`];
                    break;
                default:
                    price = product.normalPrice;
                    gp = calculateGP(product.normalPrice, product.costs);
            }

            tr.innerHTML = `
                <td class="p-3"><input type="checkbox" class="product-checkbox rounded" data-sku="${product.sku}" ${state.selectedProducts.has(product.sku) ? 'checked' : ''}></td>
                <td class="p-3">${product.sku}</td>
                <td class="p-3">${product.description}</td>
                <td class="p-3 whitespace-pre-wrap text-sm">${product.details || ''}</td>
                ${checkPermissions('viewCosts') ? `<td class="p-3">${formatCurrency(product.costs)}</td>` : ''}
                <td class="p-3 font-bold text-lg">${formatCurrency(price)}.-</td>
                ${selectedChannel === 'Flagship' ? `<td class="p-3">${product.expiresDate || ''}</td>` : ''}
                <td class="p-3">${gp}%</td>
                ${checkPermissions('editData') ? `
                <td class="p-3">
                    <div class="flex items-center space-x-2">
                        <button class="edit-btn p-1 hover:bg-gray-600 rounded-md" data-sku="${product.sku}">✏️</button>
                        ${checkPermissions('deleteSKU') ? `<button class="delete-btn text-red-500 p-1 hover:bg-gray-600 rounded-md" data-sku="${product.sku}">❌</button>` : ''}
                    </div>
                </td>` : ''}
            `;
            productTableBody.appendChild(tr);
        });
        
        updateTableHeaders();
        renderPagination();
        updateSelectAllCheckboxState();
    };
    
    const renderPagination = () => {
        paginationControls.innerHTML = '';
        const totalPages = Math.ceil(state.filteredProducts.length / state.itemsPerPage);
        if (totalPages <= 1) return;

        let paginationHTML = `<div class="text-sm">Page ${state.currentPage} of ${totalPages}</div>`;
        paginationHTML += `<div class="flex space-x-1">`;
        
        paginationHTML += `<button class="px-3 py-1 rounded-lg ${state.currentPage === 1 ? 'bg-gray-700 cursor-not-allowed' : 'bg-gray-600 hover:bg-red-accent'}" ${state.currentPage === 1 ? 'disabled' : ''} data-page="${state.currentPage - 1}">&laquo;</button>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === state.currentPage) {
                paginationHTML += `<button class="px-3 py-1 rounded-lg bg-red-accent" data-page="${i}">${i}</button>`;
            } else if (i <= 2 || i >= totalPages -1 || (i >= state.currentPage - 1 && i <= state.currentPage + 1)) {
                 paginationHTML += `<button class="px-3 py-1 rounded-lg bg-gray-600 hover:bg-red-accent" data-page="${i}">${i}</button>`;
            } else if (i === 3 && state.currentPage > 4) {
                 paginationHTML += `<span class="px-3 py-1">...</span>`;
            } else if (i === totalPages - 2 && state.currentPage < totalPages - 3) {
                 paginationHTML += `<span class="px-3 py-1">...</span>`;
            }
        }
        
        paginationHTML += `<button class="px-3 py-1 rounded-lg ${state.currentPage === totalPages ? 'bg-gray-700 cursor-not-allowed' : 'bg-gray-600 hover:bg-red-accent'}" ${state.currentPage === totalPages ? 'disabled' : ''} data-page="${state.currentPage + 1}">&raquo;</button>`;
        
        paginationHTML += `</div>`;
        paginationControls.innerHTML = paginationHTML;
    };

    const updateTableHeaders = () => {
        const showCosts = checkPermissions('viewCosts');
        const showActions = checkPermissions('editData');
        const showExpires = channelSelect.value === 'Flagship';

        costsHeader.style.display = showCosts ? '' : 'none';
        actionsHeader.style.display = showActions ? '' : 'none';
        expiresHeader.style.display = showExpires ? '' : 'none';

        // Hide/show columns for all rows
        document.querySelectorAll('#product-table-body tr').forEach(row => {
            if(row.children.length > 4) { // check if it's a data row
                if(showCosts) row.children[4].style.display = ''; else row.children[4].style.display = 'none';
                if(showExpires) row.children[6].style.display = ''; else row.children[6].style.display = 'none';
                if(showActions) row.children[8].style.display = ''; else row.children[8].style.display = 'none';
            }
        });
    };

    const updateSelectAllCheckboxState = () => {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        const allVisibleChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        selectAllCheckbox.checked = allVisibleChecked;
    };

    // #################################################################
    // #                       DATA FILTERING                          #
    // #################################################################

    const filterAndRender = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const channel = channelSelect.value;
        const startDate = startDateFilter.value;
        const endDate = endDateFilter.value;

        dealerTierContainer.classList.toggle('hidden', channel !== 'Dealer');

        state.filteredProducts = state.products.filter(p => {
            const matchesSearch = p.sku.toLowerCase().includes(searchTerm) || p.description.toLowerCase().includes(searchTerm);
            
            let matchesDate = true;
            if (channel === 'Flagship' && (startDate || endDate)) {
                if (!p.expiresDate) {
                    matchesDate = false;
                } else {
                    const expiry = new Date(p.expiresDate);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if(start && expiry < start) matchesDate = false;
                    if(end && expiry > end) matchesDate = false;
                }
            }

            return matchesSearch && matchesDate;
        });
        
        state.currentPage = 1;
        renderTable();
    };

    // #################################################################
    // #                     DATA IMPORT & EXPORT                      #
    // #################################################################

    const handleFileUpload = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                
                processImportedData(json);
                logAction('Import Data', { fileName: file.name, count: json.length });
                filterAndRender();
                saveState();
                alert('Data imported successfully!');
            } catch (error) {
                alert('Failed to import file. Please ensure it is a valid Excel file and the format is correct.');
                console.error("Import error:", error);
            }
        };
        reader.readAsArrayBuffer(file);
    };
    
    const processImportedData = (data) => {
        const newProducts = data.map(row => {
            const costs = parseFloat(row['Costs']);
            const normalPrice = parseFloat(row['Normal Price']);
            const promoPrice = parseFloat(row['Promotion Price']);
            const marketplacePrice = parseFloat(row['Marketplace Price']);
            const dealerT1 = parseFloat(row['Dealer Price Tier 1']);
            const dealerT2 = parseFloat(row['Dealer Price Tier 2']);
            const dealerT3 = parseFloat(row['Dealer Price Tier 3']);

            return {
                sku: row['SKU']?.toString() || '',
                description: row['Description']?.toString() || '',
                details: row['Details']?.toString() || '',
                costs: isNaN(costs) ? 0 : costs,
                normalPrice: isNaN(normalPrice) ? 0 : normalPrice,
                promoPrice: isNaN(promoPrice) ? 0 : promoPrice,
                expiresDate: row['Expires Date'] ? excelDateToJSDate(row['Expires Date']) : '',
                marketplacePrice: isNaN(marketplacePrice) ? 0 : marketplacePrice,
                dealerT1: isNaN(dealerT1) ? 0 : dealerT1,
                dealerT2: isNaN(dealerT2) ? 0 : dealerT2,
                dealerT3: isNaN(dealerT3) ? 0 : dealerT3,
                promoGP: calculateGP(promoPrice, costs),
                marketplaceGP: calculateGP(marketplacePrice, costs),
                gpT1: calculateGP(dealerT1, costs),
                gpT2: calculateGP(dealerT2, costs),
                gpT3: calculateGP(dealerT3, costs),
            };
        });
        state.products = newProducts;
    };
    
    const excelDateToJSDate = (serial) => {
        if (typeof serial === 'string') return serial;
        if (typeof serial !== 'number') return '';
        const date = XLSX.SSF.parse_date_code(serial);
        // Format to YYYY-MM-DD
        return `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
    };

    const handleExportData = async () => {
        const dataToExport = state.products.map(p => ({
            'SKU': p.sku, 'Description': p.description, 'Details': p.details, 'Costs': p.costs,
            'Normal Price': p.normalPrice, 'Promotion Price': p.promoPrice, 'Expires Date': p.expiresDate,
            'Marketplace Price': p.marketplacePrice, 'Marketplace GP%': p.marketplaceGP,
            'Dealer Price Tier 1': p.dealerT1, 'GP% T1': p.gpT1,
            'Dealer Price Tier 2': p.dealerT2, 'GP% T2': p.gpT2,
            'Dealer Price Tier 3': p.dealerT3, 'GP% T3': p.gpT3,
        }));

        try {
            const workbook = await XlsxPopulate.fromBlankAsync();
            const sheet = workbook.sheet(0);
            
            const headers = Object.keys(dataToExport[0]);
            sheet.cell("A1").value([headers]);
            sheet.range("A1", `${String.fromCharCode(65 + headers.length - 1)}1`).style("bold", true);

            dataToExport.forEach((row, index) => {
                const rowIndex = index + 2;
                sheet.cell(`D${rowIndex}`).style("fill", "c5e0b4"); // Costs - Light green
                sheet.cell(`F${rowIndex}`).style("fill", "ffff00"); // Promo Price - Yellow
                sheet.cell(`G${rowIndex}`).style("fill", "ffff00"); // Expires - Yellow
                Object.values(row).forEach((value, colIndex) => {
                    sheet.cell(rowIndex, colIndex + 1).value(value);
                });
            });
            
            headers.forEach((h, i) => sheet.column(i + 1).width(h.toLowerCase().includes('description') ? 40 : (h.toLowerCase().includes('details') ? 50 : 20)));

            const blob = await workbook.outputAsync();
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `price_data_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
            logAction('Export Data', { count: dataToExport.length });

        } catch (err) {
            console.error("Error exporting data:", err);
            alert("Failed to export data.");
        }
    };
    
    // #################################################################
    // #                     PRODUCT CRUD ACTIONS                      #
    // #################################################################
    
    const handleDeleteSKU = (sku) => {
        showConfirmation(`Are you sure you want to delete SKU: ${sku}? This cannot be undone.`, () => {
            state.products = state.products.filter(p => p.sku !== sku);
            state.selectedProducts.delete(sku);
            logAction('Delete SKU', { sku });
            saveState();
            filterAndRender();
        });
    };

    const showEditModal = (sku) => {
        const product = state.products.find(p => p.sku === sku);
        if (!product) return;
        
        document.getElementById('edit-product-id').value = product.sku;
        document.getElementById('edit-sku').value = product.sku;
        document.getElementById('edit-description').value = product.description;
        document.getElementById('edit-details').value = product.details;
        document.getElementById('edit-costs').value = product.costs;
        document.getElementById('edit-normal-price').value = product.normalPrice;
        document.getElementById('edit-promo-price').value = product.promoPrice;
        document.getElementById('edit-expires-date').value = product.expiresDate;
        document.getElementById('edit-marketplace-price').value = product.marketplacePrice;
        document.getElementById('edit-dealer-t1').value = product.dealerT1;
        document.getElementById('edit-dealer-t2').value = product.dealerT2;
        document.getElementById('edit-dealer-t3').value = product.dealerT3;
        
        editProductModal.classList.remove('hidden');
    };
    
    const handleUpdateProduct = (e) => {
        e.preventDefault();
        const originalSku = document.getElementById('edit-product-id').value;
        const productIndex = state.products.findIndex(p => p.sku === originalSku);
        if (productIndex === -1) return;

        const costs = parseFloat(document.getElementById('edit-costs').value);
        const promoPrice = parseFloat(document.getElementById('edit-promo-price').value);
        const marketplacePrice = parseFloat(document.getElementById('edit-marketplace-price').value);
        const dealerT1 = parseFloat(document.getElementById('edit-dealer-t1').value);
        const dealerT2 = parseFloat(document.getElementById('edit-dealer-t2').value);
        const dealerT3 = parseFloat(document.getElementById('edit-dealer-t3').value);

        const updatedProduct = {
            sku: document.getElementById('edit-sku').value,
            description: document.getElementById('edit-description').value,
            details: document.getElementById('edit-details').value,
            costs: costs,
            normalPrice: parseFloat(document.getElementById('edit-normal-price').value),
            promoPrice: promoPrice,
            expiresDate: document.getElementById('edit-expires-date').value,
            marketplacePrice: marketplacePrice,
            dealerT1: dealerT1, dealerT2: dealerT2, dealerT3: dealerT3,
            promoGP: calculateGP(promoPrice, costs),
            marketplaceGP: calculateGP(marketplacePrice, costs),
            gpT1: calculateGP(dealerT1, costs), gpT2: calculateGP(dealerT2, costs), gpT3: calculateGP(dealerT3, costs),
        };
        
        state.products[productIndex] = updatedProduct;
        logAction('Edit SKU', { sku: originalSku, newSku: updatedProduct.sku });
        saveState();
        filterAndRender();
        editProductModal.classList.add('hidden');
    };

    // #################################################################
    // #                        SETTINGS PANEL                         #
    // #################################################################

    const openSettingsPanel = () => {
        renderSettingsNav();
        settingsPanel.classList.remove('hidden');
        const firstBtn = document.querySelector('.settings-nav-btn');
        if (firstBtn) {
            renderSettingsContent(firstBtn.dataset.target);
        }
    };

    const renderSettingsNav = () => {
        const navItems = [
            { target: 'manage-data', label: 'Manage Data', permission: 'manageData' },
            { target: 'manage-logo', label: 'Manage Logo', permission: 'manageLogo' },
            { target: 'dealer-settings', label: 'Dealer Settings', permission: 'dealerSettings' },
            { target: 'user-management', label: 'User Management', permission: 'userManagement' },
            { target: 'template-management', label: 'Template Management', permission: 'templateManagement' },
            { target: 'usage-history', label: 'Usage History', permission: 'usageHistory' }
        ];

        settingsNavMenu.innerHTML = navItems
            .filter(item => checkPermissions(item.permission))
            .map(item => `<button class="settings-nav-btn w-full text-left p-2 rounded-lg hover:bg-gray-700" data-target="${item.target}">${item.label}</button>`)
            .join('');
    };

    const renderSettingsContent = (target) => {
        document.querySelectorAll('.settings-nav-btn').forEach(btn => {
            btn.classList.toggle('bg-red-accent', btn.dataset.target === target);
        });

        settingsContent.innerHTML = '';
        switch (target) {
            case 'manage-data':
                settingsContent.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">Manage Data</h3>
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-bold text-lg mb-2">Import Data</h4>
                            <p class="mb-2 text-gray-400">Import product data from an Excel file (.xlsx). Ensure the columns match the required format.</p>
                            <input type="file" id="import-file-input" accept=".xlsx" class="input-field">
                        </div>
                        <div>
                            <h4 class="font-bold text-lg mb-2">Export Data</h4>
                            <p class="mb-2 text-gray-400">Export all current product data to an Excel file.</p>
                            <button id="export-data-btn" class="btn btn-primary">Export Data</button>
                        </div>
                    </div>
                `;
                document.getElementById('import-file-input').addEventListener('change', handleFileUpload);
                document.getElementById('export-data-btn').addEventListener('click', handleExportData);
                break;
            case 'manage-logo':
                settingsContent.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">Manage Logo</h3>
                    <p class="mb-2 text-gray-400">Upload a company logo (PNG, JPG). It will be displayed on the header and on price tags.</p>
                    <input type="file" id="logo-upload" accept="image/png, image/jpeg" class="input-field mb-4">
                    <div class="mb-4">
                        <p>Current Logo:</p>
                        <div class="mt-2 bg-white p-2 rounded-lg inline-block">
                            <img id="logo-preview" src="${state.logo}" class="max-h-24 ${!state.logo ? 'hidden' : ''}">
                        </div>
                        <p id="no-logo-text" class="${state.logo ? 'hidden' : ''}">No logo uploaded.</p>
                    </div>
                     <button id="remove-logo-btn" class="btn btn-secondary ${!state.logo ? 'hidden' : ''}">Remove Logo</button>
                `;
                document.getElementById('logo-upload').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            state.logo = event.target.result;
                            document.getElementById('logo-preview').src = state.logo;
                            document.getElementById('logo-preview').classList.remove('hidden');
                            document.getElementById('no-logo-text').classList.add('hidden');
                            document.getElementById('remove-logo-btn').classList.remove('hidden');
                            headerLogo.src = state.logo;
                            headerLogo.classList.remove('hidden');
                            logAction('Update Logo');
                            saveState();
                        };
                        reader.readAsDataURL(file);
                    }
                });
                 document.getElementById('remove-logo-btn').addEventListener('click', () => {
                    state.logo = '';
                    document.getElementById('logo-preview').classList.add('hidden');
                    document.getElementById('no-logo-text').classList.remove('hidden');
                    document.getElementById('remove-logo-btn').classList.add('hidden');
                    headerLogo.classList.add('hidden');
                    logAction('Remove Logo');
                    saveState();
                });
                break;
            case 'dealer-settings':
                settingsContent.innerHTML = `<h3 class="text-2xl font-bold mb-4">Dealer Settings</h3><p>Dealer-specific settings can be configured here.</p>`;
                break;
            case 'user-management':
                 settingsContent.innerHTML = `<h3 class="text-2xl font-bold mb-4">User Management</h3><p class="text-gray-400">User roles and permissions are currently hardcoded. This panel shows the current configuration.</p>
                 <div class="mt-4 space-y-2">
                    ${Object.entries(users).map(([username, data]) => `
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <p class="font-bold">${username}</p>
                            <p class="text-sm">Role: <span class="text-red-accent">${data.role}</span></p>
                            <p class="text-sm">Channels: ${data.channels.join(', ')}</p>
                        </div>
                    `).join('')}
                 </div>
                 `;
                break;
            case 'template-management':
                renderTemplateManagement();
                break;
            case 'usage-history':
                settingsContent.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">Usage History</h3>
                    <div class="bg-gray-800 rounded-lg p-1 h-96 overflow-y-auto no-scrollbar">
                        <div class="p-3">
                        ${state.usageLog.map(log => `
                            <div class="border-b border-gray-700 pb-2 mb-2">
                                <p><span class="font-bold">${new Date(log.timestamp).toLocaleString()}</span> - <span class="text-red-accent">${log.user} (${log.role})</span></p>
                                <p class="text-gray-400">${log.action} ${log.details.sku ? `(SKU: ${log.details.sku})` : ''}</p>
                            </div>
                        `).join('')}
                        </div>
                    </div>
                `;
                break;
        }
    };
    
    const renderTemplateManagement = () => {
        const allTemplates = [...defaultTemplates, ...state.templates];
        settingsContent.innerHTML = `
            <h3 class="text-2xl font-bold mb-4">Template Management</h3>
            <p class="mb-4 text-gray-400">Manage default and custom print templates.</p>
            
            <div id="template-list" class="space-y-4 mb-6">
                ${allTemplates.map(t => `
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-lg">${t.name} ${t.isDefault ? '<span class="text-xs text-gray-400">(Default)</span>' : (t.isUploaded ? '<span class="text-xs text-green-400">(Uploaded)</span>' : '')}</h4>
                            ${!t.isDefault ? `
                                <button class="btn bg-red-800 text-white btn-sm delete-template-btn" data-id="${t.id}">Delete</button>
                            ` : ''}
                        </div>
                        ${t.isUploaded ? `<p class="text-sm mt-2 text-gray-400">Uploaded HTML template.</p>` : ''}
                    </div>
                `).join('')}
            </div>
            
            <h4 class="text-xl font-bold mb-2">Upload Custom Template</h4>
            <div class="bg-gray-800 p-4 rounded-lg">
                <p class="text-sm text-gray-400 mb-2">Upload an HTML file as a custom template. Use placeholders like {{SKU}}, {{DESCRIPTION}}, {{PRICE}}, etc., in your HTML file to insert product data.</p>
                <input type="file" id="template-upload-input" accept=".html" class="input-field">
            </div>
        `;

        document.getElementById('template-upload-input').addEventListener('change', handleTemplateUpload);
        document.querySelectorAll('.delete-template-btn').forEach(btn => btn.addEventListener('click', (e) => deleteCustomTemplate(e.currentTarget.dataset.id)));
    };
    
    const handleTemplateUpload = (e) => {
        const file = e.target.files[0];
        if (file && file.type === 'text/html') {
            const reader = new FileReader();
            reader.onload = (event) => {
                const id = `uploaded_${Date.now()}`;
                const newTemplate = {
                    id,
                    name: file.name,
                    isDefault: false,
                    isUploaded: true,
                    htmlContent: event.target.result,
                };
                state.templates.push(newTemplate);
                logAction('Upload Custom Template', { name: file.name });
                saveState();
                renderTemplateManagement();
            };
            reader.readAsText(file);
        } else {
            alert('Please upload a valid .html file.');
        }
    };

    const deleteCustomTemplate = (id) => {
        showConfirmation('Are you sure you want to delete this custom template?', () => {
            const templateName = state.templates.find(t => t.id === id)?.name;
            state.templates = state.templates.filter(t => t.id !== id);
            logAction('Delete Custom Template', { name: templateName });
            saveState();
            renderTemplateManagement();
        });
    };

    // #################################################################
    // #                     PRINTING WORKFLOW                         #
    // #################################################################

    const showPrintSelectionModal = () => {
        if (state.selectedProducts.size === 0) {
            alert('Please select at least one product to print.');
            return;
        }
        
        populateTemplateSelector();
        renderPrintItemList();
        printSelectionModal.classList.remove('hidden');
        updatePrintPreview();
    };
    
    const populateTemplateSelector = () => {
        const allTemplates = [...defaultTemplates, ...state.templates];
        templateSelect.innerHTML = allTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    };

    const renderPrintItemList = () => {
        printItemList.innerHTML = '';
        state.selectedProducts.forEach(sku => {
            const product = state.products.find(p => p.sku === sku);
            if (product) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-secondary-dark p-3 rounded-lg flex justify-between items-center';
                itemDiv.innerHTML = `
                    <div>
                        <p class="font-bold">${product.sku}</p>
                        <p class="text-sm text-gray-400">${product.description}</p>
                    </div>
                    <input type="number" class="print-quantity-input input-field w-20 text-center" data-sku="${sku}" value="1" min="1">
                `;
                printItemList.appendChild(itemDiv);
            }
        });
    };

    const updatePrintPreview = () => {
        printPreviewArea.innerHTML = '';
        const firstSelectedSKU = state.selectedProducts.values().next().value;
        if (!firstSelectedSKU) {
            printPreviewArea.innerHTML = '<p class="text-gray-400">No items selected for preview.</p>';
            return;
        };

        const product = state.products.find(p => p.sku === firstSelectedSKU);
        const templateId = templateSelect.value;
        
        if (product && templateId) {
            const tagHTML = generateTagHTML(product, templateId);
            const container = document.createElement('div');
            container.innerHTML = tagHTML;
            
            let scale = 1.0;
            if (templateId === 'a4') scale = 0.3;
            else if (templateId === 'a5') scale = 0.4;
            else if (templateId === 'a6') scale = 0.6;
            else if (templateId === 'acc') scale = 0.8;

            container.style.transform = `scale(${scale})`;
            container.style.transformOrigin = "center center";
            printPreviewArea.appendChild(container);
        }
    };
    
    const getPriceDataForTag = (product) => {
        const channel = channelSelect.value;
        let price, normalPrice;
        switch (channel) {
            case 'Flagship':
                price = product.promoPrice;
                normalPrice = product.normalPrice;
                break;
            case 'Marketplace':
                price = product.marketplacePrice;
                normalPrice = product.normalPrice;
                break;
            case 'Dealer':
                const tier = dealerTierSelect.value;
                price = product[`dealerT${tier}`];
                normalPrice = product.normalPrice;
                break;
            default:
                price = product.normalPrice;
                normalPrice = null;
        }
        return { price, normalPrice };
    };

    const generateTagHTML = (product, templateId) => {
        const allTemplates = [...defaultTemplates, ...state.templates];
        const template = allTemplates.find(t => t.id === templateId);
        if (!template) return '';
        
        const { price, normalPrice } = getPriceDataForTag(product);
        const useLogo = !!state.logo;

        if (template.isUploaded) {
            let content = template.htmlContent;
            const replacements = {
                '{{SKU}}': product.sku,
                '{{DESCRIPTION}}': product.description,
                '{{DETAILS}}': product.details.replace(/\n/g, '<br>'),
                '{{PRICE}}': `${formatCurrency(price)}.-`,
                '{{NORMAL_PRICE}}': normalPrice && normalPrice > price ? `${formatCurrency(normalPrice)}.-` : '',
                '{{EXPIRES_DATE}}': channelSelect.value === 'Flagship' && product.expiresDate ? `Expire: ${product.expiresDate}` : '',
                '{{LOGO_URL}}': state.logo,
            };
            for (const key in replacements) {
                content = content.replace(new RegExp(key, 'g'), replacements[key]);
            }
            return content;
        }

        switch (template.id) {
            case 'acc':
                return `
                <div class="font-prompt" style="width: 9.5cm; height: 4.61cm; background: black; color: white; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between; font-family: 'Prompt', sans-serif; page-break-inside: avoid;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="font-size: 10pt;">${product.sku}</div>
                        ${useLogo ? `<img src="${state.logo}" style="max-height: 30px; max-width: 80px;">` : ''}
                    </div>
                    <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; overflow: hidden;">
                        <p style="font-size: 16pt; font-weight: bold; line-height: 1.2; margin: 0;">${product.description}</p>
                        <p style="font-size: 11pt; color: #ccc; margin: 5px 0 0 0;">${(product.details || '').split('\n')[0]}</p>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div style="font-size: 10pt;">${channelSelect.value === 'Flagship' && product.expiresDate ? `Expire: ${product.expiresDate}` : ''}</div>
                        <div style="text-align: right;">
                            ${normalPrice && normalPrice > price ? `<p style="font-size: 14pt; text-decoration: line-through; color: #aaa; margin: 0;">${formatCurrency(normalPrice)}.-</p>` : ''}
                            <p style="font-size: 28pt; font-weight: bold; color: #ef4444; margin: 0; line-height: 1;">${formatCurrency(price)}.-</p>
                        </div>
                    </div>
                </div>`;
            
            case 'a4':
            case 'a5':
            case 'a6':
                const dimensions = { a4: 'width: 19cm; height: 27.7cm;', a5: 'width: 12.8cm; height: 19cm;', a6: 'width: 8.5cm; height: 12.8cm;' };
                return `
                <div class="font-prompt" style="${dimensions[template.id]} background: white; color: black; border-radius: 20px; padding: 30px; box-sizing: border-box; display: flex; flex-direction: column; font-family: 'Prompt', sans-serif; page-break-inside: avoid;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                        <div></div>
                        <div style="font-size: 14pt; color: #555;">${product.sku}</div>
                    </div>
                    
                    <div style="font-size: 48pt; font-weight: bold; color: #000; line-height: 1.1;">${product.description}</div>
                    
                    <div style="font-size: 18pt; color: #333; margin-top: 20px; white-space: pre-wrap; flex-grow: 1;">${product.details}</div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: flex-end; border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px;">
                        <div>
                            <p style="font-size: 14pt; margin: 0;">${channelSelect.value === 'Flagship' && product.expiresDate ? `Expire: ${product.expiresDate}` : ''}</p>
                            ${useLogo ? `<img src="${state.logo}" style="max-height: 50px; margin-top: 10px;">` : ''}
                        </div>
                        <div style="text-align: right;">
                            ${normalPrice && normalPrice > price ? `<p style="font-size: 36pt; text-decoration: line-through; color: #ef4444; margin: 0;">${formatCurrency(normalPrice)}.-</p>` : ''}
                            <p style="font-size: 72pt; font-weight: bold; color: #000; margin: 0; line-height: 1;">${formatCurrency(price)}.-</p>
                        </div>
                    </div>
                </div>`;
            default: return '';
        }
    };
    
    const openPrintPage = () => {
        const templateId = templateSelect.value;
        const allTemplates = [...defaultTemplates, ...state.templates];
        const template = allTemplates.find(t => t.id === templateId);
        if (!template) return;

        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>Print Price Tags</title>');
        printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">');
        printWindow.document.write('<style>');
        printWindow.document.write(`
            @page { size: A4; margin: 1cm; }
            body { margin: 0; font-family: 'Prompt', sans-serif; background: #555; }
            .print-sheet { display: grid; gap: 0; padding: 0; width: 19cm; height: 27.7cm; box-sizing: border-box; page-break-after: always; background: white; overflow: hidden; }
            .a4-layout { grid-template-columns: 1fr; justify-content: center; align-items: center; }
            .a5-layout { grid-template-columns: repeat(2, 1fr); gap: 1cm; align-content: start; }
            .a6-layout { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); gap: 1cm; }
            .acc-layout { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(6, 1fr); }
            .print-item-wrapper { display: flex; justify-content: center; align-items: center; }
        `);
        printWindow.document.write('</style></head><body>');

        const itemsToPrint = [];
        document.querySelectorAll('.print-quantity-input').forEach(input => {
            const sku = input.dataset.sku;
            const quantity = parseInt(input.value, 10);
            const product = state.products.find(p => p.sku === sku);
            if (product && quantity > 0) {
                for (let i = 0; i < quantity; i++) {
                    itemsToPrint.push(product);
                }
            }
        });
        
        logAction('Print', { template: template.name, count: itemsToPrint.length });

        const itemsPerSheet = template.isUploaded ? 1 : (template.layout.items || 1);
        for (let i = 0; i < itemsToPrint.length; i += itemsPerSheet) {
            const sheetItems = itemsToPrint.slice(i, i + itemsPerSheet);
            let layoutClass = template.isUploaded ? 'a4-layout' : `${template.id}-layout`;

            printWindow.document.write(`<div class="print-sheet ${layoutClass}">`);
            sheetItems.forEach(product => {
                const tagHtml = generateTagHTML(product, templateId);
                printWindow.document.write(`<div class="print-item-wrapper">${tagHtml}</div>`);
            });
            printWindow.document.write('</div>');
        }

        printWindow.document.write('</body></html>');
        printWindow.document.close();
        setTimeout(() => printWindow.print(), 500);
    };

    // #################################################################
    // #                      EVENT LISTENERS                          #
    // #################################################################

    const addEventListeners = () => {
        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin() });
        logoutBtn.addEventListener('click', handleLogout);
        settingsBtn.addEventListener('click', openSettingsPanel);
        closeSettingsBtn.addEventListener('click', () => settingsPanel.classList.add('hidden'));

        searchInput.addEventListener('input', filterAndRender);
        channelSelect.addEventListener('change', filterAndRender);
        dealerTierSelect.addEventListener('change', filterAndRender);
        startDateFilter.addEventListener('change', filterAndRender);
        endDateFilter.addEventListener('change', filterAndRender);
        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            startDateFilter.value = '';
            endDateFilter.value = '';
            filterAndRender();
        });

        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.product-checkbox').forEach(cb => {
                cb.checked = isChecked;
                if (isChecked) state.selectedProducts.add(cb.dataset.sku);
                else state.selectedProducts.delete(cb.dataset.sku);
            });
        });

        productTableBody.addEventListener('click', (e) => {
            const checkbox = e.target.closest('.product-checkbox');
            const deleteBtn = e.target.closest('.delete-btn');
            const editBtn = e.target.closest('.edit-btn');
            if (checkbox) {
                if (checkbox.checked) state.selectedProducts.add(checkbox.dataset.sku);
                else state.selectedProducts.delete(checkbox.dataset.sku);
                updateSelectAllCheckboxState();
            }
            if (deleteBtn) handleDeleteSKU(deleteBtn.dataset.sku);
            if (editBtn) showEditModal(editBtn.dataset.sku);
        });
        
        paginationControls.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.page) {
                state.currentPage = Number(e.target.dataset.page);
                renderTable();
            }
        });

        settingsPanel.addEventListener('click', (e) => {
            const navBtn = e.target.closest('.settings-nav-btn');
            if (navBtn) renderSettingsContent(navBtn.dataset.target);
        });
        
        editProductForm.addEventListener('submit', handleUpdateProduct);
        cancelEditBtn.addEventListener('click', () => editProductModal.classList.add('hidden'));
        
        printSelectionBtn.addEventListener('click', showPrintSelectionModal);
        cancelPrintBtn.addEventListener('click', () => printSelectionModal.classList.add('hidden'));
        templateSelect.addEventListener('change', updatePrintPreview);
        printItemList.addEventListener('input', (e) => {
            if(e.target.classList.contains('print-quantity-input')) {
                // No need to update preview on quantity change, it's just for final print
            }
        });
        openPrintPageBtn.addEventListener('click', openPrintPage);
        confirmNoBtn.addEventListener('click', hideConfirmation);
    };

    // #################################################################
    // #                      INITIALIZATION                           #
    // #################################################################

    const initApp = () => {
        welcomeUser.textContent = `Welcome, ${state.currentUser.username} (${state.currentUser.role})`;
        
        if (state.logo) {
            headerLogo.src = state.logo;
            headerLogo.classList.remove('hidden');
        }

        settingsBtn.style.display = checkPermissions('viewSettings') ? 'block' : 'none';
        printSelectionBtn.style.display = checkPermissions('canPrint') ? 'block' : 'none';
        
        const userChannels = state.currentUser.channels;
        channelSelect.innerHTML = '';
        const availableChannels = userChannels.includes('all') ? channels : userChannels;
        availableChannels.forEach(c => {
            const option = document.createElement('option');
            option.value = c;
            option.textContent = c;
            channelSelect.appendChild(option);
        });
        
        loadState();
        filterAndRender();
    };

    addEventListeners();
});
</script>
</body>
</html>
