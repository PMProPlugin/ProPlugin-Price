<script>
/* ================= CORE STATE / STORAGE ================= */
const LS = {
  GIST_ID: 'pp_cloud_gist_id_v2',
  TOKEN: 'pp_cloud_token_v2',
};
const defaultDealerNames = {t1:'Dealer T1', t2:'Dealer T2', t3:'Dealer T3'};
const Channels = ['Flagship','Marketplace','Dealer'];

const sampleProducts = [{
  sku:'MP-00010',
  brand:'iCon Pro Audio',
  category:'Audio Interface',
  description:'iCon Pro Audio GoLive Pro',
  details:'Audio interface for live streaming with remote control\\n24-bit/48kHz with onboard DSP (Reverb, EQ, Vocal Tune)\\nBuilt-in 5000mAh battery up to 6 hours\\nMic input mini-XLR (48V) & 1/4-inch\\nBluetooth for music & control',
  costs:4200, normalPrice:7990, promoPrice:5990, expiresDate:'2099-09-09',
  marketplacePrice:5990, dealer1:5600, dealer2:5400, dealer3:5200
}];

const defaultAppState = {
    version: 2.6,
    products: sampleProducts,
    templates: [
        { id:'t-a4',  name:'A4 (1 per sheet)', kind:'A4',  showLogo:true, imageData:null, logoStyles: { size: 64, margin: 10 },
          styles:{ sku:{fs:16,color:'#ffffff',mt:0}, description:{fs:30,color:'#ffffff',mt:0}, details:{fs:14,color:'#ffffff',mt:0}, price:{fs:72,color:'#ffffff',mt:0}, oldPrice:{fs:20,color:'#ff4d4f',mt:0}, expire:{fs:13,color:'#ffffff',mt:0} } },
        { id:'t-a5',  name:'A5 (2 per A4 landscape)', kind:'A5',  showLogo:true, imageData:null, logoStyles: { size: 50, margin: 8 },
          styles:{ sku:{fs:14,color:'#ffffff',mt:0}, description:{fs:26,color:'#ffffff',mt:0}, details:{fs:13,color:'#ffffff',mt:0}, price:{fs:60,color:'#ffffff',mt:0}, oldPrice:{fs:18,color:'#ff4d4f',mt:0}, expire:{fs:12,color:'#ffffff',mt:0} } },
        { id:'t-a6',  name:'A6 (4 per sheet)', kind:'A6',  showLogo:true, imageData:null, logoStyles: { size: 40, margin: 6 },
          styles:{ sku:{fs:12,color:'#ffffff',mt:0}, description:{fs:22,color:'#ffffff',mt:0}, details:{fs:12,color:'#ffffff',mt:0}, price:{fs:48,color:'#ffffff',mt:0}, oldPrice:{fs:16,color:'#ff4d4f',mt:0}, expire:{fs:11,color:'#ffffff',mt:0} } },
        { id:'t-acc', name:'Accessories (12 per sheet)', kind:'ACC', showLogo:true, imageData:null, logoStyles: { size: 30, margin: 4 },
          styles:{ sku:{fs:11,color:'#ffffff',mt:2}, description:{fs:15,color:'#ffffff',mt:0, align:'center'}, price:{fs:22,color:'#ffffff',mt:0}, oldPrice:{fs:12,color:'#B91C1C',mt:0}, expire:{fs:10,color:'#ffffff',mt:0} } }
    ],
    dealerNames: defaultDealerNames,
    users: [],
    logo: '',
    logs: []
};

let appData = null;
let currentUser = null;
let editingIndex = -1;
let currentPage = 1;
const itemsPerPage = 20;

let columnFilters = {};

/* ================= UTILITIES ================= */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const money = n => isFinite(n) && n > 0 ? n.toLocaleString('th-TH',{maximumFractionDigits:0}) : '-';
const toDateInput = v => v ? new Date(v).toISOString().slice(0,10) : '';
const fromExcelDate = v => {
  if (v instanceof Date) return v.toISOString().slice(0,10);
  if (typeof v==='number'){ const d=new Date(Math.round((v-25569)*86400*1000)); return d.toISOString().slice(0,10); }
  if (typeof v==='string' && /^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  return '';
};
const gpPct = (price,cost)=> (cost > 0 && price > 0 ? ((price - cost) / cost) * 100 : 0);
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
const ellip = (s,max=40)=> !s ? '' : (s.length<=max? s : s.slice(0,max-3)+'...');

function log(action, meta = '') {
  if (!appData) return;
  if(!appData.logs) appData.logs = [];
  appData.logs.unshift({ ts: new Date().toISOString(), user: currentUser?.username || '-', action, meta });
  if (appData.logs.length > 3000) appData.logs.pop();
}

function updateLocalDataAndSave(newData) {
    if (newData) appData = newData;
    renderTableHeader();
    renderTable();
    applyDealerNamesToUI();
    if (appData.logo) {
        $('#logoImg').src = appData.logo;
        $('#logoImg').classList.remove('hidden');
        $('#logoFallback').classList.add('hidden');
    } else {
        $('#logoImg').classList.add('hidden');
        $('#logoFallback').classList.remove('hidden');
    }
    const gistId = localStorage.getItem(LS.GIST_ID);
    const token = localStorage.getItem(LS.TOKEN);
    if (currentUser?.role === 'Host' && gistId && token) {
        cloudSave(gistId, token).catch(e => console.error("Auto-save failed:", e));
    }
}

/* ================= CLOUD SYNC (GitHub Gist) ================= */
async function gistRequest(method, path, body, token){
  if(!token) throw new Error('GitHub Token is required for this operation.');
  const headers = { 'Accept':'application/vnd.github+json', 'Authorization': 'Bearer '+token };
  if(body) headers['Content-Type']='application/json';
  const res = await fetch('https://api.github.com'+path, { method, headers, body: body?JSON.stringify(body):undefined });
  if(!res.ok){ const t=await res.text(); throw new Error(`GitHub ${res.status}: ${t}`); }
  return res.json();
}
async function cloudCreateGist(token, appState){
  const resp = await gistRequest('POST','/gists',{ public:false, files:{ 'proplugin-data.json':{ content: JSON.stringify(appState,null,2) } } }, token);
  localStorage.setItem(LS.GIST_ID, resp.id);
  localStorage.setItem(LS.TOKEN, token);
  return resp.id;
}
async function cloudSave(gistId, token){
  if(!gistId) throw new Error('Gist ID is required');
  const body = { files:{ 'proplugin-data.json':{ content: JSON.stringify(appData,null,2) } } };
  await gistRequest('PATCH','/gists/'+gistId, body, token);
}
async function cloudLoad(gistId, token){
  if (!gistId) throw new Error('Gist ID is required');
  const resp = await gistRequest('GET', '/gists/' + gistId, null, token);
  const file = resp.files?.['proplugin-data.json'];
  if (!file) throw new Error('proplugin-data.json not found in gist');
  const data = JSON.parse(file.content);
  appData = data;
  localStorage.setItem(LS.GIST_ID, gistId);
  localStorage.setItem(LS.TOKEN, token);
}

/* ================= AUTH ================= */
async function login(){
  const u=$('#loginUser').value.trim();
  const p=$('#loginPass').value;
  if (!appData || !appData.users) return alert('Application data is not loaded. Please set up cloud storage or refresh.');
  const pHash = await hashPassword(p);
  const found = appData.users.find(x=>x.username===u && x.passwordHash===pHash);
  if(!found) return alert('Invalid credentials');

  currentUser=found;
  columnFilters = {}; // Reset filters on new login
  $('#loginView').classList.add('hidden');
  $('#appView').classList.remove('hidden');
  $('#roleBadge').textContent=`${currentUser.role} • ${currentUser.username}`;
  
  bindAppEvents(); // Bind events for the main app view
  initFiltersForUser();
  updateLocalDataAndSave();
}
function logout(){
  currentUser=null;
  columnFilters = {}; // Reset filters on logout
  $('#appView').classList.add('hidden');
  $('#loginView').classList.remove('hidden');
  $('#loginPass').value = '';
  log('logout');
}

/* ================= FILTERS & COLUMN VISIBILITY ================= */
function initFiltersForUser(){
  const sel=$('#channelSelect'); sel.innerHTML='';
  (currentUser.channels || []).forEach(ch=>{ const o=document.createElement('option'); o.textContent=ch; sel.appendChild(o); });
  sel.value = currentUser.channels[0] || '';
  $('#btnSettings').classList.toggle('hidden', !['Host','Admin'].includes(currentUser.role));
  $('#btnPrintModal').classList.toggle('hidden', !currentUser.canPrint);
  if ($('#thCosts')) $('#thCosts').classList.toggle('hidden', !(currentUser.canSeeCosts || ['Host','Admin'].includes(currentUser.role)));
  updateColumnVisibility();
}
function updateColumnVisibility(){
  const ch=$('#channelSelect').value;
  const show={normal:false,promo:false,expire:false,market:false,marketgp:false,t1:false,gp1:false,t2:false,gp2:false,t3:false,gp3:false};
  if(ch==='Flagship'){ show.normal=show.promo=show.expire=true; }
  if(ch==='Marketplace'){ show.market=show.marketgp=true; }
  if(ch==='Dealer'){ show.t1=show.gp1=show.t2=show.gp2=show.t3=show.gp3=true; }
  const map={ 'col-normal':show.normal,'col-promo':show.promo,'col-expire':show.expire,'col-market':show.market,'col-marketgp':show.marketgp,'col-t1':show.t1,'col-gp1':show.gp1,'col-t2':show.t2,'col-gp2':show.gp2,'col-t3':show.t3,'col-gp3':show.gp3 };
  Object.entries(map).forEach(([cls,v])=> $$('.'+cls).forEach(el=>el.classList.toggle('hidden',!v)));
}

/* ================= APPLY DEALER NAMES ================= */
function applyDealerNamesToUI(){
    const dealerNames = appData?.dealerNames || defaultDealerNames;
    const uiIds = ['lblT1', 'lblT2', 'lblT3', 'edLabelT1', 'edLabelT2', 'edLabelT3'];
    uiIds.forEach(id => {
        const el = $(`#${id}`);
        if (el) {
            if (id.includes('T1')) el.textContent = dealerNames.t1 || 'Dealer T1';
            if (id.includes('T2')) el.textContent = dealerNames.t2 || 'Dealer T2';
            if (id.includes('T3')) el.textContent = dealerNames.t3 || 'Dealer T3';
        }
    });
}

/* ================= TABLE & PAGINATION ================= */
function filteredProducts(){
  if (!appData) return [];
  const q=$('#searchInput').value.trim().toLowerCase();
  const ds=$('#dateStart').value, de=$('#dateEnd').value;
  const isFlagship = $('#channelSelect').value==='Flagship';

  return (appData.products || []).filter(p=>{
    const generalSearchHit = !q || (p.sku||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q);

    const columnFilterHit = Object.keys(columnFilters).every(key => {
        if (!columnFilters[key] || columnFilters[key].size === 0) return true;
        const value = p[key] || '';
        return columnFilters[key].has(value.toString());
    });

    let dateOk = true;
    if(isFlagship && (ds||de)){
      const ex = p.expiresDate ? new Date(p.expiresDate) : null;
      if(!ex) {
        dateOk=false;
      } else {
        if(ds && ex < new Date(ds)) dateOk=false;
        if(de && ex > new Date(de+'T23:59:59')) dateOk=false;
      }
    }
    return generalSearchHit && columnFilterHit && dateOk;
  });
}

function renderPagination(totalItems) {
  const pageBox = $('#pagination');
  pageBox.innerHTML = '';
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  if (totalPages <= 1) return;
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = `px-3 py-1 rounded-lg text-sm border ${currentPage === i ? 'bg-brand.red border-red-700' : 'bg-zinc-800 border-zinc-700 hover:bg-zinc-700'}`;
    btn.onclick = () => { currentPage = i; renderTable(); };
    pageBox.appendChild(btn);
  }
}

function renderTableHeader() {
    const thead = $('#productTHead');
    const filterableColumns = [
        { key: 'sku', label: 'SKU' },
        { key: 'description', label: 'Description', className: 'w-56' },
        { key: 'details', label: 'Details', className: 'w-56' },
        { key: 'brand', label: 'Brand' },
        { key: 'category', label: 'Category' },
    ];
    
    let headerHTML = `<tr class="[&>th]:px-3 [&>th]:py-3 text-left">`;
    filterableColumns.forEach(col => {
        const isActive = columnFilters[col.key] && columnFilters[col.key].size > 0;
        headerHTML += `<th class="${col.className || ''}" style="position: relative;">
            <div class="flex items-center">
              <span>${col.label}</span>
              <button class="filter-btn ${isActive ? 'active' : ''}" data-filter-key="${col.key}">▼</button>
            </div>
            <div id="filter-dropdown-${col.key}" class="filter-dropdown"></div>
        </th>`;
    });

    headerHTML += `
        <th id="thCosts" class="hidden">Costs</th>
        <th class="col-normal">Normal</th>
        <th class="col-promo">Promotion</th>
        <th class="col-expire">Expire Date</th>
        <th class="col-market">Marketplace</th>
        <th class="col-marketgp">Market GP%</th>
        <th class="col-t1"><span id="lblT1"></span></th>
        <th class="col-gp1">GP% T1</th>
        <th class="col-t2"><span id="lblT2"></span></th>
        <th class="col-gp2">GP% T2</th>
        <th class="col-t3"><span id="lblT3"></span></th>
        <th class="col-gp3">GP% T3</th>
        <th class="w-32">Actions</th>
    </tr>`;
    thead.innerHTML = headerHTML;
}

function renderTable(){
  const body=$('#productBody'); body.innerHTML='';
  if(!appData) return;
  const showCosts = (currentUser?.canSeeCosts || ['Host','Admin'].includes(currentUser?.role));
  const canEdit = ['Host','Admin'].includes(currentUser?.role);
  const allFiltered = filteredProducts();
  const paginatedItems = allFiltered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  paginatedItems.forEach(p=>{
    const tr=document.createElement('tr');
    tr.className='border-b border-zinc-800 hover:bg-zinc-800/30';
    let isPromoExpired = false;
    if (p.expiresDate) {
        if (new Date(p.expiresDate) < today) isPromoExpired = true;
    }
    const displayedPromoPrice = isPromoExpired ? '-' : money(p.promoPrice);
    const promoPriceTitle = isPromoExpired ? 'Promotion Expired' : money(p.promoPrice);
    const gpM = gpPct(p.marketplacePrice, p.costs);
    const gp1 = gpPct(p.dealer1, p.costs);
    const gp2 = gpPct(p.dealer2, p.costs);
    const gp3 = gpPct(p.dealer3, p.costs);
    const detailsOneLine=(p.details||'').replace(/\n+/g,' • ');

    tr.innerHTML = `
      <td class="px-3 py-3 oneline" title="${p.sku}">${p.sku || '-'}</td>
      <td class="px-3 py-3 oneline" title="${p.description}"><div class="oneline" style="max-width:14rem">${p.description || '-'}</div></td>
      <td class="px-3 py-3 oneline" title="${detailsOneLine}"><div class="oneline" style="max-width:14rem">${detailsOneLine}</div></td>
      <td class="px-3 py-3 oneline" title="${p.brand}">${p.brand || '-'}</td>
      <td class="px-3 py-3 oneline" title="${p.category}">${p.category || '-'}</td>
      <td class="px-3 py-3 ${showCosts?'':'hidden'} oneline" title="${money(p.costs)}">${money(p.costs)}</td>
      <td class="px-3 py-3 col-normal oneline" title="${money(p.normalPrice)}">${money(p.normalPrice)}</td>
      <td class="px-3 py-3 col-promo oneline" title="${promoPriceTitle}" style="color:${isPromoExpired ? '#666' : '#E11D2E'};"><span style="text-decoration:${isPromoExpired ? 'line-through' : 'none'};">${displayedPromoPrice}</span></td>
      <td class="px-3 py-3 col-expire oneline" title="${toDateInput(p.expiresDate)}" style="color:${isPromoExpired ? '#666' : '#E11D2E'};">${toDateInput(p.expiresDate)}</td>
      <td class="px-3 py-3 col-market oneline" title="${money(p.marketplacePrice)}">${money(p.marketplacePrice)}</td>
      <td class="px-3 py-3 col-marketgp oneline" title="${gpM.toFixed(1)}%">${gpM.toFixed(1)}%</td>
      <td class="px-3 py-3 col-t1 oneline" title="${money(p.dealer1)}">${money(p.dealer1)}</td>
      <td class="px-3 py-3 col-gp1 oneline" title="${gp1.toFixed(1)}%">${gp1.toFixed(1)}%</td>
      <td class="px-3 py-3 col-t2 oneline" title="${money(p.dealer2)}">${money(p.dealer2)}</td>
      <td class="px-3 py-3 col-gp2 oneline" title="${gp2.toFixed(1)}%">${gp2.toFixed(1)}%</td>
      <td class="px-3 py-3 col-t3 oneline" title="${money(p.dealer3)}">${money(p.dealer3)}</td>
      <td class="px-3 py-3 col-gp3 oneline" title="${gp3.toFixed(1)}%">${gp3.toFixed(1)}%</td>
      <td class="px-3 py-3">
        ${canEdit? `<div class="flex items-center gap-2"><button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs" data-edit="${p.sku}">Edit</button><button title="Delete" class="px-2 py-1 rounded-xl bg-transparent border border-red-700 hover:bg-red-700/20 text-xs" data-del="${p.sku}">❌</button></div>` : '-'}
      </td>
    `;
    body.appendChild(tr);
  });
  renderPagination(allFiltered.length);
  bindTableEvents(); // Bind events for the newly created buttons
  if(currentUser) initFiltersForUser();
}

/* ================= EDITOR ================= */
function openEditor(sku = null) {
  if(!['Host','Admin'].includes(currentUser.role)) return;
  if (sku) {
    editingIndex = appData.products.findIndex(x=>x.sku===sku);
    const p = appData.products[editingIndex];
    $('#editorTitle').textContent = 'Edit Product';
    $('#edSku').value = p.sku;
    $('#edSku').disabled = true;
    $('#edDesc').value = p.description || '';
    $('#edDetails').value = p.details || '';
    $('#edBrand').value = p.brand || '';
    $('#edCategory').value = p.category || '';
    $('#edExpire').value = toDateInput(p.expiresDate);
    $('#edCosts').value = p.costs || '';
    $('#edNormal').value = p.normalPrice || '';
    $('#edPromo').value = p.promoPrice || '';
    $('#edMarket').value = p.marketplacePrice || '';
    $('#edT1').value = p.dealer1 || '';
    $('#edT2').value = p.dealer2 || '';
    $('#edT3').value = p.dealer3 || '';
  } else {
    editingIndex = -1;
    $('#editorTitle').textContent = 'Add New Product';
    ['edSku', 'edDesc', 'edDetails', 'edBrand', 'edCategory', 'edExpire', 'edCosts', 'edNormal', 'edPromo', 'edMarket', 'edT1', 'edT2', 'edT3'].forEach(id => $(`#${id}`).value = '');
     $('#edSku').disabled = false;
  }
  applyDealerNamesToUI();
  $('#editorModal').classList.remove('hidden');
}
function closeEditor(){ $('#editorModal').classList.add('hidden'); }
async function saveEditor() {
  const sku = $('#edSku').value.trim();
  if (!sku) { alert('SKU is required.'); return; }
  const newProductData = {
    sku: sku,
    description:$('#edDesc').value.trim(), 
    details:$('#edDetails').value.trim(),
    brand:$('#edBrand').value.trim(),
    category:$('#edCategory').value.trim(),
    expiresDate:$('#edExpire').value||'', 
    costs:parseFloat($('#edCosts').value)||0,
    normalPrice:parseFloat($('#edNormal').value)||0, 
    promoPrice:parseFloat($('#edPromo').value)||0,
    marketplacePrice:parseFloat($('#edMarket').value)||0, 
    dealer1:parseFloat($('#edT1').value)||0,
    dealer2:parseFloat($('#edT2').value)||0, 
    dealer3:parseFloat($('#edT3').value)||0
  };

  if (editingIndex > -1) {
    const oldProduct = appData.products[editingIndex];
    appData.products[editingIndex] = {...oldProduct, ...newProductData};
    log('edit_product', sku);
  } else {
    if (appData.products.some(p => p.sku === sku)) {
      alert(`SKU "${sku}" already exists.`); return;
    }
    appData.products.unshift(newProductData);
    log('add_product', sku);
  }
  closeEditor();
  updateLocalDataAndSave();
}

/* ================= SETTINGS (FULL & CORRECTED) ================= */
function openSettings(tab){
  if(!['Host','Admin'].includes(currentUser.role)) return;
  $('#settingsPanel').classList.remove('hidden');
  renderSettings(tab);
}
function fileToBase64(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

function renderSettings(tab){
  const box=$('#settingsContent');
  $$('.set-tab').forEach(b=>b.classList.remove('ring-2','ring-brand.red'));
  const btn=$(`.set-tab[data-tab="${tab}"]`); if(btn) btn.classList.add('ring-2','ring-brand.red');
  const isHost=currentUser.role==='Host';
  const isAdmin=currentUser.role==='Admin';
  $$('.only-host').forEach(el=>el.classList.toggle('hidden', !isHost));
  $$('.only-host-admin').forEach(el=>el.classList.toggle('hidden', !(isHost||isAdmin)));

  if(tab==='data'){
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Master Data</div>
      <div class="text-zinc-400 mb-4">Import or Export the main product data file.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Import Master File (.xlsx)</div>
          <input id="fileImportMaster" type="file" accept=".xlsx,.xls" class="w-full">
          <p class="text-xs text-zinc-400 mt-2">Columns: A SKU, B Desc, C Details, D Brand, E Category, F Costs, G Normal, H Marketplace, I D1, J D2, K D3</p>
          <button id="btnDoImportMaster" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Import Master</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Export Master File (.xlsx)</div>
          <button id="btnExportMaster" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Export Master</button>
          <p class="text-xs text-zinc-400 mt-2">Exports all product data without promotion columns.</p>
        </div>
      </div>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='promo'){
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Promotion Data</div>
      <div class="text-zinc-400 mb-4">Import or Export promotion-specific data.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Import Promotion File (.xlsx)</div>
          <input id="fileImportPromo" type="file" accept=".xlsx,.xls" class="w-full">
          <p class="text-xs text-zinc-400 mt-2">Columns: A SKU, B Desc, C Normal, D Promotion, E Expires</p>
          <button id="btnDoImportPromo" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Import Promotion</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
          <div>
            <div class="font-semibold mb-2">Export Promotion File (.xlsx)</div>
            <button id="btnExportPromo" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Export Promotion</button>
          </div>
          <div>
            <div class="font-semibold mb-2">Promotion Report</div>
            <button id="btnReportExpired" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Report Promotion Expire</button>
          </div>
        </div>
      </div>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='logo'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const base64 = appData.logo || '';
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Logo</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Upload logo</div>
          <input type="file" id="logoFile" accept="image/*">
          <p class="text-xs text-zinc-400 mt-2">PNG/JPG/SVG. Used on default templates.</p>
          <button id="btnSaveLogo" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Save logo</button>
          <button id="btnRemoveLogo" class="mt-4 ml-2 px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Remove</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Preview</div>
          <div class="h-40 w-40 bg-white rounded-xl overflow-hidden grid place-items-center p-2">
            ${base64?`<img src="${base64}" class="max-h-full max-w-full object-contain">`:'<div class="text-zinc-800 text-4xl font-black">P</div>'}
          </div>
        </div>
      </div>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='dealer'){
     if(!(isHost||isAdmin)){ box.innerHTML='<div class="text-zinc-400">Not allowed.</div>'; return; }
    const names = appData.dealerNames || {};
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-4">Dealer Settings</div>
      <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-xs text-zinc-400">Name for Dealer T1</label><input id="nameT1" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t1||'Dealer T1'}"></div>
          <div><label class="text-xs text-zinc-400">Name for Dealer T2</label><input id="nameT2" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t2||'Dealer T2'}"></div>
          <div><label class="text-xs text-zinc-400">Name for Dealer T3</label><input id="nameT3" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t3||'Dealer T3'}"></div>
        </div>
        <button id="btnSaveDealer" class="mt-2 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Save Names</button>
      </div>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='users'){
    if(!(isHost||isAdmin)){ box.innerHTML='<div class="text-zinc-400">Not allowed.</div>'; return; }
    box.innerHTML=`
      <div class="flex items-center justify-between">
        <div class="text-2xl font-semibold mb-2">User Management</div>
        <button id="btnAddUser" class="px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Add User</button>
      </div>
      <div id="addUserBox" class="hidden p-4 mb-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
        <div class="grid md:grid-cols-2 gap-3">
          <input id="nuName" placeholder="username" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
          <input id="nuPass" placeholder="password" type="password" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
          <select id="nuRole" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
            <option>User</option><option>Admin</option>${isHost?'<option>Host</option>':''}
          </select>
          <div class="flex items-center gap-4">
            <label class="text-sm"><input type="checkbox" id="nuSeeCosts"> See Costs</label>
            <label class="text-sm"><input type="checkbox" id="nuCanPrint" checked> Can Print</label>
          </div>
          <div class="md:col-span-2">
            ${Channels.map(ch=>`<label class="mr-3 text-sm"><input type="checkbox" class="nuCh" value="${ch}" ${ch==='Flagship'?'checked':''}> ${ch}</label>`).join('')}
          </div>
        </div>
        <div class="mt-3"><button id="nuCreate" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Create</button></div>
      </div>
      <div class="overflow-auto border border-zinc-800 rounded-2xl">
        <table class="min-w-[900px] w-full text-sm">
          <thead class="bg-zinc-900/70 border-b border-zinc-800">
            <tr class="[&>th]:px-3 [&>th]:py-2 text-left"><th>User</th><th>Role</th><th>Channels</th><th>See Costs</th><th>Can Print</th><th>New Pwd</th><th></th></tr>
          </thead>
          <tbody id="userRows"></tbody>
        </table>
      </div>
    `;
    
    const tbody=$('#userRows'); tbody.innerHTML='';
    (appData.users || []).forEach((u,i)=>{
      const tr=document.createElement('tr'); tr.className='border-b border-zinc-800';
      tr.innerHTML=`
        <td class="px-3 py-2">${u.username}</td>
        <td class="px-3 py-2">
          <select data-role-idx="${i}" class="px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" ${u.username==='host'?'disabled':''}>
            ${['Host','Admin','User'].map(r=>`<option ${u.role===r?'selected':''}>${r}</option>`).join('')}
          </select>
        </td>
        <td class="px-3 py-2">
          ${Channels.map(ch=>`<label class="mr-2"><input type="checkbox" data-ch-idx="${i}|${ch}" ${(u.channels||[]).includes(ch)?'checked':''}> <span class="text-xs">${ch}</span></label>`).join('')}
        </td>
        <td class="px-3 py-2"><input type="checkbox" data-cost-idx="${i}" ${u.canSeeCosts?'checked':''}></td>
        <td class="px-3 py-2"><input type="checkbox" data-print-idx="${i}" ${u.canPrint?'checked':''}></td>
        <td class="px-3 py-2"><input type="text" data-pass-idx="${i}" placeholder="Set new" class="w-28 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700"></td>
        <td class="px-3 py-2">
          <button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs" data-saveu-idx="${i}">Save</button>
          ${u.username==='host' ? '' : `<button class="ml-2 px-2 py-1 rounded-xl bg-transparent border border-red-700 hover:bg-red-700/20 text-xs" data-delu-idx="${i}">❌</button>`}
        </td>
      `;
      tbody.appendChild(tr);
    });
    bindSettingsEvents(tab);
  }
  if(tab==='templates'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const arr = appData.templates || [];
    box.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-2xl font-semibold mb-2">Template Management</div>
        <div class="flex items-center gap-2">
          <label class="px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 cursor-pointer">
            <input type="file" id="tplUploadNew" accept="image/png, image/jpeg" class="hidden">
            Upload New Template
          </label>
        </div>
      </div>
      <div class="text-sm text-zinc-400 mb-3">All templates are fully customizable.</div>
      <div id="tplList" class="grid lg:grid-cols-2 gap-6 mt-2"></div>
    `;

    const listBox = $('#tplList'); listBox.innerHTML='';
    arr.forEach((t,i)=>{
      const card = document.createElement('div');
      card.className = 'p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40';
      const safe = (v, d) => (v===undefined || v===null) ? d : v;
      t.styles = t.styles || {};
      ['sku','description','details','price','oldPrice','expire'].forEach(k=>{
        t.styles[k] = t.styles[k] || {fs:14,color:'#ffffff',mt:0};
      });
      t.logoStyles = t.logoStyles || {size:64, margin:10};

      card.innerHTML = `
        <div class="flex justify-between items-start">
          <input data-name-tpl="${i}" value="${t.name||'Untitled Template'}" class="bg-transparent text-white text-lg font-semibold px-2 py-1 outline-none border-b border-zinc-700 focus:border-brand.red">
          <button class="ml-2 px-3 py-1 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700" data-del-tpl="${i}">Delete</button>
        </div>
        <div class="text-xs text-zinc-400 mb-3">ID: ${t.id||'-'} • Kind: ${t.kind||'-'}</div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-2">Background Image</div>
            <img src="${t.imageData||''}" alt="template" class="w-full rounded-lg border border-zinc-700 my-2 object-contain max-h-32 ${t.imageData?'':'hidden'}">
            <div class="${t.imageData?'hidden':''} text-xs text-zinc-500">No background image</div>
            <label class="w-full text-center block mt-2 px-3 py-2 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 cursor-pointer">
              <input type="file" data-img-tpl="${i}" accept="image/png, image/jpeg" class="hidden">
              Upload/Change Image
            </label>
          </div>
          <div>
            <div class="text-sm font-semibold mb-2">Logo Settings</div>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" data-logo-tpl="${i}" ${t.showLogo?'checked':''}> Show logo
            </label>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div>
                <label class="text-xs text-zinc-400">Size (px)</label>
                <input type="number" step="1" data-logosize-tpl="${i}" value="${safe(parseInt(t.logoStyles.size),64)}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
              </div>
              <div>
                <label class="text-xs text-zinc-400">Margin (px)</label>
                <input type="number" step="1" data-logomargin-tpl="${i}" value="${safe(parseInt(t.logoStyles.margin),10)}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mt-4">
          ${['sku','description','details','price','oldPrice','expire'].map(k=>`
            <div class="p-3 rounded-xl bg-zinc-900 border border-zinc-800">
              <div class="text-xs text-zinc-400 mb-1 capitalize">${k.replace('oldPrice','Old Price')}</div>
              <label class="text-xs">Font size</label>
              <input type="number" step="1" data-fs-tpl="${i}|${k}" value="${t.styles[k].fs}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800 mb-1">
              <label class="text-xs">Color</label>
              <input type="color" data-color-tpl="${i}|${k}" value="${t.styles[k].color}" class="w-full h-8 rounded-xl bg-zinc-950 border border-zinc-800 mb-1">
              <label class="text-xs">Top margin (px)</label>
              <input type="number" step="1" data-mt-tpl="${i}|${k}" value="${t.styles[k].mt}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
            </div>
          `).join('')}
        </div>
        <button class="mt-4 w-full px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700" data-savetpl-idx="${i}">Save Template</button>
      `;
      listBox.appendChild(card);
    });
    bindSettingsEvents(tab);
  }
  if(tab==='cloud'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const gistId = localStorage.getItem(LS.GIST_ID) || '';
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Cloud Sync (GitHub Gist)</div>
      <p class="text-sm text-zinc-400 mb-4">Current Gist ID: ${gistId || 'Not set'}</p>
      <button id="btnCloudLoadRefresh" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 font-semibold">Refresh from Cloud</button>
      <p class="text-xs text-zinc-400 mt-2">Data will be automatically saved on every change.</p>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='history'){
     if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const logs=appData.logs || [];
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Usage History</div>
      <div class="max-h-[65vh] overflow-auto border border-zinc-800 rounded-2xl">
        <table class="min-w-[700px] w-full text-sm">
          <thead class="bg-zinc-900/70 border-b border-zinc-800">
            <tr class="[&>th]:px-3 [&>th]:py-2 text-left"><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr>
          </thead>
          <tbody>${logs.map(l=>`<tr class="border-b border-zinc-800"><td class="px-3 py-2">${new Date(l.ts).toLocaleString('th-TH')}</td><td class="px-3 py-2">${l.user}</td><td class="px-3 py-2">${l.action}</td><td class="px-3 py-2 text-zinc-400">${l.meta||''}</td></tr>`).join('')}</tbody>
        </table>
      </div>
    `;
  }
}


/* ================= IMPORT / EXPORT ================= */
// This section is unchanged.

/* ================= PRINT FLOW & OTHERS ================= */
// This section is unchanged.

/* ================= NEW EXCEL FILTER LOGIC ================= */
// This section is unchanged.

/* ================= EVENTS BINDING (NEW MODULAR & STABLE STRUCTURE) ================= */

// Bind events for views that are visible BEFORE login. Called once on startup.
function bindAuthEvents() {
    $('#btnCreateHost').onclick = async () => {
        const pass = $('#setupPass').value;
        if (pass !== $('#setupPassConfirm').value || !pass) return alert('Passwords do not match or are empty.');
        if (pass.length < 4) return alert('Password must be at least 4 characters long.');
        if (!appData) appData = JSON.parse(JSON.stringify(defaultAppState));
        appData.users = [{ username: 'host', passwordHash: await hashPassword(pass), role: 'Host', channels: [...Channels], canSeeCosts: true, canPrint: true }];
        const gistId = localStorage.getItem(LS.GIST_ID);
        const token = localStorage.getItem(LS.TOKEN);
        if(gistId && token) {
            try {
                await cloudSave(gistId, token);
                alert('Host account created and saved. Please log in.');
                $('#setupView').classList.add('hidden');
                $('#loginView').classList.remove('hidden');
            } catch (err) { alert('Failed to save host account: ' + err.message); }
        } else { alert('Error: Gist credentials not found.'); }
    };

    $('#btnLogin').onclick = login;
    $('#loginPass').onkeydown = (e) => { if (e.key === 'Enter') login(); };

    $('#btnCloudCreate').onclick = async () => {
        const token = $('#cloudToken').value.trim();
        if (!token) return alert('GitHub Token is required.');
        try {
            const gistId = await cloudCreateGist(token, defaultAppState);
            alert('Gist created: ' + gistId + '\nPlease create the host account.');
            appData = JSON.parse(JSON.stringify(defaultAppState));
            $('#cloudSetupView').classList.add('hidden');
            $('#setupView').classList.remove('hidden');
        } catch (err) { alert('Error creating Gist: ' + err.message); }
    };

    $('#btnCloudLoad').onclick = async () => {
        const token = $('#cloudToken').value.trim();
        const gistId = $('#cloudGistId').value.trim();
        if (!token || !gistId) return alert('Token and Gist ID are required.');
        try {
            await cloudLoad(gistId, token);
            alert('Loaded from Gist. Please log in.');
            $('#cloudSetupView').classList.add('hidden');
            $('#loginView').classList.remove('hidden');
        } catch (err) { alert('Error loading from Gist: ' + err.message); }
    };
}

// Bind events for the main application view. Called ONCE after successful login.
function bindAppEvents() {
    $('#btnLogout').onclick = logout;
    $('#btnNewProduct').onclick = () => openEditor();
    $('#btnSettings').onclick = () => openSettings('data');
    $('#btnPrintModal').onclick = () => {
        if (!currentUser || !currentUser.canPrint) return;
        buildPrintList();
        fillTemplateDropdown();
        renderPreview(filteredProducts()[0], (appData.templates||[])[0]);
        togglePrintModal(true);
    };

    $('#searchInput').oninput = () => { currentPage = 1; renderTable(); };
    $('#dateStart').onchange = () => { currentPage = 1; renderTable(); };
    $('#dateEnd').onchange = () => { currentPage = 1; renderTable(); };
    $('#channelSelect').onchange = () => { updateColumnVisibility(); currentPage = 1; renderTable(); };

    // Modals and Panels that are part of the main app view
    $('#btnCloseSettings').onclick = () => $('#settingsPanel').classList.add('hidden');
    $$('.set-tab').forEach(b => b.onclick = () => openSettings(b.dataset.tab));
    $('#btnCloseEditor').onclick = closeEditor;
    $('#btnSaveEd').onclick = saveEditor;
    $('#btnClosePrintModal').onclick = () => togglePrintModal(false);
    $('#btnOpenPrint').onclick = () => {
        const picks = $$('#printList input[type="checkbox"]:checked').map(c => c.dataset.sel);
        const list = picks.map(sku => ({ p: appData.products.find(p => p.sku === sku), qty: parseInt($(`[data-qty="${sku}"]`).value) || 1 })).filter(item => item.p);
        const tpl = appData.templates.find(t => t.id === $('#printTemplate').value) || appData.templates[0];
        openPrintTab(list, tpl);
    };
}

// Bind events for DYNAMIC content within the table. Called every time the table is re-rendered.
function bindTableEvents() {
    $$('button[data-edit]').forEach(b => b.onclick = () => openEditor(b.dataset.edit));
    $$('button[data-del]').forEach(b => b.onclick = () => {
        const sku = b.dataset.del;
        if (confirm(`Delete SKU ${sku}? This cannot be undone.`)) {
            appData.products = appData.products.filter(x => x.sku !== sku);
            log('delete_sku', sku);
            updateLocalDataAndSave();
        }
    });

    $$('.filter-btn').forEach(btn => {
        btn.onclick = () => openFilterDropdown(btn.dataset.filterKey);
    });
}

// Bind events for DYNAMIC content within the settings panel. Called every time a tab is rendered.
function bindSettingsEvents(tab) {
    if (tab === 'data') {
        $('#btnDoImportMaster').onclick=doImportMaster;
        $('#btnExportMaster').onclick=doExportMaster;
    } 
    if (tab === 'promo') {
        $('#btnDoImportPromo').onclick=doImportPromo;
        $('#btnExportPromo').onclick=doExportPromo;
        $('#btnReportExpired').onclick=showExpiredPromoReport;
    }
    if (tab === 'logo') {
        $('#btnSaveLogo').onclick=async()=>{
            const f=$('#logoFile').files[0]; if(!f) return alert('Choose a file.');
            appData.logo = await fileToBase64(f);
            log('update_logo');
            updateLocalDataAndSave();
            openSettings('logo');
        };
        $('#btnRemoveLogo').onclick=()=>{
            appData.logo = '';
            log('remove_logo');
            updateLocalDataAndSave();
            openSettings('logo');
        }
    }
    if (tab === 'dealer') {
        $('#btnSaveDealer').onclick=()=>{
            appData.dealerNames = {t1:$('#nameT1').value.trim()||'Dealer T1', t2:$('#nameT2').value.trim()||'Dealer T2', t3:$('#nameT3').value.trim()||'Dealer T3'};
            log('save_dealer_names', JSON.stringify(appData.dealerNames));
            updateLocalDataAndSave();
            alert('Saved');
        };
    }
    if (tab === 'users') {
        $('#btnAddUser').onclick = () => $('#addUserBox').classList.toggle('hidden');
        $('#nuCreate').onclick = async () => {
            const name = $('#nuName').value.trim();
            const pass = $('#nuPass').value.trim();
            if (!name || !pass) return alert('Username & password required');
            if ((appData.users || []).some(u => u.username === name)) return alert('Username already exists');
            const role = $('#nuRole').value;
            const canSee = $('#nuSeeCosts').checked;
            const canPrint = $('#nuCanPrint').checked;
            const chs = $$('.nuCh').filter(x => x.checked).map(x => x.value);
            if (!chs.length) return alert('Select at least one channel');
            appData.users.push({ username: name, passwordHash: await hashPassword(pass), role, channels: chs, canSeeCosts: canSee, canPrint });
            log('add_user', name);
            updateLocalDataAndSave();
            openSettings('users');
            alert('User created');
        };

        $$('button[data-saveu-idx]').forEach(b => {
            b.onclick = async (e) => {
                const i = +e.target.dataset.saveuIdx;
                const u = appData.users[i];
                if(!u) return;
                u.role = $(`select[data-role-idx="${i}"]`).value;
                u.canSeeCosts = $(`input[data-cost-idx="${i}"]`).checked;
                u.canPrint = $(`input[data-print-idx="${i}"]`).checked;
                const newPass = $(`input[data-pass-idx="${i}"]`).value.trim();
                if (newPass) { u.passwordHash = await hashPassword(newPass); }
                u.channels = Channels.filter(ch => $(`input[data-ch-idx="${i}|${ch}"]`).checked);
                if (currentUser.username === u.username) { currentUser = u; initFiltersForUser(); }
                log('update_user', u.username);
                updateLocalDataAndSave();
                alert('Saved.');
                openSettings('users');
            };
        });

        $$('button[data-delu-idx]').forEach(b => {
            b.onclick = (e) => {
                const i = +e.target.dataset.deluIdx;
                const u = appData.users[i];
                if(!u) return;
                if (u.username === 'host') return alert('Cannot delete host account.');
                if (confirm(`Delete user "${u.username}"?`)) {
                    appData.users.splice(i, 1);
                    log('delete_user', u.username);
                    updateLocalDataAndSave();
                    openSettings('users');
                }
            };
        });
    } 
    if (tab === 'templates') {
        $('#tplUploadNew').onchange = async (e) => {
          const f = e.target.files && e.target.files[0]; if(!f) return;
          const nm = prompt('Enter a name for this new template:'); if(!nm){ e.target.value=''; return; }
          try{
            const imageData = await fileToBase64(f);
            const id = 'user-' + Math.random().toString(36).slice(2,10);
            const base = defaultAppState.templates[2] || {styles:{}};
            appData.templates.push({
              id, name: nm, kind: 'IMAGE', imageData,
              showLogo: false, logoStyles: { size: 40, margin: 6 },
              styles: JSON.parse(JSON.stringify(base.styles||{}))
            });
            log('create_template_image', nm);
            updateLocalDataAndSave();
            openSettings('templates');
            alert('New template created.');
          }catch(err){ alert('Failed to create template: '+err.message); }
          e.target.value='';
        };
        $$('[data-savetpl-idx]').forEach(btn => {
            btn.onclick = () => {
                const i = +btn.dataset.savetplIdx;
                const t = appData.templates[i];
                if(!t) return;
                t.name = $(`[data-name-tpl="${i}"]`).value.trim() || 'Untitled Template';
                ['sku','description','details','price','oldPrice','expire'].forEach(k=>{
                    t.styles[k] = {
                        fs: parseInt($(`[data-fs-tpl="${i}|${k}"]`).value) || 14,
                        color: $(`[data-color-tpl="${i}|${k}"]`).value || '#ffffff',
                        mt: parseInt($(`[data-mt-tpl="${i}|${k}"]`).value) || 0,
                    };
                });
                t.showLogo = $(`[data-logo-tpl="${i}"]`).checked;
                t.logoStyles = {
                    size: parseInt($(`[data-logosize-tpl="${i}"]`).value) || 64,
                    margin: parseInt($(`[data-logomargin-tpl="${i}"]`).value) || 10,
                };
                log('save_template', t.name);
                updateLocalDataAndSave();
                alert('Template saved.');
            };
        });
        $$('[data-del-tpl]').forEach(btn => {
            btn.onclick = () => {
                const i = +btn.dataset.delTpl;
                const t = appData.templates[i];
                if(!t) return;
                if (confirm(`Delete template "${t.name}"?`)) {
                    appData.templates.splice(i, 1);
                    log('delete_template', t.name);
                    updateLocalDataAndSave();
                    openSettings('templates');
                }
            };
        });
        $$('[data-img-tpl]').forEach(input => {
            input.onchange = async (e) => {
                const i = +e.target.dataset.imgTpl;
                const file = e.target.files[0];
                if (!file) return;
                const t = appData.templates[i];
                if (!t) return;
                try {
                    t.imageData = await fileToBase64(file);
                    t.kind = t.kind || 'IMAGE';
                    log('update_template_image', t.name);
                    updateLocalDataAndSave();
                    openSettings('templates');
                } catch(err) { alert('Failed to update image: '+err.message); }
            };
        });
    }
    if (tab === 'cloud') {
        $('#btnCloudLoadRefresh').onclick=async()=>{
            const token = localStorage.getItem(LS.TOKEN);
            const gistId = localStorage.getItem(LS.GIST_ID);
            if(!gistId || !token) { alert('Gist ID and Token not found.'); return; }
            try {
                await cloudLoad(gistId, token);
                updateLocalDataAndSave();
                alert('Refreshed from cloud successfully.');
            } catch(e){ alert(e.message); }
        };
    }
}


/* ================= STARTUP LOGIC ================= */
async function initialCheck() {
    const gistId = localStorage.getItem(LS.GIST_ID);
    const token = localStorage.getItem(LS.TOKEN);
    if (gistId && token) {
        try {
            await cloudLoad(gistId, token);
            $('#cloudSetupView').classList.add('hidden');
            if (appData.users && appData.users.length > 0) {
                $('#loginView').classList.remove('hidden');
            } else {
                $('#setupView').classList.remove('hidden');
            }
        } catch(e) {
            localStorage.removeItem(LS.GIST_ID);
            localStorage.removeItem(LS.TOKEN);
            $('#cloudSetupView').classList.remove('hidden');
            alert("Cloud load failed, credentials cleared. Please set up again. Error: " + e.message);
        }
    } else {
        $('#cloudSetupView').classList.remove('hidden');
    }
}

function init() {
  bindAuthEvents();
  
  // Global listener for closing filter dropdowns
  document.addEventListener('click', (e) => {
      if (!e.target.closest('.filter-btn') && !e.target.closest('.filter-dropdown')) {
          closeAllFilterDropdowns();
      }
      
      const applyFilterBtn = e.target.closest('[data-apply-filter]');
      if (applyFilterBtn) {
          const key = applyFilterBtn.dataset.applyFilter;
          const selected = new Set($$(`.filter-item-${key}:checked`).map(cb => cb.value));
          columnFilters[key] = selected;
          currentPage = 1;
          renderTable();
          closeAllFilterDropdowns();
      }
      const clearFilterBtn = e.target.closest('[data-clear-filter]');
      if (clearFilterBtn) {
          const key = clearFilterBtn.dataset.clearFilter;
          if(columnFilters[key]) columnFilters[key].clear();
          currentPage = 1;
          renderTable();
          closeAllFilterDropdowns();
      }
  });
  
  initialCheck();
}

init();
</script>

</body>
</html>
