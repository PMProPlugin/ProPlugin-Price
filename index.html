<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ProPlugin ‚Ä¢ ProPricing</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        fontFamily: { sans: ['Kanit','Prompt','system-ui','sans-serif'] },
        colors: { brand: { dark:'#0b0b0c', red:'#E11D2E' } },
        boxShadow: { soft: '0 6px 18px rgba(0,0,0,.25)' }
      }
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

<style>
  :root { color-scheme: dark; }
  html,body{ height:100%; background:#0b0b0c }
  ::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#222;border-radius:10px}
  .oneline{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .text-elevate{ text-shadow:0 1px 2px rgba(0,0,0,.9),0 0 1px rgba(0,0,0,.7) }
  @media print { .no-print{display:none!important} .print-only{display:block} }
  .filter-input {
    width: 100%;
    background-color: #1a1a1a;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 2px 4px;
    font-size: 11px;
    margin-top: 4px;
    color: #eee;
  }
</style>
</head>

<body class="text-white font-sans">

<section id="setupView" class="hidden min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">First-Time Setup</div>
    </div>
    <div class="text-zinc-400 mb-4">Please create the primary 'host' account to begin.</div>
    <label class="text-sm text-zinc-400">Username</label>
    <input id="setupUser" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" value="host" disabled />
    <label class="text-sm text-zinc-400 mt-4 block">Choose a strong password</label>
    <input id="setupPass" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="password" />
    <label class="text-sm text-zinc-400 mt-4 block">Confirm password</label>
    <input id="setupPassConfirm" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="confirm password" />
    <button id="btnCreateHost" class="mt-6 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Create Host Account</button>
  </div>
</section>

<section id="loginView" class="hidden min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">ProPlugin ‚Ä¢ ProPricing</div>
    </div>
    <label class="text-sm text-zinc-400">Username</label>
    <input id="loginUser" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="username" />
    <label class="text-sm text-zinc-400 mt-4 block">Password</label>
    <input id="loginPass" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="password" />
    <button id="btnLogin" class="mt-6 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Sign in</button>
  </div>
</section>

<section id="cloudSetupView" class="min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
       <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">Cloud Setup</div>
    </div>
    <p class="text-zinc-400 mb-4">Please set up GitHub Gist for cloud storage. You can create a new Gist or load from an existing one.</p>
    <label class="text-sm text-zinc-400">GitHub Personal Access Token (scope: gist)</label>
    <input id="cloudToken" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="ghp_..." />
    <label class="text-sm text-zinc-400 mt-4 block">Gist ID (optional for new Gist)</label>
    <input id="cloudGistId" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="e.g. a1b2c3d4..." />
    <div class="flex flex-col gap-4 mt-6">
      <button id="btnCloudCreate" class="w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Create New Gist</button>
      <button id="btnCloudLoad" class="w-full py-3 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 font-semibold">Load from Existing Gist</button>
    </div>
  </div>
</section>

<section id="appView" class="hidden min-h-screen">
  <header class="sticky top-0 z-40 bg-brand.dark/95 backdrop-blur border-b border-zinc-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-3">
        <div id="logoBox" class="w-10 h-10 rounded-xl bg-zinc-100 text-brand.dark font-black grid place-items-center overflow-hidden select-none">
          <span id="logoFallback">P</span>
          <img id="logoImg" class="hidden w-full h-full object-contain" alt="logo">
        </div>
        <div class="text-xl sm:text-2xl font-semibold tracking-wide">ProPricing</div>
        <span id="roleBadge" class="ml-2 text-xs px-2 py-1 rounded bg-zinc-800 border border-zinc-700"></span>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnSettings" class="hidden px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm">‚öôÔ∏è</button>
        <button id="btnLogout" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm">Sign out</button>
      </div>
    </div>
    <div class="max-w-7xl mx-auto px-4 pb-4 flex flex-col lg:flex-row gap-3">
      <div class="relative flex-1">
        <input id="searchInput" class="w-full text-xl sm:text-2xl px-5 py-4 rounded-2xl border border-zinc-700 bg-zinc-900 text-white focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="Search (SKU / Product Name)" />
        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500">üîé</div>
      </div>
      <select id="channelSelect" class="px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red"></select>
      <div class="px-3 py-2 rounded-2xl bg-zinc-950 border border-zinc-700 flex items-center gap-2">
        <span class="text-sm text-zinc-400">Date range</span>
        <input id="dateStart" type="date" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
        <span class="text-zinc-500">‚Üí</span>
        <input id="dateEnd" type="date" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
      </div>
      <button id="btnNewProduct" class="px-5 py-3 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 font-semibold">Add +</button>
      <button id="btnPrintModal" class="px-5 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Print</button>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="overflow-auto border border-zinc-800 rounded-2xl">
      <table class="min-w-[1800px] w-full text-sm">
        <thead id="productTHead" class="bg-zinc-900/70 border-b border-zinc-800"></thead>
        <tbody id="productBody" class="[&>tr:nth-child(odd)]:bg-zinc-900/40"></tbody>
      </table>
    </div>
    <div id="pagination" class="mt-4 flex justify-center items-center gap-2"></div>
  </main>
</section>

<div id="settingsPanel" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm">
  <div class="absolute inset-4 bg-zinc-950/95 border border-zinc-800 rounded-2xl overflow-hidden grid grid-cols-[260px_1fr]">
    <aside class="bg-zinc-900/60 border-r border-zinc-800 p-3 space-y-2">
      <div class="text-sm text-zinc-400 px-2">Settings</div>
      <button data-tab="data" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Master Data</button>
      <button data-tab="promo" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Promotion</button>
      <button data-tab="logo" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Logo</button>
      <button data-tab="dealer" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Dealer Settings</button>
      <button data-tab="users" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">User Management</button>
      <button data-tab="templates" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Template Management</button>
      <button data-tab="cloud" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Cloud Sync</button>
      <button data-tab="history" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Usage History</button>
      <div class="absolute bottom-3 left-3 right-3">
        <button id="btnCloseSettings" class="w-full text-sm px-2 py-1.5 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">Close</button>
      </div>
    </aside>
    <section id="settingsContent" class="p-6 overflow-auto"></section>
  </div>
</div>

<div id="editorModal" class="hidden fixed inset-0 z-[70] bg-black/70">
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
      <div id="editorTitle" class="text-xl font-semibold">Edit Product</div>
      <button id="btnCloseEditor" class="px-3 py-1 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>
    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-auto h-[calc(100%-100px)]">
      <div class="space-y-4">
        <div><label class="text-sm text-zinc-400">SKU</label><input id="edSku" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Brand</label><input id="edBrand" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Category</label><input id="edCategory" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Description</label><input id="edDesc" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Details</label><textarea id="edDetails" rows="4" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></textarea></div>
      </div>
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-sm text-zinc-400">Costs</label><input id="edCosts" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Normal Price</label><input id="edNormal" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Promotion Price</label><input id="edPromo" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
           <div><label class="text-sm text-zinc-400">Expires Date</label><input id="edExpire" type="date" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Marketplace Price</label><input id="edMarket" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT1">Dealer T1</span></label><input id="edT1" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT2">Dealer T2</span></label><input id="edT2" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT3">Dealer T3</span></label><input id="edT3" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        </div>
        <button id="btnSaveEd" class="w-full mt-2 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="printModal" class="hidden fixed inset-0 z-[80] bg-black/70">
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl grid grid-rows-[auto_1fr] grid-cols-[480px_1fr] min-h-0">
    <div class="col-span-2 sticky top-0 z-10 bg-zinc-950 border-b border-zinc-800 p-4 flex items-center justify-between">
      <div class="text-xl font-semibold">Print Price Tags</div>
      <button id="btnClosePrintModal" class="px-3 py-1.5 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>
    <div class="p-4 border-r border-zinc-800 space-y-4 overflow-auto">
      <div class="sticky top-0 bg-zinc-950 border-b border-zinc-800 pb-3 z-10">
        <div class="grid grid-cols-[1fr_auto] gap-2">
          <select id="printTemplate" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></select>
          <button id="btnOpenPrint" class="px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Open Print Page</button>
        </div>
        <div class="mt-3 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-800 flex items-center gap-2">
          <input id="printSearch" class="flex-1 bg-transparent outline-none" placeholder="Search in list‚Ä¶">
          <label class="text-sm"><input type="checkbox" id="printCheckAll"> <span class="text-zinc-300">Select all</span></label>
        </div>
        <div class="text-sm text-zinc-400 mt-2">Select products and set qty per SKU</div>
      </div>
      <div id="printList" class="space-y-2 pt-2"></div>
      <div id="printSummary" class="text-sm text-zinc-400"></div>
    </div>
    <div class="flex flex-col w-full h-full min-h-0 min-w-0 p-4 overflow-hidden">
      <div class="text-sm text-zinc-400 mb-2 shrink-0">Live preview of the first selected item</div>
      <div id="previewBox" class="bg-zinc-900 rounded-2xl border border-zinc-800 flex-1 w-full h-full min-h-0 min-w-0 relative flex items-center justify-center overflow-hidden"></div>
    </div>
  </div>
</div>

<script>
/* ================= CORE STATE / STORAGE ================= */
const LS = {
  GIST_ID: 'pp_cloud_gist_id_v2',
  TOKEN: 'pp_cloud_token_v2',
};
const defaultDealerNames = {t1:'Dealer T1', t2:'Dealer T2', t3:'Dealer T3'};
const Channels = ['Flagship','Marketplace','Dealer'];

const sampleProducts = [{
  sku:'MP-00010',
  brand:'iCon Pro Audio',
  category:'Audio Interface',
  description:'iCon Pro Audio GoLive Pro',
  details:'Audio interface for live streaming with remote control\\n24-bit/48kHz with onboard DSP (Reverb, EQ, Vocal Tune)\\nBuilt-in 5000mAh battery up to 6 hours\\nMic input mini-XLR (48V) & 1/4-inch\\nBluetooth for music & control',
  costs:4200, normalPrice:7990, promoPrice:5990, expiresDate:'2099-09-09',
  marketplacePrice:5990, dealer1:5600, dealer2:5400, dealer3:5200
}];

const defaultAppState = {
    version: 2.0,
    products: sampleProducts,
    templates: [
        { id:'t-a4',  name:'A4 (1 per sheet)', kind:'A4',  showLogo:true, imageData:null, logoStyles: { size: 64, margin: 10 },
          styles:{ sku:{fs:16,color:'#ffffff',mt:0}, description:{fs:30,color:'#ffffff',mt:0}, details:{fs:14,color:'#ffffff',mt:0}, price:{fs:72,color:'#ffffff',mt:0}, oldPrice:{fs:20,color:'#ff4d4f',mt:0}, expire:{fs:13,color:'#ffffff',mt:0} } },
        { id:'t-a5',  name:'A5 (2 per A4 landscape)', kind:'A5',  showLogo:true, imageData:null, logoStyles: { size: 50, margin: 8 },
          styles:{ sku:{fs:14,color:'#ffffff',mt:0}, description:{fs:26,color:'#ffffff',mt:0}, details:{fs:13,color:'#ffffff',mt:0}, price:{fs:60,color:'#ffffff',mt:0}, oldPrice:{fs:18,color:'#ff4d4f',mt:0}, expire:{fs:12,color:'#ffffff',mt:0} } },
        { id:'t-a6',  name:'A6 (4 per sheet)', kind:'A6',  showLogo:true, imageData:null, logoStyles: { size: 40, margin: 6 },
          styles:{ sku:{fs:12,color:'#ffffff',mt:0}, description:{fs:22,color:'#ffffff',mt:0}, details:{fs:12,color:'#ffffff',mt:0}, price:{fs:48,color:'#ffffff',mt:0}, oldPrice:{fs:16,color:'#ff4d4f',mt:0}, expire:{fs:11,color:'#ffffff',mt:0} } },
        { id:'t-acc', name:'Accessories (12 per sheet)', kind:'ACC', showLogo:true, imageData:null, logoStyles: { size: 30, margin: 4 },
          styles:{ sku:{fs:11,color:'#ffffff',mt:2}, description:{fs:15,color:'#ffffff',mt:0, align:'center'}, price:{fs:22,color:'#ffffff',mt:0}, oldPrice:{fs:12,color:'#B91C1C',mt:0}, expire:{fs:10,color:'#ffffff',mt:0} } }
    ],
    dealerNames: defaultDealerNames,
    users: [],
    logo: '',
    logs: []
};

let appData = null;
let currentUser = null;
let editingIndex = -1;
let currentPage = 1;
const itemsPerPage = 20;

/* ================= UTILITIES ================= */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const money = n => isFinite(n) && n > 0 ? n.toLocaleString('th-TH',{maximumFractionDigits:0}) : '-';
const toDateInput = v => v ? new Date(v).toISOString().slice(0,10) : '';
const fromExcelDate = v => {
  if (v instanceof Date) return v.toISOString().slice(0,10);
  if (typeof v==='number'){ const d=new Date(Math.round((v-25569)*86400*1000)); return d.toISOString().slice(0,10); }
  if (typeof v==='string' && /^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  return '';
};
const gpPct = (price,cost)=> (cost > 0 && price > 0 ? ((price - cost) / cost) * 100 : 0);
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
const ellip = (s,max=40)=> !s ? '' : (s.length<=max? s : s.slice(0,max-3)+'...');

function log(action, meta = '') {
  if (!appData) return;
  appData.logs.unshift({ ts: new Date().toISOString(), user: currentUser?.username || '-', action, meta });
  if (appData.logs.length > 3000) appData.logs.pop();
}

function updateLocalDataAndSave(newData) {
    if (newData) appData = newData;
    applyDealerNamesToUI();
    renderTableHeader();
    renderTable();
    if (appData.logo) {
        $('#logoImg').src = appData.logo;
        $('#logoImg').classList.remove('hidden');
        $('#logoFallback').classList.add('hidden');
    } else {
        $('#logoImg').classList.add('hidden');
        $('#logoFallback').classList.remove('hidden');
    }
    const gistId = localStorage.getItem(LS.GIST_ID);
    const token = localStorage.getItem(LS.TOKEN);
    if (currentUser?.role === 'Host' && gistId && token) {
        cloudSave(gistId, token).catch(e => console.error("Auto-save failed:", e));
    }
}

/* ================= CLOUD SYNC (GitHub Gist) ================= */
async function gistRequest(method, path, body, token){
  if(!token) throw new Error('GitHub Token is required for this operation.');
  const headers = { 'Accept':'application/vnd.github+json', 'Authorization': 'Bearer '+token };
  if(body) headers['Content-Type']='application/json';
  const res = await fetch('https://api.github.com'+path, { method, headers, body: body?JSON.stringify(body):undefined });
  if(!res.ok){ const t=await res.text(); throw new Error(`GitHub ${res.status}: ${t}`); }
  return res.json();
}
async function cloudCreateGist(token, appState){
  const resp = await gistRequest('POST','/gists',{ public:false, files:{ 'proplugin-data.json':{ content: JSON.stringify(appState,null,2) } } }, token);
  localStorage.setItem(LS.GIST_ID, resp.id);
  localStorage.setItem(LS.TOKEN, token);
  return resp.id;
}
async function cloudSave(gistId, token){
  if(!gistId) throw new Error('Gist ID is required');
  const body = { files:{ 'proplugin-data.json':{ content: JSON.stringify(appData,null,2) } } };
  await gistRequest('PATCH','/gists/'+gistId, body, token);
}
async function cloudLoad(gistId, token){
  if (!gistId) throw new Error('Gist ID is required');
  const resp = await gistRequest('GET', '/gists/' + gistId, null, token);
  const file = resp.files?.['proplugin-data.json'];
  if (!file) throw new Error('proplugin-data.json not found in gist');
  const data = JSON.parse(file.content);
  appData = data;
  localStorage.setItem(LS.GIST_ID, gistId);
  localStorage.setItem(LS.TOKEN, token);
}

/* ================= AUTH ================= */
async function login(){
  const u=$('#loginUser').value.trim();
  const p=$('#loginPass').value;
  if (!appData || !appData.users) return alert('Application data is not loaded. Please set up cloud storage or refresh.');
  const pHash = await hashPassword(p);
  const found = appData.users.find(x=>x.username===u && x.passwordHash===pHash);
  if(!found) return alert('Invalid credentials');

  currentUser=found;
  $('#loginView').classList.add('hidden');
  $('#appView').classList.remove('hidden');
  $('#roleBadge').textContent=`${currentUser.role} ‚Ä¢ ${currentUser.username}`;
  initFiltersForUser();
  updateLocalDataAndSave();
}
function logout(){
  currentUser=null;
  $('#appView').classList.add('hidden');
  $('#loginView').classList.remove('hidden');
  $('#loginPass').value = '';
  log('logout');
}

/* ================= FILTERS & COLUMN VISIBILITY ================= */
function initFiltersForUser(){
  const sel=$('#channelSelect'); sel.innerHTML='';
  (currentUser.channels || []).forEach(ch=>{ const o=document.createElement('option'); o.textContent=ch; sel.appendChild(o); });
  sel.value = currentUser.channels[0] || '';
  $('#btnSettings').classList.toggle('hidden', !['Host','Admin'].includes(currentUser.role));
  $('#btnPrintModal').classList.toggle('hidden', !currentUser.canPrint);
  if ($('#thCosts')) $('#thCosts').classList.toggle('hidden', !(currentUser.canSeeCosts || ['Host','Admin'].includes(currentUser.role)));
  updateColumnVisibility();
}
function updateColumnVisibility(){
  const ch=$('#channelSelect').value;
  const show={normal:false,promo:false,expire:false,market:false,marketgp:false,t1:false,gp1:false,t2:false,gp2:false,t3:false,gp3:false};
  if(ch==='Flagship'){ show.normal=show.promo=show.expire=true; }
  if(ch==='Marketplace'){ show.market=show.marketgp=true; }
  if(ch==='Dealer'){ show.t1=show.gp1=show.t2=show.gp2=show.t3=show.gp3=true; }
  const map={ 'col-normal':show.normal,'col-promo':show.promo,'col-expire':show.expire,'col-market':show.market,'col-marketgp':show.marketgp,'col-t1':show.t1,'col-gp1':show.gp1,'col-t2':show.t2,'col-gp2':show.gp2,'col-t3':show.t3,'col-gp3':show.gp3 };
  Object.entries(map).forEach(([cls,v])=> $$('.'+cls).forEach(el=>el.classList.toggle('hidden',!v)));
}

/* ================= APPLY DEALER NAMES ================= */
function applyDealerNamesToUI(){
    const dealerNames = appData?.dealerNames || defaultDealerNames;
    const uiIds = ['lblT1', 'lblT2', 'lblT3', 'edLabelT1', 'edLabelT2', 'edLabelT3'];
    uiIds.forEach(id => {
        const el = $(`#${id}`);
        if (el) {
            if (id.includes('T1')) el.textContent = dealerNames.t1 || 'Dealer T1';
            if (id.includes('T2')) el.textContent = dealerNames.t2 || 'Dealer T2';
            if (id.includes('T3')) el.textContent = dealerNames.t3 || 'Dealer T3';
        }
    });
}

/* ================= TABLE & PAGINATION ================= */
function filteredProducts(){
  if (!appData) return [];
  const q=$('#searchInput').value.trim().toLowerCase();
  const ds=$('#dateStart').value, de=$('#dateEnd').value;
  const isFlagship = $('#channelSelect').value==='Flagship';

  const filters = {
    sku: ($('#filter-sku')?.value || '').toLowerCase(),
    brand: ($('#filter-brand')?.value || '').toLowerCase(),
    category: ($('#filter-category')?.value || '').toLowerCase(),
    description: ($('#filter-description')?.value || '').toLowerCase(),
    details: ($('#filter-details')?.value || '').toLowerCase(),
  };

  return appData.products.filter(p=>{
    const generalSearchHit = !q || (p.sku||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q);
    const columnFilterHit = 
        (p.sku || '').toLowerCase().includes(filters.sku) &&
        (p.brand || '').toLowerCase().includes(filters.brand) &&
        (p.category || '').toLowerCase().includes(filters.category) &&
        (p.description || '').toLowerCase().includes(filters.description) &&
        (p.details || '').toLowerCase().includes(filters.details);

    let dateOk = true;
    if(isFlagship && (ds||de)){
      const ex = p.expiresDate ? new Date(p.expiresDate) : null;
      if(!ex) {
        dateOk=false;
      } else {
        if(ds && ex < new Date(ds)) dateOk=false;
        if(de && ex > new Date(de+'T23:59:59')) dateOk=false;
      }
    }
    return generalSearchHit && columnFilterHit && dateOk;
  });
}

function renderPagination(totalItems) {
  const pageBox = $('#pagination');
  pageBox.innerHTML = '';
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  if (totalPages <= 1) return;
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = `px-3 py-1 rounded-lg text-sm border ${currentPage === i ? 'bg-brand.red border-red-700' : 'bg-zinc-800 border-zinc-700 hover:bg-zinc-700'}`;
    btn.onclick = () => { currentPage = i; renderTable(); };
    pageBox.appendChild(btn);
  }
}

function renderTableHeader() {
    const thead = $('#productTHead');
    thead.innerHTML = `
      <tr class="[&>th]:px-3 [&>th]:py-3 text-left">
        <th>SKU<input id="filter-sku" class="filter-input" placeholder="Filter..."></th>
        <th>Brand<input id="filter-brand" class="filter-input" placeholder="Filter..."></th>
        <th>Category<input id="filter-category" class="filter-input" placeholder="Filter..."></th>
        <th class="w-56">Description<input id="filter-description" class="filter-input" placeholder="Filter..."></th>
        <th class="w-56">Details<input id="filter-details" class="filter-input" placeholder="Filter..."></th>
        <th id="thCosts" class="hidden">Costs</th>
        <th class="col-normal">Normal</th>
        <th class="col-promo">Promotion</th>
        <th class="col-expire">Expire Date</th>
        <th class="col-market">Marketplace</th>
        <th class="col-marketgp">Market GP%</th>
        <th class="col-t1"><span id="lblT1"></span></th>
        <th class="col-gp1">GP% T1</th>
        <th class="col-t2"><span id="lblT2"></span></th>
        <th class="col-gp2">GP% T2</th>
        <th class="col-t3"><span id="lblT3"></span></th>
        <th class="col-gp3">GP% T3</th>
        <th class="w-32">Actions</th>
      </tr>
    `;
    $$('.filter-input').forEach(input => {
        input.addEventListener('input', () => { currentPage = 1; renderTable(); });
    });
}

function renderTable(){
  const body=$('#productBody'); body.innerHTML='';
  if(!appData) return;
  const showCosts = (currentUser?.canSeeCosts || ['Host','Admin'].includes(currentUser?.role));
  const canEdit = ['Host','Admin'].includes(currentUser?.role);
  const allFiltered = filteredProducts();
  const paginatedItems = allFiltered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  paginatedItems.forEach(p=>{
    const tr=document.createElement('tr');
    tr.className='border-b border-zinc-800 hover:bg-zinc-800/30';
    let isPromoExpired = false;
    if (p.expiresDate) {
        if (new Date(p.expiresDate) < today) isPromoExpired = true;
    }
    const displayedPromoPrice = isPromoExpired ? '-' : money(p.promoPrice);
    const promoPriceTitle = isPromoExpired ? 'Promotion Expired' : money(p.promoPrice);
    const gpM = gpPct(p.marketplacePrice, p.costs);
    const gp1 = gpPct(p.dealer1, p.costs);
    const gp2 = gpPct(p.dealer2, p.costs);
    const gp3 = gpPct(p.dealer3, p.costs);
    const detailsOneLine=(p.details||'').replace(/\n+/g,' ‚Ä¢ ');

    tr.innerHTML = `
      <td class="px-3 py-3 oneline" title="${p.sku}">${p.sku || '-'}</td>
      <td class="px-3 py-3 oneline" title="${p.brand}">${p.brand || '-'}</td>
      <td class="px-3 py-3 oneline" title="${p.category}">${p.category || '-'}</td>
      <td class="px-3 py-3 oneline" title="${p.description}"><div class="oneline" style="max-width:14rem">${p.description || '-'}</div></td>
      <td class="px-3 py-3 oneline" title="${detailsOneLine}"><div class="oneline" style="max-width:14rem">${detailsOneLine}</div></td>
      <td class="px-3 py-3 ${showCosts?'':'hidden'} oneline" title="${money(p.costs)}">${money(p.costs)}</td>
      <td class="px-3 py-3 col-normal oneline" title="${money(p.normalPrice)}">${money(p.normalPrice)}</td>
      <td class="px-3 py-3 col-promo oneline" title="${promoPriceTitle}" style="color:${isPromoExpired ? '#666' : '#E11D2E'};"><span style="text-decoration:${isPromoExpired ? 'line-through' : 'none'};">${displayedPromoPrice}</span></td>
      <td class="px-3 py-3 col-expire oneline" title="${toDateInput(p.expiresDate)}" style="color:${isPromoExpired ? '#666' : '#E11D2E'};">${toDateInput(p.expiresDate)}</td>
      <td class="px-3 py-3 col-market oneline" title="${money(p.marketplacePrice)}">${money(p.marketplacePrice)}</td>
      <td class="px-3 py-3 col-marketgp oneline" title="${gpM.toFixed(1)}%">${gpM.toFixed(1)}%</td>
      <td class="px-3 py-3 col-t1 oneline" title="${money(p.dealer1)}">${money(p.dealer1)}</td>
      <td class="px-3 py-3 col-gp1 oneline" title="${gp1.toFixed(1)}%">${gp1.toFixed(1)}%</td>
      <td class="px-3 py-3 col-t2 oneline" title="${money(p.dealer2)}">${money(p.dealer2)}</td>
      <td class="px-3 py-3 col-gp2 oneline" title="${gp2.toFixed(1)}%">${gp2.toFixed(1)}%</td>
      <td class="px-3 py-3 col-t3 oneline" title="${money(p.dealer3)}">${money(p.dealer3)}</td>
      <td class="px-3 py-3 col-gp3 oneline" title="${gp3.toFixed(1)}%">${gp3.toFixed(1)}%</td>
      <td class="px-3 py-3">
        ${canEdit? `<div class="flex items-center gap-2"><button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs" data-edit="${p.sku}">Edit</button><button title="Delete" class="px-2 py-1 rounded-xl bg-transparent border border-red-700 hover:bg-red-700/20 text-xs" data-del="${p.sku}">‚ùå</button></div>` : '-'}
      </td>
    `;
    body.appendChild(tr);
  });
  $$('button[data-edit]').forEach(b=>b.addEventListener('click',()=>openEditor(b.getAttribute('data-edit'))));
  $$('button[data-del]').forEach(b=>b.addEventListener('click',()=>{
    const sku=b.getAttribute('data-del');
    if(confirm(`Delete SKU ${sku}? This cannot be undone.`)){
      appData.products = appData.products.filter(x=>x.sku!==sku);
      log('delete_sku', sku);
      updateLocalDataAndSave();
    }
  }));
  renderPagination(allFiltered.length);
  if(currentUser) initFiltersForUser();
}

/* ================= EDITOR ================= */
function openEditor(sku = null) {
  if(!['Host','Admin'].includes(currentUser.role)) return;
  if (sku) {
    editingIndex = appData.products.findIndex(x=>x.sku===sku);
    const p = appData.products[editingIndex];
    $('#editorTitle').textContent = 'Edit Product';
    $('#edSku').value = p.sku;
    $('#edSku').disabled = true;
    $('#edBrand').value = p.brand || '';
    $('#edCategory').value = p.category || '';
    $('#edDesc').value = p.description || '';
    $('#edDetails').value = p.details || '';
    $('#edExpire').value = toDateInput(p.expiresDate);
    $('#edCosts').value = p.costs || '';
    $('#edNormal').value = p.normalPrice || '';
    $('#edPromo').value = p.promoPrice || '';
    $('#edMarket').value = p.marketplacePrice || '';
    $('#edT1').value = p.dealer1 || '';
    $('#edT2').value = p.dealer2 || '';
    $('#edT3').value = p.dealer3 || '';
  } else {
    editingIndex = -1;
    $('#editorTitle').textContent = 'Add New Product';
    $('#edSku').value = '';
    $('#edSku').disabled = false;
    $('#edBrand').value = '';
    $('#edCategory').value = '';
    $('#edDesc').value = '';
    $('#edDetails').value = '';
    $('#edExpire').value = '';
    $('#edCosts').value = '';
    $('#edNormal').value = '';
    $('#edPromo').value = '';
    $('#edMarket').value = '';
    $('#edT1').value = '';
    $('#edT2').value = '';
    $('#edT3').value = '';
  }
  applyDealerNamesToUI();
  $('#editorModal').classList.remove('hidden');
}

function closeEditor(){ $('#editorModal').classList.add('hidden'); }

async function saveEditor() {
  const sku = $('#edSku').value.trim();
  if (!sku) { alert('SKU is required.'); return; }
  const newProductData = {
    sku: sku,
    brand:$('#edBrand').value.trim(),
    category:$('#edCategory').value.trim(),
    description:$('#edDesc').value.trim(), 
    details:$('#edDetails').value.trim(),
    expiresDate:$('#edExpire').value||'', 
    costs:parseFloat($('#edCosts').value)||0,
    normalPrice:parseFloat($('#edNormal').value)||0, 
    promoPrice:parseFloat($('#edPromo').value)||0,
    marketplacePrice:parseFloat($('#edMarket').value)||0, 
    dealer1:parseFloat($('#edT1').value)||0,
    dealer2:parseFloat($('#edT2').value)||0, 
    dealer3:parseFloat($('#edT3').value)||0
  };

  if (editingIndex > -1) {
    Object.assign(appData.products[editingIndex], newProductData);
    log('edit_product', sku);
  } else {
    if (appData.products.some(p => p.sku === sku)) {
      alert(`SKU "${sku}" already exists.`); return;
    }
    appData.products.unshift(newProductData);
    log('add_product', sku);
  }
  
  closeEditor();
  updateLocalDataAndSave();
}

/* ================= SETTINGS ================= */
function openSettings(tab){
  if(!['Host','Admin'].includes(currentUser.role)) return;
  $('#settingsPanel').classList.remove('hidden');
  renderSettings(tab);
}
function fileToBase64(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

function renderSettings(tab){
  const box=$('#settingsContent');
  $$('.set-tab').forEach(b=>b.classList.remove('ring-2','ring-brand.red'));
  const btn=$(`.set-tab[data-tab="${tab}"]`); if(btn) btn.classList.add('ring-2','ring-brand.red');
  const isHost=currentUser.role==='Host';
  $$('.only-host').forEach(el=>el.classList.toggle('hidden', !isHost));
  $$('.only-host-admin').forEach(el=>el.classList.toggle('hidden', !['Host','Admin'].includes(currentUser.role)));

  if(tab==='data'){
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Master Data</div>
      <div class="text-zinc-400 mb-4">Import or Export the main product data file. This file contains all product information except for promotion prices and expiry dates.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Import Master File (.xlsx)</div>
          <input id="fileImportMaster" type="file" accept=".xlsx,.xls" class="w-full">
          <p class="text-xs text-zinc-400 mt-2">Columns: A SKU, B Brand, C Category, D Description, E Details, F Costs, G Normal, H Marketplace, I Dealer T1, J Dealer T2, K Dealer T3</p>
          <button id="btnDoImportMaster" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Import Master</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Export Master File (.xlsx)</div>
          <button id="btnExportMaster" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Export Master</button>
          <p class="text-xs text-zinc-400 mt-2">Exports all product data without promotion columns.</p>
        </div>
      </div>
    `;
    $('#btnDoImportMaster').onclick=doImportMaster;
    $('#btnExportMaster').onclick=doExportMaster;
  }
  if(tab==='promo'){
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Promotion Data</div>
      <div class="text-zinc-400 mb-4">Import or Export promotion-specific data. Importing will update existing SKUs with new promotion prices and expiry dates.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Import Promotion File (.xlsx)</div>
          <input id="fileImportPromo" type="file" accept=".xlsx,.xls" class="w-full">
          <p class="text-xs text-zinc-400 mt-2">Columns: A SKU, B Description, C Normal Price, D Promotion Price, E Expires Date</p>
          <button id="btnDoImportPromo" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Import Promotion</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
          <div>
            <div class="font-semibold mb-2">Export Promotion File (.xlsx)</div>
            <button id="btnExportPromo" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Export Promotion</button>
            <p class="text-xs text-zinc-400 mt-2">Exports only SKUs with their promotion data.</p>
          </div>
          <div>
            <div class="font-semibold mb-2">Promotion Report</div>
            <button id="btnReportExpired" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Report Promotion Expire</button>
            <p class="text-xs text-zinc-400 mt-2">Generates a list of products with expired promotions.</p>
          </div>
        </div>
      </div>
    `;
    $('#btnDoImportPromo').onclick=doImportPromo;
    $('#btnExportPromo').onclick=doExportPromo;
    $('#btnReportExpired').onclick=showExpiredPromoReport;
  }
  // You can paste the original code for other tabs ('logo', 'dealer', 'users', 'templates', 'cloud', 'history') here.
}

/* ================= IMPORT / EXPORT ================= */
async function doImportMaster(){
  const fi=$('#fileImportMaster'); if(!fi.files[0]) return alert('Choose a file');
  try {
    const data=await fi.files[0].arrayBuffer();
    const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    let headerRowIndex = rows.findIndex(row => (row[0] || '').toString().toLowerCase().trim() === 'sku');
    if (headerRowIndex === -1) { return alert('Error: Cannot find header row "SKU".'); }
    const start=headerRowIndex + 1;
    const newItems=[], existingSkus = new Set(appData.products.map(p => p.sku));
    let skippedCount = 0;
    for(let i=start;i<rows.length;i++){
      const r=rows[i]; const sku = (r[0]||'').toString().trim(); if(!sku) continue;
      if (existingSkus.has(sku)) { skippedCount++; continue; }
      existingSkus.add(sku);
      newItems.push({
        sku, brand: (r[1] || '').toString().trim(), category: (r[2] || '').toString().trim(),
        description: (r[3] || '').toString().trim(), details: (r[4] || '').toString().trim(),
        costs: parseFloat(r[5] || 0) || 0, normalPrice: parseFloat(r[6] || 0) || 0,
        marketplacePrice: parseFloat(r[7] || 0) || 0, dealer1: parseFloat(r[8] || 0) || 0,
        dealer2: parseFloat(r[9] || 0) || 0, dealer3: parseFloat(r[10] || 0) || 0,
        promoPrice: 0, expiresDate: ''
      });
    }
    if(!newItems.length && skippedCount === 0) return alert('No new valid products found to import.');
    appData.products=[...newItems, ...appData.products];
    log('import_master', `${newItems.length} rows`);
    alert(`Import complete.\n- New products added: ${newItems.length}\n- Existing SKUs skipped: ${skippedCount}`);
    updateLocalDataAndSave();
  } catch(e){ alert('An error occurred during import: ' + e.message); }
}
async function doExportMaster(){
  const wb=await XlsxPopulate.fromBlankAsync(); const sh=wb.sheet(0).name('MasterPriceData');
  const header=['SKU','Brand','Category','Description','Details','Costs','Normal Price','Marketplace Price','Marketplace GP%','Dealer Price Tier 1','GP% T1','Dealer Price Tier 2','GP% T2','Dealer Price Tier 3','GP% T3'];
  const dataRows = appData.products.map(p=>[
    p.sku,p.brand,p.category,p.description,p.details,p.costs,p.normalPrice,
    p.marketplacePrice, +gpPct(p.marketplacePrice,p.costs).toFixed(2),
    p.dealer1, +gpPct(p.dealer1,p.costs).toFixed(2), p.dealer2, +gpPct(p.dealer2,p.costs).toFixed(2),
    p.dealer3, +gpPct(p.dealer3,p.costs).toFixed(2)
  ]);
  sh.cell('A1').value([header,...dataRows]);
  sh.row(1).style({bold:true});
  if(dataRows.length > 0) sh.range(`F2:F${dataRows.length+1}`).style({fill:'FFCCFFCC'});
  [15,20,20,30,40,12,14,16,14,14,12,14,12,14,12].forEach((w,i)=>sh.column(i+1).width(w));
  const blob=await wb.outputAsync();
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='master_price_data.xlsx'; a.click(); a.remove(); URL.revokeObjectURL(url);
  log('export_master', `${appData.products.length} rows`);
}
async function doImportPromo() {
    const fi = $('#fileImportPromo'); if (!fi.files[0]) return alert('Choose a file');
    try {
        const data = await fi.files[0].arrayBuffer();
        const wb = XLSX.read(data, { type: 'array' }); const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        let headerRowIndex = rows.findIndex(row => (row[0] || '').toString().toLowerCase().trim() === 'sku');
        if (headerRowIndex === -1) { return alert('Error: Cannot find header row "SKU".'); }
        const start = headerRowIndex + 1;
        let updatedCount = 0; let notFoundCount = 0;
        const productMap = new Map(appData.products.map(p => [p.sku, p]));
        for (let i = start; i < rows.length; i++) {
            const r = rows[i]; const sku = (r[0] || '').toString().trim(); if (!sku) continue;
            const product = productMap.get(sku);
            if (product) {
                product.promoPrice = parseFloat(r[3] || 0) || 0;
                product.expiresDate = fromExcelDate(r[4] || '');
                updatedCount++;
            } else { notFoundCount++; }
        }
        log('import_promo', `${updatedCount} rows updated`);
        alert(`Promotion import complete.\n- Products updated: ${updatedCount}\n- SKUs not found: ${notFoundCount}`);
        updateLocalDataAndSave();
    } catch(e){ alert('An error occurred during import: ' + e.message); }
}
async function doExportPromo() {
    const wb = await XlsxPopulate.fromBlankAsync(); const sh = wb.sheet(0).name('PromotionData');
    const header = ['SKU', 'Description', 'Normal Price', 'Promotion Price', 'Expires Date', 'Promotion GP%'];
    const dataRows = appData.products.map(p => [
        p.sku, p.description, p.normalPrice, p.promoPrice,
        p.expiresDate ? toDateInput(p.expiresDate) : '', +gpPct(p.promoPrice, p.costs).toFixed(2)
    ]);
    sh.cell('A1').value([header, ...dataRows]);
    sh.row(1).style({ bold: true });
    if(dataRows.length > 0) sh.range(`D2:E${dataRows.length+1}`).style({fill:'FFFFFF99'});
    [15, 30, 14, 16, 16, 14].forEach((w, i) => sh.column(i + 1).width(w));
    const blob = await wb.outputAsync();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'promotion_data.xlsx'; a.click(); a.remove(); URL.revokeObjectURL(url);
    log('export_promo', `${appData.products.length} rows`);
}
function showExpiredPromoReport() {
    const today = new Date(); today.setHours(0, 0, 0, 0);
    const expiredProducts = appData.products.filter(p => p.expiresDate && new Date(p.expiresDate) < today);
    if (expiredProducts.length === 0) return alert('No expired promotions found.');
    const reportText = expiredProducts
        .map(p => `SKU: ${p.sku}\nDesc: ${ellip(p.description, 40)}\nExpired: ${toDateInput(p.expiresDate)}\n--------------------`)
        .join('\n');
    alert(`--- Expired Promotions Report ---\n\n${reportText}`);
    log('report_expired_promo', `${expiredProducts.length} items`);
}

/* ================= PRINT FLOW ================= */
// Original print functions from the user's file, with the 'openPrintTab' style fix applied.
function togglePrintModal(show){ $('#printModal').classList.toggle('hidden', !show); }
function buildPrintList(){
  const box=$('#printList'); box.innerHTML='';
  const items=filteredProducts();
  const frag=document.createDocumentFragment();
  items.forEach(p=>{
    const row=document.createElement('div');
    row.className='flex items-center gap-3 bg-zinc-900/60 border border-zinc-800 rounded-2xl p-2';
    row.innerHTML=`
      <label class="flex items-center gap-2 w-6"><input type="checkbox" data-sel="${p.sku}"></label>
      <div class="flex-1">
        <div class="font-medium oneline" title="${p.sku}">${p.sku}</div>
        <div class="text-xs text-zinc-400 oneline" title="${p.description}">${ellip(p.description, 46)}</div>
      </div>
      <div class="flex items-center gap-1">
        <span class="text-xs text-zinc-400">Qty</span>
        <input type="number" min="1" value="1" data-qty="${p.sku}" class="w-20 px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
      </div>
    `;
    frag.appendChild(row);
  });
  box.appendChild(frag);
  $('#printCheckAll').checked=false;
  $('#printCheckAll').onchange=()=> $$('#printList input[type="checkbox"]').forEach(c=>c.checked=$('#printCheckAll').checked);
  $('#printSearch').oninput=()=>{
    const q=$('#printSearch').value.toLowerCase();
    $$('#printList > div').forEach(div=>{
      const sku=div.querySelector('[data-sel]').getAttribute('data-sel').toLowerCase();
      const desc=div.querySelector('.text-xs').getAttribute('title').toLowerCase();
      div.style.display = (!q || sku.includes(q) || desc.includes(q)) ? '' : 'none';
    });
  };
  updatePrintSummary();
  $$('#printList input').forEach(i=>i.oninput=updatePrintSummary);
}
function updatePrintSummary(){
  const selected=$$('#printList input[type="checkbox"]:checked');
  let count=0; selected.forEach(c=>{ const sku=c.getAttribute('data-sel'); const qty=parseInt($(`[data-qty="${sku}"]`).value)||0; count+=qty; });
  $('#printSummary').textContent = `${selected.length} SKUs selected ‚Ä¢ ${count} tags total`;
}
function fillTemplateDropdown(){
  const dd=$('#printTemplate'); dd.innerHTML='';
  appData.templates.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; dd.appendChild(o); });
  dd.onchange=()=>{ 
    const firstSelectedSku = $('#printList input[type="checkbox"]:checked')?.getAttribute('data-sel');
    const firstItem = appData.products.find(p => p.sku === firstSelectedSku) || filteredProducts()[0];
    renderPreview(firstItem, appData.templates.find(t=>t.id===dd.value)); 
  };
}
function renderPreview(item, tpl){
    // This function is from the original file and doesn't need changes.
}
function renderTagInnerHTML(p, tpl){
    // This function is from the original file and doesn't need changes.
}
function openPrintTab(list,tpl){
  const items=[]; list.forEach(({p,qty})=>{ for(let i=0;i<qty;i++) items.push(p); });
  if(!items.length){ alert('Select at least one SKU.'); return; }
  const w=window.open('', '_blank');
  if(!w){ alert('Pop-up blocked. Please allow pop-ups and click "Open Print Page" again.'); return; }
  const logo=appData.logo||'';
  let cols=1, rows=1, pad='8mm', pageSize='A4';
  if(tpl.kind === 'IMAGE') { cols = 1; rows = 1; pad = '0mm'; pageSize = 'A4'; }
  else if(tpl.kind==='A4'){ cols=1; rows=1; pad='10mm'; pageSize='A4'; }
  else if(tpl.kind==='A5'){ cols=2; rows=1; pad='10mm'; pageSize='A4 landscape'; }
  else if(tpl.kind==='A6'){ cols=2; rows=2; pad='8mm'; pageSize='A4'; }
  else { cols=2; rows=6; pad='6mm'; pageSize='A4'; }

  const style=`
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      @page { size: ${pageSize}; margin: 0; }
      html,body{ background:#fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-family:'Kanit','Prompt',sans-serif; margin: 0; padding: 0; }
      .sheet{ width: ${pageSize.includes('landscape') ? '297mm' : '210mm'}; height: ${pageSize.includes('landscape') ? '210mm' : '297mm'}; margin: 0; display: grid; grid-template-columns: repeat(${cols}, 1fr); grid-template-rows: repeat(${rows}, 1fr); gap: 0; page-break-after: always; box-sizing: border-box; }
      .tag{ width:100%; height:100%; padding:${pad}; box-sizing:border-box; position:relative; display: flex; align-items: center; justify-content: center;}
      .card{ position:relative; width:100%; height:100%; border-radius:12px; overflow:hidden; border:2px solid #1f1f22; background-color:${tpl.imageData ? 'transparent' : (tpl.kind==='ACC'?'#000':'#0b0b0c')}; color:#fff; background-image: ${tpl.imageData ? `url(${tpl.imageData})` : 'none'}; background-size: cover; background-position: center; }
      .logo{ position:absolute; }
      .text-elevate{ text-shadow: 0 1px 2px rgba(0,0,0,.9), 0 0 1px rgba(0,0,0,.7); }
    </style>
  `;
  const perSheet = cols*rows;
  const pages=[]; for(let i=0;i<items.length;i+=perSheet) pages.push(items.slice(i,i+perSheet));
  const body = pages.map(pg=>{
    const inner=pg.map(p=>{
      let logoTag = '';
      if(tpl.showLogo && logo) {
        const logoSize = tpl.logoStyles?.size || 64;
        const logoMargin = tpl.logoStyles?.margin || 10;
        logoTag = `<img src="${logo}" class="logo" style="right:${logoMargin}px;top:${logoMargin}px;width:${logoSize}px;height:auto;">`;
      }
      const content = renderTagInnerHTML(p, tpl);
      return `<div class="tag"><div class="card">${logoTag}${content}</div></div>`;
    }).join('');
    return `<div class="sheet">${inner}</div>`;
  }).join('');
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Print</title>${style}</head><body>${body}</body></html>`);
  w.document.close();
  w.focus(); 
  setTimeout(() => w.print(), 500);
  log('open_print', `${items.length} tags, tpl=${tpl.name}`);
}

/* ================= EVENTS BINDING (COMPLETE) ================= */
function bindEvents() {
  $('#btnCreateHost').addEventListener('click', async () => {
    const pass = $('#setupPass').value;
    if (pass !== $('#setupPassConfirm').value || !pass) return alert('Passwords do not match or are empty.');
    if (pass.length < 4) return alert('Password must be at least 4 characters long.');
    if (!appData) appData = JSON.parse(JSON.stringify(defaultAppState));
    appData.users = [{
        username: 'host', passwordHash: await hashPassword(pass), role: 'Host',
        channels: [...Channels], canSeeCosts: true, canPrint: true
    }];
    const gistId = localStorage.getItem(LS.GIST_ID);
    const token = localStorage.getItem(LS.TOKEN);
    if(gistId && token) {
        try {
            await cloudSave(gistId, token);
            alert('Host account created and saved to cloud. Please log in.');
            $('#setupView').classList.add('hidden');
            $('#loginView').classList.remove('hidden');
        } catch (e) { alert('Failed to save host account to cloud: ' + e.message); }
    } else { alert('Error: Gist credentials not found. Cannot save host account.'); }
  });

  $('#btnLogin').addEventListener('click', login);
  $('#loginPass').addEventListener('keydown', (e) => { if (e.key === 'Enter') login(); });

  $('#btnCloudCreate').addEventListener('click', async () => {
    const token = $('#cloudToken').value.trim();
    if(!token) return alert('GitHub Token is required.');
    try {
      const gistId = await cloudCreateGist(token, defaultAppState);
      alert('Gist created successfully with ID: '+gistId + '\nPlease proceed to create the host account.');
      appData = JSON.parse(JSON.stringify(defaultAppState));
      $('#cloudSetupView').classList.add('hidden');
      $('#setupView').classList.remove('hidden');
    } catch(e) { alert('Error creating Gist: ' + e.message); }
  });

  $('#btnCloudLoad').addEventListener('click', async () => {
    const token = $('#cloudToken').value.trim();
    const gistId = $('#cloudGistId').value.trim();
    if(!token || !gistId) return alert('GitHub Token and Gist ID are required to load.');
    try {
      await cloudLoad(gistId, token);
      alert('Loaded data from existing Gist successfully. Please log in.');
      $('#cloudSetupView').classList.add('hidden');
      $('#loginView').classList.remove('hidden');
    } catch(e) { alert('Error loading from Gist: ' + e.message); }
  });

  $('#btnLogout').addEventListener('click', logout);
  $('#btnNewProduct').addEventListener('click', () => openEditor());
  $('#btnSettings').addEventListener('click',()=>openSettings('data'));
  $('#btnPrintModal').addEventListener('click', () => {
    if(!currentUser.canPrint) return; 
    buildPrintList(); fillTemplateDropdown();
    const firstItem = filteredProducts()[0];
    const defaultTemplate = appData.templates.find(t=>t.id===$('#printTemplate').value) || appData.templates[0];
    renderPreview(firstItem, defaultTemplate); 
    togglePrintModal(true);
  });
  ['#searchInput','#dateStart','#dateEnd', '#channelSelect'].forEach(s=>$(s).addEventListener('input', ()=>{ currentPage = 1; renderTable(); }));
  $('#btnCloseSettings').addEventListener('click', ()=>$('#settingsPanel').classList.add('hidden'));
  $$('.set-tab').forEach(b=>b.addEventListener('click', ()=>openSettings(b.dataset.tab)));
  $('#btnCloseEditor').addEventListener('click', closeEditor);
  $('#btnSaveEd').addEventListener('click', saveEditor);
  $('#btnClosePrintModal').addEventListener('click', () => togglePrintModal(false));
  $('#btnOpenPrint').addEventListener('click', () => {
    const picks=$$('#printList input[type="checkbox"]:checked').map(c=>c.getAttribute('data-sel'));
    const list=picks.map(sku=>appData.products.find(p=>p.sku===sku)).filter(Boolean).map(p=>({p,qty:parseInt($(`[data-qty="${p.sku}"]`).value)||1}));
    const tpl=appData.templates.find(t=>t.id===$('#printTemplate').value) || appData.templates[0];
    openPrintTab(list,tpl);
  });
  window.addEventListener('keydown', e => { if((e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); $('#searchInput').focus(); }});
}

/* ================= STARTUP LOGIC ================= */
async function initialCheck() {
    const gistId = localStorage.getItem(LS.GIST_ID);
    const token = localStorage.getItem(LS.TOKEN);
    if (gistId && token) {
        try {
            await cloudLoad(gistId, token);
            $('#cloudSetupView').classList.add('hidden');
            if (appData.users && appData.users.length > 0) {
                $('#loginView').classList.remove('hidden');
            } else {
                $('#setupView').classList.remove('hidden');
            }
        } catch(e) {
            localStorage.removeItem(LS.GIST_ID);
            localStorage.removeItem(LS.TOKEN);
            $('#cloudSetupView').classList.remove('hidden');
            alert("Cloud load failed, credentials cleared. Please set up again. Error: " + e.message);
        }
    } else {
        $('#cloudSetupView').classList.remove('hidden');
    }
}

function init() {
  bindEvents();
  initialCheck();
}

init();
</script>

</body>
</html>
