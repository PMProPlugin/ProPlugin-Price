<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ProPlugin ‚Ä¢ ProPricing</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        fontFamily: { sans: ['Kanit','Prompt','system-ui','sans-serif'] },
        colors: { brand: { dark:'#0b0b0c', red:'#E11D2E' } },
        boxShadow: { soft: '0 6px 18px rgba(0,0,0,.25)' }
      }
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

<style>
  :root { color-scheme: dark; }
  html,body{ height:100%; background:#0b0b0c }
  ::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#222;border-radius:10px}
  .oneline{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .text-elevate{ text-shadow:0 1px 2px rgba(0,0,0,.9),0 0 1px rgba(0,0,0,.7) }
  @media print { .no-print{display:none!important} .print-only{display:block} }
  
  .filter-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    margin-left: 6px;
    border-radius: 4px;
    background-color: #333;
    border: 1px solid #555;
    transition: background-color 0.2s;
    vertical-align: middle;
  }
  .filter-btn:hover { background-color: #444; }
  .filter-btn.active { background-color: #E11D2E; border-color: #ff5566; }
  .filter-dropdown {
    display: none;
    position: absolute;
    z-index: 50;
    background-color: #18181b;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 8px;
    margin-top: 4px;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    min-width: 200px;
  }
  .filter-dropdown-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
</style>
</head>

<body class="text-white font-sans">

<section id="setupView" class="hidden min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">First-Time Setup</div>
    </div>
    <div class="text-zinc-400 mb-4">Please create the primary 'host' account to begin.</div>
    <label class="text-sm text-zinc-400">Username</label>
    <input id="setupUser" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" value="host" disabled />
    <label class="text-sm text-zinc-400 mt-4 block">Choose a strong password</label>
    <input id="setupPass" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="password" />
    <label class="text-sm text-zinc-400 mt-4 block">Confirm password</label>
    <input id="setupPassConfirm" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="confirm password" />
    <button id="btnCreateHost" class="mt-6 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Create Host Account</button>
  </div>
</section>

<section id="loginView" class="hidden min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">ProPlugin ‚Ä¢ ProPricing</div>
    </div>
    <label class="text-sm text-zinc-400">Username</label>
    <input id="loginUser" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="username" />
    <label class="text-sm text-zinc-400 mt-4 block">Password</label>
    <input id="loginPass" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="password" />
    <button id="btnLogin" class="mt-6 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Sign in</button>
  </div>
</section>

<section id="cloudSetupView" class="min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
       <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">Cloud Setup</div>
    </div>
    <p class="text-zinc-400 mb-4">Please set up GitHub Gist for cloud storage. You can create a new Gist or load from an existing one.</p>
    <label class="text-sm text-zinc-400">GitHub Personal Access Token (scope: gist)</label>
    <input id="cloudToken" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="ghp_..." />
    <label class="text-sm text-zinc-400 mt-4 block">Gist ID (optional for new Gist)</label>
    <input id="cloudGistId" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="e.g. a1b2c3d4..." />
    <div class="flex flex-col gap-4 mt-6">
      <button id="btnCloudCreate" class="w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Create New Gist</button>
      <button id="btnCloudLoad" class="w-full py-3 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 font-semibold">Load from Existing Gist</button>
    </div>
  </div>
</section>

<section id="appView" class="hidden min-h-screen">
  <header class="sticky top-0 z-40 bg-brand.dark/95 backdrop-blur border-b border-zinc-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-3">
        <div id="logoBox" class="w-10 h-10 rounded-xl bg-zinc-100 text-brand.dark font-black grid place-items-center overflow-hidden select-none">
          <span id="logoFallback">P</span>
          <img id="logoImg" class="hidden w-full h-full object-contain" alt="logo">
        </div>
        <div class="text-xl sm:text-2xl font-semibold tracking-wide">ProPricing</div>
        <span id="roleBadge" class="ml-2 text-xs px-2 py-1 rounded bg-zinc-800 border border-zinc-700"></span>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnSettings" class="hidden px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm">‚öôÔ∏è</button>
        <button id="btnLogout" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm">Sign out</button>
      </div>
    </div>
    <div class="max-w-7xl mx-auto px-4 pb-4 flex flex-col lg:flex-row gap-3">
      <div class="relative flex-1">
        <input id="searchInput" class="w-full text-xl sm:text-2xl px-5 py-4 rounded-2xl border border-zinc-700 bg-zinc-900 text-white focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="Search (SKU / Product Name)" />
        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500">üîé</div>
      </div>
      <select id="channelSelect" class="px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red"></select>
      <div class="px-3 py-2 rounded-2xl bg-zinc-950 border border-zinc-700 flex items-center gap-2">
        <span class="text-sm text-zinc-400">Date range</span>
        <input id="dateStart" type="date" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
        <span class="text-zinc-500">‚Üí</span>
        <input id="dateEnd" type="date" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
      </div>
      <button id="btnNewProduct" class="px-5 py-3 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 font-semibold">Add +</button>
      <button id="btnPrintModal" class="px-5 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Print</button>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="overflow-auto border border-zinc-800 rounded-2xl">
      <table class="min-w-[1800px] w-full text-sm">
        <thead id="productTHead" class="bg-zinc-900/70 border-b border-zinc-800 sticky top-0"></thead>
        <tbody id="productBody" class="[&>tr:nth-child(odd)]:bg-zinc-900/40"></tbody>
      </table>
    </div>
    <div id="pagination" class="mt-4 flex justify-center items-center gap-2"></div>
  </main>
</section>

<div id="settingsPanel" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm">
  <div class="absolute inset-4 bg-zinc-950/95 border border-zinc-800 rounded-2xl overflow-hidden grid grid-cols-[260px_1fr]">
    <aside class="bg-zinc-900/60 border-r border-zinc-800 p-3 space-y-2">
      <div class="text-sm text-zinc-400 px-2">Settings</div>
      <button data-tab="data" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Master Data</button>
      <button data-tab="promo" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Promotion</button>
      <button data-tab="logo" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Logo</button>
      <button data-tab="dealer" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Dealer Settings</button>
      <button data-tab="users" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">User Management</button>
      <button data-tab="templates" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Template Management</button>
      <button data-tab="cloud" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Cloud Sync</button>
      <button data-tab="history" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Usage History</button>
      <div class="absolute bottom-3 left-3 right-3">
        <button id="btnCloseSettings" class="w-full text-sm px-2 py-1.5 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">Close</button>
      </div>
    </aside>
    <section id="settingsContent" class="p-6 overflow-auto"></section>
  </div>
</div>

<div id="editorModal" class="hidden fixed inset-0 z-[70] bg-black/70">
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
      <div id="editorTitle" class="text-xl font-semibold">Edit Product</div>
      <button id="btnCloseEditor" class="px-3 py-1 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>
    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-auto h-[calc(100%-100px)]">
      <div class="space-y-4">
        <div><label class="text-sm text-zinc-400">SKU</label><input id="edSku" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Description</label><input id="edDesc" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Details</label><textarea id="edDetails" rows="4" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></textarea></div>
        <div><label class="text-sm text-zinc-400">Brand</label><input id="edBrand" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Category</label><input id="edCategory" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
      </div>
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-sm text-zinc-400">Costs</label><input id="edCosts" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Normal Price</label><input id="edNormal" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Promotion Price</label><input id="edPromo" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
           <div><label class="text-sm text-zinc-400">Expires Date</label><input id="edExpire" type="date" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Marketplace Price</label><input id="edMarket" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT1">Dealer T1</span></label><input id="edT1" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT2">Dealer T2</span></label><input id="edT2" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT3">Dealer T3</span></label><input id="edT3" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        </div>
        <button id="btnSaveEd" class="w-full mt-2 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="printModal" class="hidden fixed inset-0 z-[80] bg-black/70">
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl grid grid-rows-[auto_1fr] grid-cols-[480px_1fr] min-h-0">
    <div class="col-span-2 sticky top-0 z-10 bg-zinc-950 border-b border-zinc-800 p-4 flex items-center justify-between">
      <div class="text-xl font-semibold">Print Price Tags</div>
      <button id="btnClosePrintModal" class="px-3 py-1.5 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>
    <div class="p-4 border-r border-zinc-800 space-y-4 overflow-auto">
      <div class="sticky top-0 bg-zinc-950 border-b border-zinc-800 pb-3 z-10">
        <div class="grid grid-cols-[1fr_auto] gap-2">
          <select id="printTemplate" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></select>
          <button id="btnOpenPrint" class="px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Open Print Page</button>
        </div>
        <div class="mt-3 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-800 flex items-center gap-2">
          <input id="printSearch" class="flex-1 bg-transparent outline-none" placeholder="Search in list‚Ä¶">
          <label class="text-sm"><input type="checkbox" id="printCheckAll"> <span class="text-zinc-300">Select all</span></label>
        </div>
        <div class="text-sm text-zinc-400 mt-2">Select products and set qty per SKU</div>
      </div>
      <div id="printList" class="space-y-2 pt-2"></div>
      <div id="printSummary" class="text-sm text-zinc-400"></div>
    </div>
    <div class="flex flex-col w-full h-full min-h-0 min-w-0 p-4 overflow-hidden">
      <div class="text-sm text-zinc-400 mb-2 shrink-0">Live preview of the first selected item</div>
      <div id="previewBox" class="bg-zinc-900 rounded-2xl border border-zinc-800 flex-1 w-full h-full min-h-0 min-w-0 relative flex items-center justify-center overflow-hidden"></div>
    </div>
  </div>
</div>

<script>
/* ================= CORE STATE / STORAGE ================= */
const LS = {
  GIST_ID: 'pp_cloud_gist_id_v2',
  TOKEN: 'pp_cloud_token_v2',
};
const defaultDealerNames = {t1:'Dealer T1', t2:'Dealer T2', t3:'Dealer T3'};
const Channels = ['Flagship','Marketplace','Dealer'];

const sampleProducts = [{
  sku:'MP-00010',
  brand:'iCon Pro Audio',
  category:'Audio Interface',
  description:'iCon Pro Audio GoLive Pro',
  details:'Audio interface for live streaming with remote control\\n24-bit/48kHz with onboard DSP (Reverb, EQ, Vocal Tune)\\nBuilt-in 5000mAh battery up to 6 hours\\nMic input mini-XLR (48V) & 1/4-inch\\nBluetooth for music & control',
  costs:4200, normalPrice:7990, promoPrice:5990, expiresDate:'2099-09-09',
  marketplacePrice:5990, dealer1:5600, dealer2:5400, dealer3:5200
}];

const defaultAppState = {
    version: 2.6,
    products: sampleProducts,
    templates: [
        { id:'t-a4',  name:'A4 (1 per sheet)', kind:'A4',  showLogo:true, imageData:null, logoStyles: { size: 64, margin: 10 },
          styles:{ sku:{fs:16,color:'#ffffff',mt:0}, description:{fs:30,color:'#ffffff',mt:0}, details:{fs:14,color:'#ffffff',mt:0}, price:{fs:72,color:'#ffffff',mt:0}, oldPrice:{fs:20,color:'#ff4d4f',mt:0}, expire:{fs:13,color:'#ffffff',mt:0} } },
        { id:'t-a5',  name:'A5 (2 per A4 landscape)', kind:'A5',  showLogo:true, imageData:null, logoStyles: { size: 50, margin: 8 },
          styles:{ sku:{fs:14,color:'#ffffff',mt:0}, description:{fs:26,color:'#ffffff',mt:0}, details:{fs:13,color:'#ffffff',mt:0}, price:{fs:60,color:'#ffffff',mt:0}, oldPrice:{fs:18,color:'#ff4d4f',mt:0}, expire:{fs:12,color:'#ffffff',mt:0} } },
        { id:'t-a6',  name:'A6 (4 per sheet)', kind:'A6',  showLogo:true, imageData:null, logoStyles: { size: 40, margin: 6 },
          styles:{ sku:{fs:12,color:'#ffffff',mt:0}, description:{fs:22,color:'#ffffff',mt:0}, details:{fs:12,color:'#ffffff',mt:0}, price:{fs:48,color:'#ffffff',mt:0}, oldPrice:{fs:16,color:'#ff4d4f',mt:0}, expire:{fs:11,color:'#ffffff',mt:0} } },
        { id:'t-acc', name:'Accessories (12 per sheet)', kind:'ACC', showLogo:true, imageData:null, logoStyles: { size: 30, margin: 4 },
          styles:{ sku:{fs:11,color:'#ffffff',mt:2}, description:{fs:15,color:'#ffffff',mt:0, align:'center'}, price:{fs:22,color:'#ffffff',mt:0}, oldPrice:{fs:12,color:'#B91C1C',mt:0}, expire:{fs:10,color:'#ffffff',mt:0} } }
    ],
    dealerNames: defaultDealerNames,
    users: [],
    logo: '',
    logs: []
};

let appData = null;
let currentUser = null;
let editingIndex = -1;
let currentPage = 1;
const itemsPerPage = 20;

let columnFilters = {};

/* ================= UTILITIES ================= */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const money = n => isFinite(n) && n > 0 ? n.toLocaleString('th-TH',{maximumFractionDigits:0}) : '-';
const toDateInput = v => v ? new Date(v).toISOString().slice(0,10) : '';
const fromExcelDate = v => {
  if (v instanceof Date) return v.toISOString().slice(0,10);
  if (typeof v==='number'){ const d=new Date(Math.round((v-25569)*86400*1000)); return d.toISOString().slice(0,10); }
  if (typeof v==='string' && /^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  return '';
};
const gpPct = (price,cost)=> (cost > 0 && price > 0 ? ((price - cost) / cost) * 100 : 0);
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
const ellip = (s,max=40)=> !s ? '' : (s.length<=max? s : s.slice(0,max-3)+'...');

function log(action, meta = '') {
  if (!appData) return;
  if(!appData.logs) appData.logs = [];
  appData.logs.unshift({ ts: new Date().toISOString(), user: currentUser?.username || '-', action, meta });
  if (appData.logs.length > 3000) appData.logs.pop();
}

function updateLocalDataAndSave(newData) {
    if (newData) appData = newData;
    renderTableHeader();
    renderTable();
    applyDealerNamesToUI();
    if (appData.logo) {
        $('#logoImg').src = appData.logo;
        $('#logoImg').classList.remove('hidden');
        $('#logoFallback').classList.add('hidden');
    } else {
        $('#logoImg').classList.add('hidden');
        $('#logoFallback').classList.remove('hidden');
    }
    const gistId = localStorage.getItem(LS.GIST_ID);
    const token = localStorage.getItem(LS.TOKEN);
    if (currentUser?.role === 'Host' && gistId && token) {
        cloudSave(gistId, token).catch(e => console.error("Auto-save failed:", e));
    }
}

/* ================= CLOUD SYNC (GitHub Gist) ================= */
async function gistRequest(method, path, body, token){
  if(!token) throw new Error('GitHub Token is required for this operation.');
  const headers = { 'Accept':'application/vnd.github+json', 'Authorization': 'Bearer '+token };
  if(body) headers['Content-Type']='application/json';
  const res = await fetch('https://api.github.com'+path, { method, headers, body: body?JSON.stringify(body):undefined });
  if(!res.ok){ const t=await res.text(); throw new Error(`GitHub ${res.status}: ${t}`); }
  return res.json();
}
async function cloudCreateGist(token, appState){
  const resp = await gistRequest('POST','/gists',{ public:false, files:{ 'proplugin-data.json':{ content: JSON.stringify(appState,null,2) } } }, token);
  localStorage.setItem(LS.GIST_ID, resp.id);
  localStorage.setItem(LS.TOKEN, token);
  return resp.id;
}
async function cloudSave(gistId, token){
  if(!gistId) throw new Error('Gist ID is required');
  const body = { files:{ 'proplugin-data.json':{ content: JSON.stringify(appData,null,2) } } };
  await gistRequest('PATCH','/gists/'+gistId, body, token);
}
async function cloudLoad(gistId, token){
  if (!gistId) throw new Error('Gist ID is required');
  const resp = await gistRequest('GET', '/gists/' + gistId, null, token);
  const file = resp.files?.['proplugin-data.json'];
  if (!file) throw new Error('proplugin-data.json not found in gist');
  const data = JSON.parse(file.content);
  appData = data;
  localStorage.setItem(LS.GIST_ID, gistId);
  localStorage.setItem(LS.TOKEN, token);
}

/* ================= AUTH ================= */
async function login(){
  const u=$('#loginUser').value.trim();
  const p=$('#loginPass').value;
  if (!appData || !appData.users) return alert('Application data is not loaded. Please set up cloud storage or refresh.');
  const pHash = await hashPassword(p);
  const found = appData.users.find(x=>x.username===u && x.passwordHash===pHash);
  if(!found) return alert('Invalid credentials');

  currentUser=found;
  columnFilters = {}; // Reset filters on new login
  $('#loginView').classList.add('hidden');
  $('#appView').classList.remove('hidden');
  $('#roleBadge').textContent=`${currentUser.role} ‚Ä¢ ${currentUser.username}`;
  
  bindAppEvents(); // Bind events for the main app view
  initFiltersForUser();
  updateLocalDataAndSave();
}
function logout(){
  currentUser=null;
  columnFilters = {}; // Reset filters on logout
  $('#appView').classList.add('hidden');
  $('#loginView').classList.remove('hidden');
  $('#loginPass').value = '';
  log('logout');
}

/* ================= FILTERS & COLUMN VISIBILITY ================= */
// ... (This section is unchanged from previous correct version)

/* ================= APPLY DEALER NAMES ================= */
// ... (This section is unchanged from previous correct version)

/* ================= TABLE & PAGINATION ================= */
// ... (This section is unchanged from previous correct version)

/* ================= EDITOR ================= */
// ... (This section is unchanged from previous correct version)

/* ================= SETTINGS (FULL & CORRECTED) ================= */
// ... (This section is unchanged from previous correct version)

/* ================= IMPORT / EXPORT ================= */
// ... (This section is unchanged from previous correct version)

/* ================= PRINT FLOW & OTHERS ================= */
// ... (This section is unchanged from previous correct version)

/* ================= NEW EXCEL FILTER LOGIC ================= */
// ... (This section is unchanged from previous correct version)

/* ================= EVENTS BINDING (NEW MODULAR & STABLE STRUCTURE) ================= */

// Bind events for views that are visible BEFORE login. Called once on startup.
function bindAuthEvents() {
    $('#btnCreateHost').onclick = async () => {
        const pass = $('#setupPass').value;
        if (pass !== $('#setupPassConfirm').value || !pass) return alert('Passwords do not match or are empty.');
        if (pass.length < 4) return alert('Password must be at least 4 characters long.');
        if (!appData) appData = JSON.parse(JSON.stringify(defaultAppState));
        appData.users = [{ username: 'host', passwordHash: await hashPassword(pass), role: 'Host', channels: [...Channels], canSeeCosts: true, canPrint: true }];
        const gistId = localStorage.getItem(LS.GIST_ID);
        const token = localStorage.getItem(LS.TOKEN);
        if(gistId && token) {
            try {
                await cloudSave(gistId, token);
                alert('Host account created and saved. Please log in.');
                $('#setupView').classList.add('hidden');
                $('#loginView').classList.remove('hidden');
            } catch (err) { alert('Failed to save host account: ' + err.message); }
        } else { alert('Error: Gist credentials not found.'); }
    };

    $('#btnLogin').onclick = login;
    $('#loginPass').onkeydown = (e) => { if (e.key === 'Enter') login(); };

    $('#btnCloudCreate').onclick = async () => {
        const token = $('#cloudToken').value.trim();
        if (!token) return alert('GitHub Token is required.');
        try {
            const gistId = await cloudCreateGist(token, defaultAppState);
            alert('Gist created: ' + gistId + '\nPlease create the host account.');
            appData = JSON.parse(JSON.stringify(defaultAppState));
            $('#cloudSetupView').classList.add('hidden');
            $('#setupView').classList.remove('hidden');
        } catch (err) { alert('Error creating Gist: ' + err.message); }
    };

    $('#btnCloudLoad').onclick = async () => {
        const token = $('#cloudToken').value.trim();
        const gistId = $('#cloudGistId').value.trim();
        if (!token || !gistId) return alert('Token and Gist ID are required.');
        try {
            await cloudLoad(gistId, token);
            alert('Loaded from Gist. Please log in.');
            $('#cloudSetupView').classList.add('hidden');
            $('#loginView').classList.remove('hidden');
        } catch (err) { alert('Error loading from Gist: ' + err.message); }
    };
}

// Bind events for the main application view. Called ONCE after successful login.
function bindAppEvents() {
    $('#btnLogout').onclick = logout;
    $('#btnNewProduct').onclick = () => openEditor();
    $('#btnSettings').onclick = () => openSettings('data');
    $('#btnPrintModal').onclick = () => {
        if (!currentUser || !currentUser.canPrint) return;
        buildPrintList();
        fillTemplateDropdown();
        renderPreview(filteredProducts()[0], (appData.templates||[])[0]);
        togglePrintModal(true);
    };

    $('#searchInput').oninput = () => { currentPage = 1; renderTable(); };
    $('#dateStart').onchange = () => { currentPage = 1; renderTable(); };
    $('#dateEnd').onchange = () => { currentPage = 1; renderTable(); };
    $('#channelSelect').onchange = () => { updateColumnVisibility(); currentPage = 1; renderTable(); };

    // Modals and Panels that are part of the main app view
    $('#btnCloseSettings').onclick = () => $('#settingsPanel').classList.add('hidden');
    $$('.set-tab').forEach(b => b.onclick = () => openSettings(b.dataset.tab));
    $('#btnCloseEditor').onclick = closeEditor;
    $('#btnSaveEd').onclick = saveEditor;
    $('#btnClosePrintModal').onclick = () => togglePrintModal(false);
    $('#btnOpenPrint').onclick = () => {
        const picks = $$('#printList input[type="checkbox"]:checked').map(c => c.dataset.sel);
        const list = picks.map(sku => ({ p: appData.products.find(p => p.sku === sku), qty: parseInt($(`[data-qty="${sku}"]`).value) || 1 })).filter(item => item.p);
        const tpl = appData.templates.find(t => t.id === $('#printTemplate').value) || appData.templates[0];
        openPrintTab(list, tpl);
    };
}

// Bind events for DYNAMIC content within the table. Called every time the table is re-rendered.
function bindTableEvents() {
    $$('button[data-edit]').forEach(b => b.onclick = () => openEditor(b.dataset.edit));
    $$('button[data-del]').forEach(b => b.onclick = () => {
        const sku = b.dataset.del;
        if (confirm(`Delete SKU ${sku}? This cannot be undone.`)) {
            appData.products = appData.products.filter(x => x.sku !== sku);
            log('delete_sku', sku);
            updateLocalDataAndSave();
        }
    });

    $$('.filter-btn').forEach(btn => {
        btn.onclick = () => openFilterDropdown(btn.dataset.filterKey);
    });
}

// Bind events for DYNAMIC content within the settings panel. Called every time a tab is rendered.
function bindSettingsEvents(tab) {
    if (tab === 'data' || tab === 'promo' || tab === 'logo' || tab === 'dealer' || tab === 'cloud') {
        // These are simple enough to be bound directly in renderSettings
    } 
    
    if (tab === 'users') {
        $('#btnAddUser').onclick = () => $('#addUserBox').classList.toggle('hidden');
        $('#nuCreate').onclick = async () => {
            const name = $('#nuName').value.trim();
            const pass = $('#nuPass').value.trim();
            if (!name || !pass) return alert('Username & password required');
            if ((appData.users || []).some(u => u.username === name)) return alert('Username already exists');
            const role = $('#nuRole').value;
            const canSee = $('#nuSeeCosts').checked;
            const canPrint = $('#nuCanPrint').checked;
            const chs = $$('.nuCh').filter(x => x.checked).map(x => x.value);
            if (!chs.length) return alert('Select at least one channel');
            appData.users.push({ username: name, passwordHash: await hashPassword(pass), role, channels: chs, canSeeCosts: canSee, canPrint });
            log('add_user', name);
            updateLocalDataAndSave();
            openSettings('users');
            alert('User created');
        };

        $$('button[data-saveu-idx]').forEach(b => {
            b.onclick = async (e) => {
                const i = +e.target.dataset.saveuIdx;
                const u = appData.users[i];
                if(!u) return;
                u.role = $(`select[data-role-idx="${i}"]`).value;
                u.canSeeCosts = $(`input[data-cost-idx="${i}"]`).checked;
                u.canPrint = $(`input[data-print-idx="${i}"]`).checked;
                const newPass = $(`input[data-pass-idx="${i}"]`).value.trim();
                if (newPass) { u.passwordHash = await hashPassword(newPass); }
                u.channels = Channels.filter(ch => $(`input[data-ch-idx="${i}|${ch}"]`).checked);
                if (currentUser.username === u.username) { currentUser = u; initFiltersForUser(); }
                log('update_user', u.username);
                updateLocalDataAndSave();
                alert('Saved.');
                openSettings('users');
            };
        });

        $$('button[data-delu-idx]').forEach(b => {
            b.onclick = (e) => {
                const i = +e.target.dataset.deluIdx;
                const u = appData.users[i];
                if(!u) return;
                if (u.username === 'host') return alert('Cannot delete host account.');
                if (confirm(`Delete user "${u.username}"?`)) {
                    appData.users.splice(i, 1);
                    log('delete_user', u.username);
                    updateLocalDataAndSave();
                    openSettings('users');
                }
            };
        });
    } 
    
    if (tab === 'templates') {
        $('#tplUploadNew').onchange = async (e) => {
          const f = e.target.files && e.target.files[0]; if(!f) return;
          const nm = prompt('Enter a name for this new template:'); if(!nm){ e.target.value=''; return; }
          try{
            const imageData = await fileToBase64(f);
            const id = 'user-' + Math.random().toString(36).slice(2,10);
            const base = defaultAppState.templates[2] || {styles:{}};
            appData.templates.push({
              id, name: nm, kind: 'IMAGE', imageData,
              showLogo: false, logoStyles: { size: 40, margin: 6 },
              styles: JSON.parse(JSON.stringify(base.styles||{}))
            });
            log('create_template_image', nm);
            updateLocalDataAndSave();
            openSettings('templates');
            alert('New template created.');
          }catch(err){ alert('Failed to create template: '+err.message); }
          e.target.value='';
        };
        $$('[data-savetpl-idx]').forEach(btn => {
            btn.onclick = () => {
                const i = +btn.dataset.savetplIdx;
                const t = appData.templates[i];
                if(!t) return;
                t.name = $(`[data-name-tpl="${i}"]`).value.trim() || 'Untitled Template';
                ['sku','description','details','price','oldPrice','expire'].forEach(k=>{
                    t.styles[k] = {
                        fs: parseInt($(`[data-fs-tpl="${i}|${k}"]`).value) || 14,
                        color: $(`[data-color-tpl="${i}|${k}"]`).value || '#ffffff',
                        mt: parseInt($(`[data-mt-tpl="${i}|${k}"]`).value) || 0,
                    };
                });
                t.showLogo = $(`[data-logo-tpl="${i}"]`).checked;
                t.logoStyles = {
                    size: parseInt($(`[data-logosize-tpl="${i}"]`).value) || 64,
                    margin: parseInt($(`[data-logomargin-tpl="${i}"]`).value) || 10,
                };
                log('save_template', t.name);
                updateLocalDataAndSave();
                alert('Template saved.');
            };
        });
        $$('[data-del-tpl]').forEach(btn => {
            btn.onclick = () => {
                const i = +btn.dataset.delTpl;
                const t = appData.templates[i];
                if(!t) return;
                if (confirm(`Delete template "${t.name}"?`)) {
                    appData.templates.splice(i, 1);
                    log('delete_template', t.name);
                    updateLocalDataAndSave();
                    openSettings('templates');
                }
            };
        });
        $$('[data-img-tpl]').forEach(input => {
            input.onchange = async (e) => {
                const i = +e.target.dataset.imgTpl;
                const file = e.target.files[0];
                if (!file) return;
                const t = appData.templates[i];
                if (!t) return;
                try {
                    t.imageData = await fileToBase64(file);
                    t.kind = t.kind || 'IMAGE';
                    log('update_template_image', t.name);
                    updateLocalDataAndSave();
                    openSettings('templates');
                } catch(err) { alert('Failed to update image: '+err.message); }
            };
        });
    }
}


/* ================= STARTUP LOGIC ================= */
async function initialCheck() {
    const gistId = localStorage.getItem(LS.GIST_ID);
    const token = localStorage.getItem(LS.TOKEN);
    if (gistId && token) {
        try {
            await cloudLoad(gistId, token);
            $('#cloudSetupView').classList.add('hidden');
            if (appData.users && appData.users.length > 0) {
                $('#loginView').classList.remove('hidden');
            } else {
                $('#setupView').classList.remove('hidden');
            }
        } catch(e) {
            localStorage.removeItem(LS.GIST_ID);
            localStorage.removeItem(LS.TOKEN);
            $('#cloudSetupView').classList.remove('hidden');
            alert("Cloud load failed, credentials cleared. Please set up again. Error: " + e.message);
        }
    } else {
        $('#cloudSetupView').classList.remove('hidden');
    }
}

function init() {
  bindAuthEvents();
  
  // Global listener for closing filter dropdowns
  document.addEventListener('click', (e) => {
      if (!e.target.closest('.filter-btn') && !e.target.closest('.filter-dropdown')) {
          closeAllFilterDropdowns();
      }
  });
  
  initialCheck();
}

init();
</script>

</body>
</html>
